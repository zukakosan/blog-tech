---
title: "[å€‹äººç”¨]Azure Route Serveræ¤œè¨¼æ™‚ã®ãƒ¡ãƒ¢"
emoji: "ğŸ“‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: false
---
# Azure Route Serverã¨ã¯
ARSã¯BGPã‚’å–‹ã‚Œã‚‹NVAãƒ”ã‚¢ã‚’å¼µã‚‹ã“ã¨ã§ã€NVAã‹ã‚‰ã®çµŒè·¯ã‚’å—ã‘å–ã£ã¦Azureå´ã®ãƒªã‚½ãƒ¼ã‚¹ã«çµŒè·¯ã‚’ä¼æ¬ã—ãŸã‚Šã€é€†ã«NVAã«ARSã«åºƒå ±ã•ã‚Œã¦ãã‚‹çµŒè·¯ã‚’åºƒå ±ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã€‚

![](/images/20230804-arstest/route-server-overview.png)

https://learn.microsoft.com/ja-jp/azure/route-server/overview

# NVA-ARSã®æ¤œè¨¼ç’°å¢ƒã®ç«‹ã¦æ–¹
å®Œæˆã™ã‚‹ç’°å¢ƒã®ã‚¤ãƒ¡ãƒ¼ã‚¸
![](/images/20230804-arstest/architecture.png)


## S2SVPNç’°å¢ƒã®ç”¨æ„
- BGPã‚’æœ‰åŠ¹åŒ–ã—ãŸS2SVPNç’°å¢ƒã‚’1ã¤ç”¨æ„ã—ã¦ãŠã
- ã“ã¡ã‚‰ã®Bicepã‚’å±•é–‹ã™ã‚Œã°30minãã‚‰ã„ã§ç’°å¢ƒãŒå‡ºæ¥ä¸ŠãŒã‚Š

https://github.com/zukakosan/bicep-s2svpn-bgp

- â†‘ã®è§£èª¬
https://zenn.dev/microsoft/articles/8d1558a8a2127c

## NVAç”¨UbuntuVMä½œæˆ
- å…ˆè¿°ã®S2Sç’°å¢ƒã®ã‚ªãƒ³ãƒ—ãƒ¬å´ã«1å°Ubuntu VMã‚’ä½œæˆ

## Azure Route Serverä½œæˆ
- Azure Route Serverã¯`RouteServerSubnet`ã¨ã„ã†å°‚ç”¨ã®ã‚µãƒ–ãƒãƒƒãƒˆãŒå¿…è¦ãªãŸã‚ã€ã‚ªãƒ³ãƒ—ãƒ¬å´VNETã«ã‚µãƒ–ãƒãƒƒãƒˆã‚’è¿½åŠ 
- ã“ã“ã§ã¯`10.200.2.0/24`ã¨ã™ã‚‹
- VPNGatewayã‚’Active/Activeã«ã—ãªã„ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã®ã§ã€VPNGatewayã®æ§‹æˆã‚’å¤‰æ›´ã—ã¦ãŠã
![](/images/20230804-arstest/02.png)

- ã¾ãŸã€ARSã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ãŸã‚‰[ãƒ–ãƒ©ãƒ³ãƒé–“]ã‚’[æœ‰åŠ¹]ã¨ã—ã¦ãŠã
![](/images/20230804-arstest/05.png)

:::message alert
## Local Network Gatewayã®è¨­å®šå¤‰æ›´ãŒå¿…è¦
- VPNGatewayã‚’Act/Stnã‹ã‚‰Act/Actã«å¤‰æ›´ã™ã‚‹ã¨BGPãƒ”ã‚¢IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒå¤‰æ›´ã•ã‚Œã‚‹
- ä»Šå›ã®ç’°å¢ƒã ã¨Act/Stnã ã¨x.x.x.254ã«ãªã£ã¦ã„ã‚‹ãŒã€Act/Actã«ã™ã‚‹ã¨x.x.x.4/x.x.x.5ã«ãªã‚‹
- Act/Stn
![](/images/20230804-arstest/03.png)
- Act/Act
![](/images/20230804-arstest/04.png)

ã¤ã¾ã‚Šã€ãƒ¢ãƒ¼ãƒ‰ã®å¤‰æ›´ã‚’ã™ã‚‹å ´åˆã¯éƒ½åº¦Local Network Gatewayã®BGPãƒ”ã‚¢IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å¤‰æ›´ã™ã‚‹å¿…è¦ãŒã‚ã‚‹

## Local Network Gatewayã¯2å€‹å¿…è¦ã‹ï¼Ÿ
- ä»Šå›ã¯ARSæ¤œè¨¼ç”¨é€”ãªã®ã§ã€Act/Actæ§‹æˆã§ã‚ã‚ã†ãŒç‰‡å´ã ã‘ä¸ŠãŒã£ã¦ã„ã‚Œã°å•é¡Œãªã„ã®ã§1ã¤ã§ã‚‚ã‚ˆã„
    - ARSã‚’åˆ©ç”¨ã™ã‚‹ã«ã‚ãŸã‚Šã‚„ã‚€ã‚’å¾—ãšAct/Actã«**ã•ã›ã‚‰ã‚Œã¦ã„ã‚‹**
- æ§‹æˆçš„ã«ç†æƒ³çš„ãªçŠ¶æ…‹ã§ã¯ãªã„ã“ã¨ã¯æ‰¿çŸ¥ã®ä¸Šã€‚æ‰‹é–“å„ªå…ˆã€‚
- å¯ç”¨æ€§ã‚’æ°—ã«ã™ã‚‹ãªã‚‰2å€‹ç”¨æ„ã™ã‚‹
:::


## NVAã¨ARSã®è¨­å®š
- ã“ã¡ã‚‰ã®è¨˜äº‹ã‚’å‚è€ƒã«NVAã‚’æ§‹æˆã™ã‚‹
- FRRoutingã¨ã„ã†ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§NVAã‚’æ§‹æˆã€‚Ciscoãƒ©ã‚¤ã‚¯ãªã‚³ãƒãƒ³ãƒ‰ã§è¨­å®šã§ãã‚‹ã€‚

https://zenn.dev/microsoft/articles/azure-route-server-frrouting#nva-%E3%81%AE%E4%BD%9C%E6%88%90

- `sudo vtysh`ã§Configã«å…¥ã‚Šã€ã‚ã¨ã¯ã‚‚ã‚ã‚‚ã‚è¨­å®šã™ã‚‹ã€‚
```
AzureAdmin@vm-ubuntu-onp-frr:~$ sudo vtysh

Hello, this is FRRouting (version 8.5.2).
Copyright 1996-2005 Kunihiro Ishiguro, et al.

vm-ubuntu-onp-frr#
```
- å…ˆè¿°ã®S2Sç’°å¢ƒã§ã¯ã“ã‚“ãªæ„Ÿã˜ã«ãªã‚‹ã¯ãšã€‚
```
ip route 10.100.2.0/24 10.100.1.1
!
router bgp 65001
 neighbor 10.100.2.4 remote-as 65515
 neighbor 10.100.2.4 ebgp-multihop 255
 neighbor 10.100.2.5 remote-as 65515
 neighbor 10.100.2.5 ebgp-multihop 255
 !
 address-family ipv4 unicast
  neighbor 10.100.2.4 soft-reconfiguration inbound
  neighbor 10.100.2.4 route-map rmap-bogon-asns in
  neighbor 10.100.2.4 route-map rmap-azure-asns out
  neighbor 10.100.2.5 soft-reconfiguration inbound
  neighbor 10.100.2.5 route-map rmap-bogon-asns in
  neighbor 10.100.2.5 route-map rmap-azure-asns out
 exit-address-family
exit
!
bgp as-path access-list azure-asns seq 5 permit _65515_
bgp as-path access-list bogon-asns seq 5 permit _0_
bgp as-path access-list bogon-asns seq 10 permit _23456_
bgp as-path access-list bogon-asns seq 15 permit _1310[0-6][0-9]_|_13107[0-1]_
bgp as-path access-list bogon-asns seq 20 deny _65515_
bgp as-path access-list bogon-asns seq 25 permit ^65
!
route-map rmap-bogon-asns deny 5
 match as-path bogon-asns
exit
!
route-map rmap-bogon-asns permit 10
exit
!
route-map rmap-azure-asns deny 5
 match as-path azure-asns
exit
!
route-map rmap-azure-asns permit 10
exit
!
```
## ARSå´ã§ãƒ”ã‚¢ã«NVAã‚’è¿½åŠ 
- Azure Portalã‹ã‚‰è¿½åŠ ã™ã‚‹
![](/images/20230804-arstest/01.png)

## BGPã®ç¢ºç«‹ã‚’ç¢ºèª
- `show ip bgp nei x.x.x.x`ã§`Established`ã‚’ç¢ºèª
```
vm-ubuntu-onp-frr# show ip bgp nei 10.100.2.4
BGP neighbor is 10.100.2.4, remote AS 65515, local AS 65001, external link
  Local Role: undefined
  Remote Role: undefined
  BGP version 4, remote router ID 10.100.2.4, local router ID 10.100.1.5
  BGP state = Established, up for 00:03:20
  Last read 00:00:50, Last write 00:00:20
  Hold time is 180 seconds, keepalive interval is 60 seconds
  Configured hold time is 180 seconds, keepalive interval is 60 seconds
  Configured conditional advertisements interval is 60 seconds
```

- ã‚µãƒãƒªãƒ¼ã‚‚ç¢ºèª
```
vm-ubuntu-onp-frr# show ip bgp sum

IPv4 Unicast Summary (VRF default):
BGP router identifier 10.100.1.5, local AS number 65001 vrf-id 0
BGP table version 2
RIB entries 1, using 192 bytes of memory
Peers 2, using 1449 KiB of memory

Neighbor        V         AS   MsgRcvd   MsgSent   TblVer  InQ OutQ  Up/Down State/PfxRcd   PfxSnt Desc
10.100.2.4      4      65515        17        53        0    0    0 00:12:59            1        0 N/A
10.100.2.5      4      65515        18        58        0    0    0 00:12:59            1        0 N/A

Total number of neighbors 2

```