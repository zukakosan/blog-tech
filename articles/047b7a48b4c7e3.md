---
title: "[個人用]Azure Route Server検証時のメモ"
emoji: "📑"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
---
# Azure Route Serverとは
ARSはBGPを喋れるNVAピアを張ることで、NVAからの経路を受け取ってAzure側のリソースに経路を伝搬したり、逆にNVAにARSに広報されてくる経路を広報することができるサービス。

![](/images/20230804-arstest/route-server-overview.png)

https://learn.microsoft.com/ja-jp/azure/route-server/overview

# NVA-ARSの検証環境の立て方
完成する環境のイメージ
![](/images/20230804-arstest/architecture.png)


## S2SVPN環境の用意
- BGPを有効化したS2SVPN環境を1つ用意しておく
- こちらのBicepを展開すれば30minくらいで環境が出来上がり

https://github.com/zukakosan/bicep-s2svpn-bgp

- ↑の解説
https://zenn.dev/microsoft/articles/8d1558a8a2127c

## NVA用UbuntuVM作成
- 先述のS2S環境のオンプレ側に1台Ubuntu VMを作成

## Azure Route Server作成
- Azure Route Serverは`RouteServerSubnet`という専用のサブネットが必要なため、オンプレ側VNETにサブネットを追加
- ここでは`10.200.2.0/24`とする
- VPNGatewayをActive/Activeにしないとエラーになるので、VPNGatewayの構成を変更しておく
![](/images/20230804-arstest/02.png)

- また、ARSのデプロイが完了したら[ブランチ間]を[有効]としておく
![](/images/20230804-arstest/05.png)

:::message alert
## Local Network Gatewayの設定変更が必要
- VPNGatewayをAct/StnからAct/Actに変更するとBGPピアIPアドレスが変更される
- 今回の環境だとAct/Stnだとx.x.x.254になっているが、Act/Actにするとx.x.x.4/x.x.x.5になる
- Act/Stn
![](/images/20230804-arstest/03.png)
- Act/Act
![](/images/20230804-arstest/04.png)

つまり、モードの変更をする場合は都度Local Network GatewayのBGPピアIPアドレスを変更する必要がある

## Local Network Gatewayは2個必要か？
- 今回はARS検証用途なので、Act/Act構成であろうが片側だけ上がっていれば問題ないので1つでもよい
    - ARSを利用するにあたりやむを得ずAct/Actに**させられている**
- 構成的に理想的な状態ではないことは承知の上。手間優先。
- 可用性を気にするなら2個用意する
:::


## NVAとARSの設定
- こちらの記事を参考にNVAを構成する
- FRRoutingというミドルウェアでNVAを構成。Ciscoライクなコマンドで設定できる。

https://zenn.dev/microsoft/articles/azure-route-server-frrouting#nva-%E3%81%AE%E4%BD%9C%E6%88%90

- `sudo vtysh`でConfigに入り、あとはもろもろ設定する。
```
AzureAdmin@vm-ubuntu-onp-frr:~$ sudo vtysh

Hello, this is FRRouting (version 8.5.2).
Copyright 1996-2005 Kunihiro Ishiguro, et al.

vm-ubuntu-onp-frr#
```
- 先述のS2S環境ではこんな感じになるはず。
```
ip route 10.100.2.0/24 10.100.1.1
!
router bgp 65001
 neighbor 10.100.2.4 remote-as 65515
 neighbor 10.100.2.4 ebgp-multihop 255
 neighbor 10.100.2.5 remote-as 65515
 neighbor 10.100.2.5 ebgp-multihop 255
 !
 address-family ipv4 unicast
  neighbor 10.100.2.4 soft-reconfiguration inbound
  neighbor 10.100.2.4 route-map rmap-bogon-asns in
  neighbor 10.100.2.4 route-map rmap-azure-asns out
  neighbor 10.100.2.5 soft-reconfiguration inbound
  neighbor 10.100.2.5 route-map rmap-bogon-asns in
  neighbor 10.100.2.5 route-map rmap-azure-asns out
 exit-address-family
exit
!
bgp as-path access-list azure-asns seq 5 permit _65515_
bgp as-path access-list bogon-asns seq 5 permit _0_
bgp as-path access-list bogon-asns seq 10 permit _23456_
bgp as-path access-list bogon-asns seq 15 permit _1310[0-6][0-9]_|_13107[0-1]_
bgp as-path access-list bogon-asns seq 20 deny _65515_
bgp as-path access-list bogon-asns seq 25 permit ^65
!
route-map rmap-bogon-asns deny 5
 match as-path bogon-asns
exit
!
route-map rmap-bogon-asns permit 10
exit
!
route-map rmap-azure-asns deny 5
 match as-path azure-asns
exit
!
route-map rmap-azure-asns permit 10
exit
!
```
## ARS側でピアにNVAを追加
- Azure Portalから追加する
![](/images/20230804-arstest/01.png)

## BGPの確立を確認
- `show ip bgp nei x.x.x.x`で`Established`を確認
```
vm-ubuntu-onp-frr# show ip bgp nei 10.100.2.4
BGP neighbor is 10.100.2.4, remote AS 65515, local AS 65001, external link
  Local Role: undefined
  Remote Role: undefined
  BGP version 4, remote router ID 10.100.2.4, local router ID 10.100.1.5
  BGP state = Established, up for 00:03:20
  Last read 00:00:50, Last write 00:00:20
  Hold time is 180 seconds, keepalive interval is 60 seconds
  Configured hold time is 180 seconds, keepalive interval is 60 seconds
  Configured conditional advertisements interval is 60 seconds
```

- サマリーも確認
```
vm-ubuntu-onp-frr# show ip bgp sum

IPv4 Unicast Summary (VRF default):
BGP router identifier 10.100.1.5, local AS number 65001 vrf-id 0
BGP table version 2
RIB entries 1, using 192 bytes of memory
Peers 2, using 1449 KiB of memory

Neighbor        V         AS   MsgRcvd   MsgSent   TblVer  InQ OutQ  Up/Down State/PfxRcd   PfxSnt Desc
10.100.2.4      4      65515        17        53        0    0    0 00:12:59            1        0 N/A
10.100.2.5      4      65515        18        58        0    0    0 00:12:59            1        0 N/A

Total number of neighbors 2

```