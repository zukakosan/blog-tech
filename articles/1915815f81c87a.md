---
title: "Azure VM上のHyper-VでホストするVM(Nested-VM)をAzure Arcに登録してみる"
emoji: "🦁"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
---
# モチベ
- 久々にAzure Arcを触っておきたい気分になった
- 手元のLaptop上にHyper-V立ててArcに登録するだけではイメージしやすいけど面白みがない
- AzureVM上のVM(Nested-VM＝入れ子になったVM)で構成してみると面白そうかも

ということで、

1. Azure VMにHyper-Vを入れ、
2. Nested VMを作成し、
3. Nested VMがインターネットアクセスできるように構成し、
4. Nested VMをAzure Arcに登録する

ということをやってみる。

# Azure VM上にNested VMの作成
## VMの作成
- Azure上に適当にWindows Serverマシンを立てる
- すべてのVMサイズでHyper-Vを有効化できるわけではなく、`_v3`以上のVMサイズを利用するのが無難

https://learn.microsoft.com/en-us/azure/virtual-machines/acu

- Hyper-Vの有効化
![](/images/20230822-nestedvmarc/01.png)

## Hyper-V上でNested VMの作成
- ローカル上ではあるが過去にも同様の作業をしているのでこちらの記事も参考に
https://zenn.dev/microsoft/articles/26ad363666c4cd

- Visual Studio特典を持っていればここから評価用ではないisoを落とすことが可能
    - https://my.visualstudio.com/Downloads/Featured?mkt=ja-jp
![](/images/20230822-nestedvmarc/02.png)

- (今回日本語版のisoを利用したが、手元のキーボードがUSキーボードだったためEnglish版の方がよかったかも)

# Nested VMのインターネットアクセス
- Azure Arcの利用を前提としているため、Nested VMからインターネットアクセスができるようにする必要がある
    - Azure Connected Machine Agentの通信のため
- よって以下の記事に倣って設定を進めていく

https://jpaztech1.z11.web.core.windows.net/NestedHyper-V%E3%81%AEVM%E3%81%8B%E3%82%89%E3%81%AE%E5%A4%96%E9%83%A8%E3%81%B8%E3%81%AE%E9%80%9A%E4%BF%A1%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6.html
