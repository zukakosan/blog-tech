---
title: "Azure VMä¸Šã®Hyper-Vã§ãƒ›ã‚¹ãƒˆã™ã‚‹VM(Nested-VM)ã‚’Azure Arcã«ç™»éŒ²ã—ã¦ã¿ã‚‹"
emoji: "ğŸ¦"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: false
---
# ãƒ¢ãƒãƒ™
- ä¹…ã€…ã«Azure Arcã‚’è§¦ã£ã¦ãŠããŸã„æ°—åˆ†ã«ãªã£ãŸ
- æ‰‹å…ƒã®Laptopä¸Šã«Hyper-Vç«‹ã¦ã¦Arcã«ç™»éŒ²ã™ã‚‹ã ã‘ã§ã¯ã‚¤ãƒ¡ãƒ¼ã‚¸ã—ã‚„ã™ã„ã‘ã©é¢ç™½ã¿ãŒãªã„
- AzureVMä¸Šã®VM(Nested-VMï¼å…¥ã‚Œå­ã«ãªã£ãŸVM)ã§æ§‹æˆã—ã¦ã¿ã‚‹ã¨é¢ç™½ãã†ã‹ã‚‚

ã¨ã„ã†ã“ã¨ã§ã€

1. Azure VMã«Hyper-Vã‚’å…¥ã‚Œã€
2. Nested VMã‚’ä½œæˆã—ã€
3. Nested VMãŒã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«æ§‹æˆã—ã€
4. Nested VMã‚’Azure Arcã«ç™»éŒ²ã™ã‚‹

ã¨ã„ã†ã“ã¨ã‚’ã‚„ã£ã¦ã¿ã‚‹ã€‚

# Azure VMä¸Šã«Nested VMã®ä½œæˆ
## VMã®ä½œæˆ
- Azureä¸Šã«é©å½“ã«Windows Serverãƒã‚·ãƒ³ã‚’ç«‹ã¦ã‚‹
- ã™ã¹ã¦ã®VMã‚µã‚¤ã‚ºã§Hyper-Vã‚’æœ‰åŠ¹åŒ–ã§ãã‚‹ã‚ã‘ã§ã¯ãªãã€`_v3`ä»¥ä¸Šã®VMã‚µã‚¤ã‚ºã‚’åˆ©ç”¨ã™ã‚‹ã®ãŒç„¡é›£

https://learn.microsoft.com/en-us/azure/virtual-machines/acu

- Hyper-Vã®æœ‰åŠ¹åŒ–
![](/images/20230822-nestedvmarc/01.png)

## Hyper-Vä¸Šã§Nested VMã®ä½œæˆ
- ãƒ­ãƒ¼ã‚«ãƒ«ä¸Šã§ã¯ã‚ã‚‹ãŒéå»ã«ã‚‚åŒæ§˜ã®ä½œæ¥­ã‚’ã—ã¦ã„ã‚‹ã®ã§ã“ã¡ã‚‰ã®è¨˜äº‹ã‚‚å‚è€ƒã«
https://zenn.dev/microsoft/articles/26ad363666c4cd

- Visual Studioç‰¹å…¸ã‚’æŒã£ã¦ã„ã‚Œã°ã“ã“ã‹ã‚‰è©•ä¾¡ç”¨ã§ã¯ãªã„isoã‚’è½ã¨ã™ã“ã¨ãŒå¯èƒ½
    - https://my.visualstudio.com/Downloads/Featured?mkt=ja-jp
![](/images/20230822-nestedvmarc/02.png)

- (ä»Šå›æ—¥æœ¬èªç‰ˆã®isoã‚’åˆ©ç”¨ã—ãŸãŒã€æ‰‹å…ƒã®ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãŒUSã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã ã£ãŸãŸã‚Englishç‰ˆã®æ–¹ãŒã‚ˆã‹ã£ãŸã‹ã‚‚)

# Nested VMã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹
- Azure Arcã®åˆ©ç”¨ã‚’å‰æã¨ã—ã¦ã„ã‚‹ãŸã‚ã€Nested VMã‹ã‚‰ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹ãŒã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
    - Azure Connected Machine Agentã®é€šä¿¡ã®ãŸã‚
- ã‚ˆã£ã¦ä»¥ä¸‹ã®è¨˜äº‹ã«å€£ã£ã¦è¨­å®šã‚’é€²ã‚ã¦ã„ã

https://jpaztech1.z11.web.core.windows.net/NestedHyper-V%E3%81%AEVM%E3%81%8B%E3%82%89%E3%81%AE%E5%A4%96%E9%83%A8%E3%81%B8%E3%81%AE%E9%80%9A%E4%BF%A1%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6.html

- ãƒ›ã‚¹ãƒˆOSã®Hyper-V Managerä¸Šã§[Virtual Switch Manager]ã‚’é–‹ã
![](/images/20230822-nestedvmarc/03.png)
- `Internal`ã§[Create Virtual Switch]
![](/images/20230822-nestedvmarc/04.png)
- é©å½“ã«åå‰ã‚’å¤‰æ›´ã€‚ã“ã“ã§ã¯`internal`ã¨ã„ã†åå‰ã‚’ä»˜ã‘ã¦ã„ã‚‹ã€‚
![](/images/20230822-nestedvmarc/05.png)
- Nested Hyper-V **ãƒ›ã‚¹ãƒˆ**å´ã§ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œ
```powershell
New-NetNat â€“Name myNAT â€“InternalIPInterfaceAddressPrefix "172.16.1.0/24"
Get-NetAdapter "vEthernet (internal)"| New-NetIPAddress -IPAddress 172.16.1.1 -AddressFamily IPv4 -PrefixLength 24
```
- "vEthernet (internal)"ãŒèªè­˜ã•ã‚Œã¦ã„ã‚‹ã‹ã©ã†ã‹ã¯`Get-NetAdapter`ã‚³ãƒãƒ³ãƒ‰ã«ã‚ˆã£ã¦ç¢ºèªã§ãã‚‹

```powershell
> Get-NetAdapter

Name                      InterfaceDescription                    ifIndex Status       MacAddress             LinkSpeed
----                      --------------------                    ------- ------       ----------             ---------
Ethernet                  Microsoft Hyper-V Network Adapter             5 Up           00-22-48-2D-AE-67        40 Gbps
vEthernet (New Virtual... Hyper-V Virtual Ethernet Adapter #2          18 Up           00-15-5D-00-04-02        10 Gbps
vEthernet (internal)      Hyper-V Virtual Ethernet Adapter             12 Up           00-15-5D-00-04-01        10 Gbps
```

- Hyper-V Managerã®[Settings]ã‹ã‚‰ä½œæˆã—ãŸã‚¹ã‚¤ãƒƒãƒã‚’ã‚¢ã‚¿ãƒƒãƒã™ã‚‹
![](/images/20230822-nestedvmarc/06.png)

- Nested VMã«ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦IPv4ã®è¨­å®šã‚’ã—ã¦ã„ã
![](/images/20230822-nestedvmarc/07.png)

:::message
Nested VMã«ãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹éš›ã«[CTRL]+[ALT]+[DEL]ã‚’æŠ¼ä¸‹ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã®ã ãŒã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆãŒå¼•ã£æ›ã‹ã£ã¦ã—ã¾ã„ã†ã¾ãæ©Ÿèƒ½ã—ãªã„ã€‚ãã®å ´åˆã¯ã€å·¦ä¸Šã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹ã™ã‚‹ã ã‘ã§ã‚ˆã„ã€‚

![](/images/20230822-nestedvmarc/09.png)

:::

- å°‘ã—å¾…ã¤ã¨ã€Nested VMã§ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆã‚¢ã‚¯ã‚»ã‚¹ãŒã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹
![](/images/20230822-nestedvmarc/08.png)
