---
title: "(GA)Azure ExpressRoute ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ ãƒ”ã‚¢ãƒªãƒ³ã‚°ã®ã‚«ã‚¹ã‚¿ãƒ  BGP ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚’æ§‹æˆã™ã‚‹"
emoji: "ğŸŒŒ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['Azure','ExpressRoute','BGP']
publication_name: "microsoft"
published: false
---
# ãƒ¢ãƒãƒ™
- ExpressRouteã®æ¤œè¨¼ãŒã§ãã‚‹ã¨ã„ã†ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ã¡ã‚‡ã†ã©ã‚ˆãä»¥ä¸‹ã®æ©Ÿèƒ½ãŒGA

https://azure.microsoft.com/ja-jp/updates/general-availability-expressroute-private-peering-support-for-bgp-communities/

https://learn.microsoft.com/ja-jp/azure/expressroute/how-to-configure-custom-bgp-communities

- ã¤ã¾ã‚‹ã¨ã“ã‚ã€Azureã®VNETæ¯ã«å€‹åˆ¥ã®BGPã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£å€¤(12076:"ã‚«ã‚¹ã‚¿ãƒ å€¤")ã‚’æµã™ã“ã¨ãŒã§ãã‚‹ã¨ã„ã†æ©Ÿèƒ½
    - ã‚ªãƒ³ãƒ—ãƒ¬å´ã§ãƒ«ãƒ¼ãƒˆãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’ã‹ã‘ã‚‹ã¨ãã«ã¡ã‚‡ã£ã¨ä¾¿åˆ©ã ã£ãŸã‚Šã€Prefixã‚ˆã‚Šãã£ã¡ã«æ…£ã‚Œã¦ã‚‹äººã‚‚ã„ã‚‹ã‚ˆã­ã£ã¦ã„ã†å¬‰ã—ã„ã‚ˆã­ã£ã¦æ„Ÿã˜
- ã“ã‚Œã¯è©¦ã™ã—ã‹ãªã„ã¨æ€ã„ã€ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã—ã¦ã¿ã‚‹

# ç’°å¢ƒæº–å‚™
- ExpressRouteã«ç¹‹ãŒã£ã¦ã„ã‚‹ä»¥ä¸‹ã®ã‚ˆã†ãªHub-Spokeç’°å¢ƒã‚’ç”¨æ„ã™ã‚‹

## Hubã®VNETã«å¯¾ã—ã¦BGPã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£å€¤ã‚’ã‚»ãƒƒãƒˆã™ã‚‹

- Azure CloudShellã§ä»¥ä¸‹ã‚’å…¥åŠ›ã™ã‚‹
```powershell
#ä»®æƒ³ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®å–å¾—
$virtualnetwork = @{
    Name = 'vnet-clab-hub-001'
    ResourceGroupName = '20230714-cloudlab'
} 
$vnet = Get-AzVirtualNetwork @virtualnetwork

#BGPã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã®è¨­å®š
$vnet.BgpCommunities = @{VirtualNetworkCommunity = '12076:49999'}
$vnet | Set-AzVirtualNetwork
```
ã“ã‚Œã§ã€12076:49999ãŒBGPã§10.0.0.0/16ã¨ä¸€ç·’ã«æµã‚Œã‚‹ã¯ãšã€‚

:::message
- ã‚«ã‚¹ã‚¿ãƒ ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£å€¤ã«é©å½“ãªå€¤ã‚’å…¥ã‚Œã‚‹ã¨æ€’ã‚‰ã‚Œã‚‹
![](/images/20230714-clabBgpCommunity/01.png)
- å…¥åŠ›ã§ãã‚‹ç¯„å›²ãŒ20000-49999ã®ç¯„å›²ã£ã½ã„ã®ã§ã€ä»Šå›ã¯49999ã‚’é¸æŠã—ãŸ
![](/images/20230714-clabBgpCommunity/03.png)

- (MSPeeringã§ä½¿ã†Communityå€¤ã¯20000æœªæº€or50000ä»¥ä¸Šã®æ•°å­—ãŒåˆ©ç”¨ã•ã‚Œã¦ã‚‹ã£ã½ã„)
![](/images/20230714-clabBgpCommunity/02.png)
:::

## ã‚ªãƒ³ãƒ—ãƒ¬å´ã‚¹ã‚¤ãƒƒãƒã®è¨­å®š

- Ciscoã®ã‚¹ã‚¤ãƒƒãƒä¸Šã§BGPã®æƒ…å ±ã‚’ç¢ºèª
```
Router#show ip bgp 10.0.0.0/16
BGP routing table entry for 10.0.0.0/16, version 9
Paths: (1 available, best #1, table default)
  Not advertised to any peer
  Refresh Epoch 1
  12076, (received & used)
    172.16.0.2 from 172.16.0.2 (172.16.0.2)
      Origin IGP, localpref 100, valid, external, best
      Community: 791462735 791462748
      rx pathid: 0, tx pathid: 0x0
```
- `Community: 791462735 791462748`ã«æ³¨ç›®
    - ã“ã‚Œã‚’2^16=65536ã§å‰²ã‚‹ã¨ASNãŒå‡ºã‚‹
    - 791462735/65536 = 12076.7629 =12076 = Microsoftã®ASç•ªå·
    - Mod(791462735) = 49999
    - ã¤ã¾ã‚Šã€`12076:49999`ã‚’è¡¨ã—ã¦ã„ã‚‹
- ä¸€æ–¹ã€`791462748`ã«ã¤ã„ã¦ã¯`12076:50012`ã¨æ›¸ãç›´ã™ã“ã¨ãŒã§ãã‚‹
    - ã“ã‚Œã¯ã€Azureã®æ±æ—¥æœ¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ”ã‚¢ãƒªãƒ³ã‚°ã‚’è¡¨ã™ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£å€¤ã«ãªã£ã¦ã„ã‚‹
    - https://learn.microsoft.com/ja-jp/azure/expressroute/expressroute-routing#bgp

ã¤ã¾ã‚Šã€ã“ã®Communityå€¤ã‚’è§£èª­ã™ã‚‹ã“ã¨ã§ã€ãã‚ŒãŒAzureã®æ±æ—¥æœ¬ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã‹ã‚‰Private Peeringã‚’é€šã—ã¦æµã‚Œã¦ãã¦ã„ã¦ã€ãã‚ŒãŒHubã®VNETã«é–¢ã™ã‚‹ã‚‚ã®ã§ã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚‹

:::message
ã“ã®ã¾ã¾ã§ã‚‚ä¸€å¿œã‚ã‹ã‚‹ã¨ã„ãˆã°ã‚ã‹ã‚‹ã®ã ãŒã€Ciscoã®è¨­å®šã‚’å¤‰ãˆã‚‹ã¨ä¸€èˆ¬çš„ãªãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«ç›´ã™ã“ã¨ãŒã§ãã‚‹
https://milestone-of-se.nesuke.com/nw-advanced/bgp/communities-extended-large-format/

```
Router(config)#ip bgp-community new-format

Router#show ip bgp 10.0.0.0/16
BGP routing table entry for 10.0.0.0/16, version 9
Paths: (1 available, best #1, table default)
  Not advertised to any peer
  Refresh Epoch 1
  12076, (received & used)
    172.16.0.2 from 172.16.0.2 (172.16.0.2)
      Origin IGP, localpref 100, valid, external, best
      Community: 12076:49999 12076:50012
      rx pathid: 0, tx pathid: 0x0
```
ã“ã†ã™ã‚‹ã¨ã€ã‚ã£ã¡ã‚ƒã‚ã‹ã‚Šã‚„ã™ã„!
:::

# ãŠã‚ã‚Š


