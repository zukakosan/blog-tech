---
title: "(GA)Azure ExpressRoute プライベート ピアリングのカスタム BGP コミュニティを構成する"
emoji: "🌌"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ['Azure','ExpressRoute','BGP']
publication_name: "microsoft"
published: false
---
# モチベ
- ExpressRouteの検証ができるというタイミングでちょうどよく以下の機能がGA

https://azure.microsoft.com/ja-jp/updates/general-availability-expressroute-private-peering-support-for-bgp-communities/

https://learn.microsoft.com/ja-jp/azure/expressroute/how-to-configure-custom-bgp-communities

- つまるところ、AzureのVNET毎に個別のBGPコミュニティ値(12076:"カスタム値")を流すことができるという機能
    - オンプレ側でルートフィルターをかけるときにちょっと便利だったり、Prefixよりそっちに慣れてる人もいるよねっていう嬉しいよねって感じ
- これは試すしかないと思い、チャレンジしてみる

# 環境準備
- ExpressRouteに繋がっている以下のようなHub-Spoke環境を用意する

## HubのVNETに対してBGPコミュニティ値をセットする

- Azure CloudShellで以下を入力する
```powershell
#仮想ネットワークの取得
$virtualnetwork = @{
    Name = 'vnet-clab-hub-001'
    ResourceGroupName = '20230714-cloudlab'
} 
$vnet = Get-AzVirtualNetwork @virtualnetwork

#BGPコミュニティの設定
$vnet.BgpCommunities = @{VirtualNetworkCommunity = '12076:49999'}
$vnet | Set-AzVirtualNetwork
```
これで、12076:49999がBGPで10.0.0.0/16と一緒に流れるはず。

:::message
- カスタムコミュニティ値に適当な値を入れると怒られる
![](/images/20230714-clabBgpCommunity/01.png)
- 入力できる範囲が20000-49999の範囲っぽいので、今回は49999を選択した
![](/images/20230714-clabBgpCommunity/03.png)

- (MSPeeringで使うCommunity値は20000未満or50000以上の数字が利用されてるっぽい)
![](/images/20230714-clabBgpCommunity/02.png)
:::

## オンプレ側スイッチの設定

- Ciscoのスイッチ上でBGPの情報を確認
```
Router#show ip bgp 10.0.0.0/16
BGP routing table entry for 10.0.0.0/16, version 9
Paths: (1 available, best #1, table default)
  Not advertised to any peer
  Refresh Epoch 1
  12076, (received & used)
    172.16.0.2 from 172.16.0.2 (172.16.0.2)
      Origin IGP, localpref 100, valid, external, best
      Community: 791462735 791462748
      rx pathid: 0, tx pathid: 0x0
```
- `Community: 791462735 791462748`に注目
    - これを2^16=65536で割るとASNが出る
    - 791462735/65536 = 12076.7629 =12076 = MicrosoftのAS番号
    - Mod(791462735) = 49999
    - つまり、`12076:49999`を表している
- 一方、`791462748`については`12076:50012`と書き直すことができる
    - これは、Azureの東日本リージョンのプライベートピアリングを表すコミュニティ値になっている
    - https://learn.microsoft.com/ja-jp/azure/expressroute/expressroute-routing#bgp

つまり、このCommunity値を解読することで、それがAzureの東日本リージョンからPrivate Peeringを通して流れてきていて、それがHubのVNETに関するものであることがわかる

:::message
このままでも一応わかるといえばわかるのだが、Ciscoの設定を変えると一般的なフォーマットに直すことができる
https://milestone-of-se.nesuke.com/nw-advanced/bgp/communities-extended-large-format/

```
Router(config)#ip bgp-community new-format

Router#show ip bgp 10.0.0.0/16
BGP routing table entry for 10.0.0.0/16, version 9
Paths: (1 available, best #1, table default)
  Not advertised to any peer
  Refresh Epoch 1
  12076, (received & used)
    172.16.0.2 from 172.16.0.2 (172.16.0.2)
      Origin IGP, localpref 100, valid, external, best
      Community: 12076:49999 12076:50012
      rx pathid: 0, tx pathid: 0x0
```
こうすると、めっちゃわかりやすい!
:::

# おわり


