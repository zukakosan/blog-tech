---
title: "Azure Export for Terraform ã§æ—¢å­˜ã® Azure ç’°å¢ƒã‚’ Terraform ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹"
emoji: "ğŸ“"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ['terraform','azure','iac','microsoft']
published: false
publication_name: "microsoft"
---

# ã¯ã˜ã‚ã«
Azure ã®æ—¢å­˜ãƒªã‚½ãƒ¼ã‚¹ã¯ã€[ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ] ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ ARM ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å½¢ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨è¨€ã„ã¤ã¤ãã®ã¾ã¾æµç”¨ã§ãã‚‹ã‚ã‘ã§ã¯ãªã„ã®ã§ã€è»¢ç”¨ã™ã‚‹å ´åˆã«ã¯ç·¨é›†ãŒå¿…è¦ãªã®ã§ã™ãŒã€ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆè‡ªä½“ã¯ã§ãã¾ã™ã€‚ãµã¨ã€Terraform ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ„ãƒ¼ãƒ«ã¯ãªã„ã®ã‹æ¢ã—ã¦ã„ãŸã‚‰ã€Azure Export for Terraform[^1] ã¨ã„ã†ãƒ„ãƒ¼ãƒ«ã‚’è¦‹ã¤ã‘ãŸã®ã§è©¦ã—ã¦ã¿ã¾ã™ã€‚
[^1]:https://learn.microsoft.com/ja-jp/azure/developer/terraform/azure-export-for-terraform/export-terraform-overview

# Azure Export for Terraform
ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ã“ã¡ã‚‰ã® GitHub ãƒªãƒã‚¸ãƒˆãƒª[^2] ã§å…¬é–‹ã•ã‚Œã¦ã„ã‚‹ã®ã§ã€ç’°å¢ƒã«åˆã‚ã›ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
[^2]:https://github.com/Azure/aztfexport/releases

## ä½¿ç”¨æ–¹æ³•
Terraform ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ç¯„å›²ã‚’ã€Œãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—/ãƒªã‚½ãƒ¼ã‚¹/ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ©ãƒ•ã®ã‚¯ã‚¨ãƒªçµæœã€ã‹ã‚‰é¸æŠã§ãã¾ã™ã€‚ã‚·ãƒ³ãƒ—ãƒ«ãªã®ã¯ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—å˜ä½ã§ã—ã‚‡ã†ã€‚ã“ã®å ´åˆã€æ¬¡ã®ã‚ˆã†ã«è¨˜è¿°ã—ã¾ã™ã€‚

# è‡ªå‰ã®ç’°å¢ƒã«é©ç”¨ã—ã¦ã¿ã‚‹
ãƒãƒ³ã‚ºã‚ªãƒ³ç”¨ã«ä½œã£ã¦ã„ãŸ VNet ã« VM ãŒã„ã‚‹ã ã‘ã®ã‚·ãƒ³ãƒ—ãƒ«ãªãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ãŒã‚ã£ãŸã®ã§ã€ãã®ãƒªã‚½ãƒ¼ã‚¹ã‚°ãƒ«ãƒ¼ãƒ—ã‹ã‚‰ Terraform ã‚’ä½œæˆã—ã¦ã¿ã¾ã™ã€‚
![](/images/20240412-aztfexp/rg.png)

ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå˜ä½ã§ Terraform ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒ initialize ã•ã‚Œã‚‹ã®ã§ã€å°‚ç”¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç”¨æ„ã—ã¦ãã“ã§å®Ÿè¡Œã—ã¾ã™ã€‚æ‰‹å…ƒã®ç’°å¢ƒã¯ Winodws ãªã®ã§ PowerShell ã‹ã‚‰å®Ÿè¡Œã—ã¾ã™ã€‚
```
aztfexport resource-group 202401-handson
```

ã“ã®ã‚ˆã†ãªå½¢ã§æŠ½å‡ºã•ã‚ŒãŸæƒ…å ±ãŒç¢ºèªã•ã‚Œã¾ã™ã€‚`w` ã‚­ãƒ¼æŠ¼ä¸‹ã«ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆã«é€²ã¿ã¾ã™ã€‚
```
   Microsoft Azure Export for Terraform

     20240401-handson

    10 items

  â”‚ ğŸ’¡/subscriptions/xxxx/resourceGroups/20240401-HANDSON/providers/Microsoft.Compute/v
  â”‚ azurerm_virtual_machine_extension.res-0

    ğŸ’¡/subscriptions/xxxx/resourceGroups/20240401-HANDSON/providers/Microsoft.Compute/vi
    azurerm_virtual_machine_extension.res-1

    ğŸ’¡/subscriptions/xxxx/resourceGroups/20240401-handson
    azurerm_resource_group.res-2

    ğŸ’¡/subscriptions/xxxx/resourceGroups/20240401-handson/providers/Microsoft.Compute/vi
    azurerm_windows_virtual_machine.res-3

    ğŸ’¡/subscriptions/xxxx/resourceGroups/20240401-handson/providers/Microsoft.Network/ne
    azurerm_network_interface.res-4

    ğŸ’¡/subscriptions/xxxx/resourceGroups/20240401-handson/providers/Microsoft.Network/ne
    azurerm_network_security_group.res-5



    â€¢â€¢

    â†‘/k up â€¢ â†“/j down â€¢ / filter â€¢ delete skip â€¢ e show error â€¢ r show recommendation â€¢ w import â€¢ s save â€¢ q

```

`w` æŠ¼ä¸‹å¾Œã€`Importing ~` ã¨ã„ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
```
   Microsoft Azure Export for Terraform

  â£»   Importing /subscriptions/xxxx/resourceGroups/20240401-HANDSON/providers/Microsoft.
```

ã—ã°ã‚‰ãå¾…ã¤ã¨ã€ãƒ­ãƒ¼ã‚«ãƒ«ã® Terraform ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å¯¾ã™ã‚‹ Azure ç’°å¢ƒã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒçµ‚äº†ã—ã¾ã™ã€‚
```
   Microsoft Azure Export for Terraform

  Terraform state and the config are generated at: C:<PATH_TO_WORKING_DIR>

  Press any key to quit
```

`code .` ã§ VSCode ã‚’é–‹ã„ã¦ä¸­èº«ã‚’ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ†å‰²ã•ã‚Œã¦ä½œæˆã•ã‚Œã¦ã„ã¾ã™ã€‚
![](/images/20240412-aztfexp/importedfile.png)

ã“ã®ã¾ã¾ plan ã‚’ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
```
$ terraform plan
â•·
â”‚ Error: "admin_password" has to fulfill 3 out of these 4 conditions: Has lower characters, Has upper characters, Has a digit, Has a special character other than "_", fullfiled only 2 conditions
â”‚ 
â”‚   with azurerm_windows_virtual_machine.res-3,
â”‚   on main.tf line 37, in resource "azurerm_windows_virtual_machine" "res-3":
â”‚   37:   admin_password                                         = "ignored-as-imported"
```
VM ã®ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ã‚»ã‚­ãƒ¥ã‚¢ãªæ–‡å­—åˆ—ã§ã‚ã‚‹ãŸã‚ã€Terraform å´ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã¦ãŠã‚‰ãšã€ä»®ç½®ãã®æ–‡å­—åˆ—(`ignored-as-imported`)ãŒå…¥ã£ã¦ã„ã¾ã—ãŸã€‚ãã—ã¦ã€ãã®æ–‡å­—åˆ—ãŒã€VM ã«è¨­å®šã§ãã‚‹ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®è¦ä»¶ã‚’æº€ãŸã—ã¦ã„ãªã‹ã£ãŸã‚ã‘ã§ã™ã­ã€‚ä¸€æ—¦ã‚¨ãƒ©ãƒ¼ã®è§£æ¶ˆã®ãŸã‚ã«ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ã¹ãŸæ›¸ãã§è¨­å®šã—ã¾ã™ã€‚

```hcl:main.tf
  # admin_password                                         = "ignored-as-imported"
  admin_password                                         = "AzureAdmin123!"
```

ã“ã®çŠ¶æ…‹ã§ plan ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ç¾åœ¨ã® Azure ç’°å¢ƒã¨å·®åˆ†ãŒãªã„çŠ¶æ…‹ã«ãªã‚Šã¾ã—ãŸã€‚ä¸€å¿œã“ã‚Œã§æ—¢å­˜ã® Azure ã‚¤ãƒ³ãƒ•ãƒ©ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã® Terraform ã‚³ãƒ¼ãƒ‰ã¨ã—ã¦è¡¨ç¾ã§ãã¦ã„ã‚‹çŠ¶æ…‹ã«ã¯ãªã£ãŸã‚ã‘ã§ã™ã­ã€‚

```
$ terraform plan
No changes. Your infrastructure matches the configuration.
```

ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ã¹ãŸæ›¸ããŒæ°—ã«ãªã‚‹ã®ã§ã€ä¸€æ—¦å¤‰æ•°ã¨ã—ã¦èª­ã¿è¾¼ã¾ã›ã‚‹å½¢ã«ã—ã¾ã—ãŸã€‚

```hcl:main.tf
  # admin_password                                         = "ignored-as-imported"
  admin_password = var.admin_password
```

```hcl:variables.tf
variable vm_admin_password {
	sensitive = true
}
```

ã“ã®çŠ¶æ…‹ã§å†åº¦ plan ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚å·®åˆ†ãŒã‚ã‚‹ã¨ã„ã‚ã‚Œã¾ã—ãŸã€‚ã¡ã‚ƒã‚“ã¨èª­ã‚“ã§ã„ãªã„ã®ã§ã™ãŒã€Microsoft Qï¼†A ã®ã“ã®ã‚ãŸã‚Š[^3] ãŒå‚è€ƒã«ãªã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚

[^3]:https://learn.microsoft.com/en-us/answers/questions/1433179/how-to-change-the-admin-password-of-a-vm-created-u

```
$ terraform plan
var.vm_admin_password
  Enter a value:
  ...
following symbols:
  ~ update in-place

Terraform will perform the following actions:

  # azurerm_windows_virtual_machine.res-3 will be updated in-place
  ~ resource "azurerm_windows_virtual_machine" "res-3" {
        id                                                     = "/subscriptions/xxxx/resourceGroups/20240401-handson/providers/Microsoft.Compute/virtualMachines/vm-module03"
        name                                                   = "vm-module03"
        tags                                                   = {}
        # (26 unchanged attributes hidden)

        # (2 unchanged blocks hidden)
    }

Plan: 0 to add, 1 to change, 0 to destroy.
```

ã¡ãªã¿ã«ã€.tfstate å´ã§ã¯ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯ã“ã®ã‚ˆã†ã«èªè­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚
```txt:terraform.tfstate
...(ç•¥)
 {
      "mode": "managed",
      "type": "azurerm_windows_virtual_machine",
      "name": "res-3",
      "provider": "provider[\"registry.terraform.io/hashicorp/azurerm\"]",
      "instances": [
        {
          "schema_version": 0,
          "attributes": {
            "additional_capabilities": [],
            "additional_unattend_content": [],
            "admin_password": "ignored-as-imported",
            "admin_username": "AzureAdmin",
...(ç•¥)
```

ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰éƒ¨åˆ†ã®æ›¸ãæ–¹ã®å½±éŸ¿ã‹ã¨æ€ã‚ã‚Œã‚‹ãŸã‚ãã®ã¾ã¾ apply ã—ã¾ã™ã€‚
```
$ terraform apply
Apply complete! Resources: 0 added, 1 changed, 0 destroyed.
```

apply å¾Œã‚‚ `.tfstate` å´ã® `admin_password` ã¯å¤‰æ›´ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ãã—ã¦ã€apply æ™‚ã«æ¸¡ã—ãŸ admin_password ã§ Azure VM ã«æ¥ç¶šã—ã«è¡Œã£ã¦ã‚‚ã¯ã˜ã‹ã‚Œã¾ã—ãŸã€‚Azure portal å´ã§ã® VM ä½œæˆæ™‚ã«æŒ‡å®šã—ãŸ admin_password ã§èªè¨¼ã™ã‚‹ã¨ãƒ­ã‚°ã‚¤ãƒ³ã§ãã¾ã—ãŸã€‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã®ãƒªã‚»ãƒƒãƒˆã¯ã€Azure portal ã§ã‚‚ç‰¹åˆ¥ãªãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¨ã—ã¦ç”¨æ„ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€å˜ã«ãƒªã‚½ãƒ¼ã‚¹ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§å¤‰æ›´ã™ã‚‹ã ã‘ã§ã¯ã€ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å¤‰æ›´ã§ããªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™(è¦ç¢ºèª)ã€‚



# ãŠã‚ã‚Šã«
