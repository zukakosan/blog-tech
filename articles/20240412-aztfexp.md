---
title: "Azure Export for Terraform で既存の Azure 環境を Terraform にエクスポートする"
emoji: "📝"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ['terraform','azure','iac','microsoft']
published: false
publication_name: "microsoft"
---

# はじめに
Azure の既存リソースは、[テンプレートのエクスポート] メニューから ARM テンプレートの形でダウンロードすることができます。テンプレートと言いつつそのまま流用できるわけではないので、転用する場合には編集が必要なのですが、エクスポート自体はできます。ふと、Terraform でエクスポートするツールはないのか探していたら、Azure Export for Terraform[^1] というツールを見つけたので試してみます。
[^1]:https://learn.microsoft.com/ja-jp/azure/developer/terraform/azure-export-for-terraform/export-terraform-overview

# Azure Export for Terraform
このツールはこちらの GitHub リポジトリ[^2] で公開されているので、環境に合わせてインストールします。
[^2]:https://github.com/Azure/aztfexport/releases

## 使用方法
Terraform コードとしてエクスポートする範囲を「リソースグループ/リソース/リソースグラフのクエリ結果」から選択できます。シンプルなのはリソースグループ単位でしょう。この場合、次のように記述します。

# 自前の環境に適用してみる
ハンズオン用に作っていた VNet に VM がいるだけのシンプルなリソースグループがあったので、そのリソースグループから Terraform を作成してみます。
![](/images/20240412-aztfexp/rg.png)

作業ディレクトリ単位で Terraform のプロジェクトが initialize されるので、専用のディレクトリを用意してそこで実行します。手元の環境は Winodws なので PowerShell から実行します。
```
aztfexport resource-group 202401-handson
```

このような形で抽出された情報が確認されます。`w` キー押下にてインポートに進みます。
```
   Microsoft Azure Export for Terraform

     20240401-handson

    10 items

  │ 💡/subscriptions/xxxx/resourceGroups/20240401-HANDSON/providers/Microsoft.Compute/v
  │ azurerm_virtual_machine_extension.res-0

    💡/subscriptions/xxxx/resourceGroups/20240401-HANDSON/providers/Microsoft.Compute/vi
    azurerm_virtual_machine_extension.res-1

    💡/subscriptions/xxxx/resourceGroups/20240401-handson
    azurerm_resource_group.res-2

    💡/subscriptions/xxxx/resourceGroups/20240401-handson/providers/Microsoft.Compute/vi
    azurerm_windows_virtual_machine.res-3

    💡/subscriptions/xxxx/resourceGroups/20240401-handson/providers/Microsoft.Network/ne
    azurerm_network_interface.res-4

    💡/subscriptions/xxxx/resourceGroups/20240401-handson/providers/Microsoft.Network/ne
    azurerm_network_security_group.res-5



    ••

    ↑/k up • ↓/j down • / filter • delete skip • e show error • r show recommendation • w import • s save • q

```

`w` 押下後、`Importing ~` というメッセージが表示されます。
```
   Microsoft Azure Export for Terraform

  ⣻   Importing /subscriptions/xxxx/resourceGroups/20240401-HANDSON/providers/Microsoft.
```

しばらく待つと、ローカルの Terraform プロジェクトに対する Azure 環境のインポートが終了します。
```
   Microsoft Azure Export for Terraform

  Terraform state and the config are generated at: C:<PATH_TO_WORKING_DIR>

  Press any key to quit
```

`code .` で VSCode を開いて中身を確認してみます。以下のようなファイルに分割されて作成されています。
![](/images/20240412-aztfexp/importedfile.png)

# おわりに
