---
title: "App Serviceè¨¼æ˜æ›¸ã‚’åˆ©ç”¨ã—ã¦Application Gatewayã®HTTPSãƒªã‚¹ãƒŠãƒ¼ã‚’æ§‹æˆã™ã‚‹"
emoji: "ğŸ£"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: false
---

# ãƒ¢ãƒãƒ™
- ã“ã®å‰ã®è¨˜äº‹ã§Application Gatewayã«HTTPSãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­ã‘ã¦Webã‚µã‚¤ãƒˆã‚’HTTPSã§å…¬é–‹ã™ã‚‹ã¨ã„ã†æ¤œè¨¼ã‚’ã—ãŸ
    - ãŸã ã€è‡ªå·±ç½²åè¨¼æ˜æ›¸ã‚’åˆ©ç”¨ã—ã¦ãŠã‚Šã‚ãã¾ã§æ¤œè¨¼ç”¨ã¨ã„ã†æ„Ÿã˜
- Azureã«ã¯App Serviceè¨¼æ˜æ›¸ã¨ã„ã†ã‚µãƒ¼ãƒ“ã‚¹ãŒã‚ã‚Šã€è¨¼æ˜æ›¸ã‚’ç™ºè¡Œã§ãã‚‹
- ä»Šå›ã¯ã“ã¡ã‚‰ã‚’åˆ©ç”¨ã—ã¦æ­£å¼ãªHTTPSåŒ–å¯¾å¿œã‚’ã—ã¦ã„ããŸã„

# App Service è¨¼æ˜æ›¸ã®ä½œæˆ
- Azure Portalã«ã¦ã€Œè¨¼æ˜æ›¸ã€ã¨æ¤œç´¢
![è¨¼æ˜æ›¸](/images/20230419-appserv-cert/01.png)

- ç”»é¢ã«å¾“ã£ã¦ä½œæˆ
- ä½œæˆå¾Œã€ãƒªã‚½ãƒ¼ã‚¹ã‚’é–‹ãã€Œè¨¼æ˜æ›¸ã®æ§‹æˆã€ã®æ‰‹é †ã«å¾“ã„åˆ©ç”¨æº–å‚™ã‚’ã—ã¦ã„ã
![](/images/20230419-appserv-cert/02.png)

## æ‰‹é †ï¼‘ï¼šæ ¼ç´
- è¨¼æ˜æ›¸ã‚’æ ¼ç´ã™ã‚‹Key VaultãŒå¿…è¦ã«ãªã‚‹ãŸã‚ã€æ–°è¦ä½œæˆã™ã‚‹ã‹æ—¢å­˜ã®ã‚‚ã®ã‚’é¸æŠã™ã‚‹ã€‚ä»Šå›ã¯ç”»é¢ã«å¾“ã£ã¦æ–°è¦ä½œæˆã™ã‚‹
![](/images/20230419-appserv-cert/03.png)
- æ‰‹é †ï¼‘ãŒå®Œäº†ã—ãŸã“ã¨ã‚’ç¢ºèªã—ã€æ‰‹é †ï¼’ã¸
![](/images/20230419-appserv-cert/04.png)

## æ‰‹é †ï¼’ï¼šãƒ‰ãƒ¡ã‚¤ãƒ³ã®æ¤œè¨¼
- App Serviceè¨¼æ˜æ›¸ã‚’ä½œæˆã™ã‚‹éš›ã«å…¥åŠ›ã—ãŸãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ãã¡ã‚“ã¨ä¿æœ‰ã—ã¦ã„ã‚‹ã‹ã®ç¢ºèª
- ã„ãã¤ã‹ç¢ºèªæ–¹æ³•ãŒã‚ã‚‹ãŸã‚ç’°å¢ƒã«é©ã—ãŸæ–¹æ³•ã‚’é¸æŠ
![](/images/20230419-appserv-cert/05.png)
- æ‰‹å…ƒã®ç’°å¢ƒã§ã¯App Serviceãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’Azureã‹ã‚‰è³¼å…¥ã—ã¦ã„ã‚‹ãŸã‚ã€ã€Œãƒ‰ãƒ¡ã‚¤ãƒ³ã®æ¤œè¨¼ã€ã‹ã‚‰ãã®ã¾ã¾æ¤œè¨¼ã§ã‘åˆ‡ã‚‹ã¯ãšã ãŒAzure Portalå´ã®ã‚¨ãƒ©ãƒ¼ãªã®ã‹ã†ã¾ãã„ã‹ãªã‹ã£ãŸãŸã‚ã€Œæ‰‹å‹•ã§æ¤œè¨¼ã€ã‚’å®Ÿæ–½
- ç‰¹å®šã®TXTãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’App Serviceãƒ‰ãƒ¡ã‚¤ãƒ³ã®ãƒ«ãƒ¼ãƒˆãƒ‰ãƒ¡ã‚¤ãƒ³ã«ç™»éŒ²ã™ã‚‹
- ç™»éŒ²ã—ã€æ•°åˆ†å¾…ã¤ã¨æ¤œè¨¼ãŒå®Œäº†ã™ã‚‹
![](/images/20230419-appserv-cert/06.png)
- æ‰‹é †ï¼’ãŒå®Œäº†ã—ãŸã“ã¨ã‚’ç¢ºèªã™ã‚‹
![](/images/20230419-appserv-cert/07.png)
- æ‰‹é †ï¼“ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¯ã€ä½œæˆã—ãŸè¨¼æ˜æ›¸ãŒåˆ©ç”¨ã•ã‚ŒãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§è‡ªå‹•çš„ã«ãƒã‚§ãƒƒã‚¯ã•ã‚Œã‚‹ãŸã‚ã€è¨¼æ˜æ›¸ãƒªã‚½ãƒ¼ã‚¹ä¸Šã§ã®æ“ä½œã¯ç‰¹ã«ä¸è¦

# Application Gatewayã¸ã®é–¢é€£ä»˜ã‘

ä¸Šè¨˜ã§ä½œæˆã—ãŸè¨¼æ˜æ›¸ã‚’é–¢é€£ä»˜ã‘ã¦ã„ã
- ~~å‰å›ä½œæˆã—ãŸApplication Gatewayãƒªã‚½ãƒ¼ã‚¹ã®ã€Œãƒªã‚¹ãƒŠãƒ¼ã€ã‹ã‚‰ã€ŒListener TLS certificatesã€ã‚’é–‹ã(ã“ã‚Œã¯æœ€è¿‘Previewã«ãªã£ãŸã€è¤‡æ•°ã®è¨¼æ˜æ›¸ç®¡ç†ã®ãŸã‚ã®ãƒ“ãƒ¥ãƒ¼)~~
![](/images/20230419-appserv-cert/08.png)

- ~~ã€Œè¨¼æ˜æ›¸ã‚’è¿½åŠ ã™ã‚‹ã€ã‹ã‚‰ã€Œã‚­ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠãƒ¼ã‹ã‚‰è¨¼æ˜æ›¸ã‚’å–å¾—ã™ã‚‹ã€ã‚’é¸æŠã—ã€å…ˆã»ã©ã®ã‚­ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠãƒ¼ã‚’é¸æŠ~~
- ~~ã“ã“ã§ã€ãƒãƒãƒ¼ã‚¸ãƒ‰IDã«å¯¾ã™ã‚‹æ¨©é™ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã—ã¾ã†ãŸã‚ã€Key Vaultãƒªã‚½ãƒ¼ã‚¹ä¸Šã®IAMè¨­å®šã‚’å¤‰æ›´ã—ã«è¡Œã~~
![](/images/20230419-appserv-cert/09.png)
- ~~è¨¼æ˜æ›¸ã®æ§‹æˆä¸­ã«ä½œæˆã—ãŸKey Vaultã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ãƒ¢ãƒ‡ãƒ«ãŒã€Œã‚³ãƒ³ãƒ†ãƒŠãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒãƒªã‚·ãƒ¼ã€ã¨ãªã£ã¦ã„ã‚‹ãŸã‚ã€RBACã§ã¯ãªãã€Œã‚¢ã‚¯ã‚»ã‚¹ãƒãƒªã‚·ãƒ¼ã€ã§åˆ¶å¾¡ã™ã‚‹~~
![](/images/20230419-appserv-cert/10.png)
- ~~ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¨è¨¼æ˜æ›¸ã®å–å¾—æ¨©é™ã‚’ãƒãƒãƒ¼ã‚¸ãƒ‰IDã«ä»˜ä¸~~

:::message
- ã“ã“ã¾ã§ã‚„ã£ã¦ã€Application Gatewayå´ã§å¯¾è±¡ã®è¨¼æ˜æ›¸ãŒå…¨ç„¶å‡ºç¾ã—ãªã„ãŸã‚ãŠã‹ã—ã„ã¨æ€ã„ã€è‰²ã€…ã¨è©¦ã—ã¦ã„ã‚‹ã†ã¡ã«App Serviceè¨¼æ˜æ›¸ã¨ã„ã†ã‚‚ã®è‡ªä½“ã®èªè­˜ãŒé–“é•ã£ã¦ã„ã‚‹ã“ã¨ã«æ°—ä»˜ã„ãŸ

- App Serviceè¨¼æ˜æ›¸ã¯Key Vaultã¨é€£æºã•ã›ã‚‹ã®ã§ãã®è¨¼æ˜æ›¸ã®å®Ÿä½“ãŒKey Vaultã«æ ¼ç´ã•ã‚Œã‚‹ã®ã‹ã¨æ€ã£ã¦ã„ãŸãŒã€ãã†ã§ã¯ãªã„

- è¨¼æ˜æ›¸ã®å®Ÿä½“ã¯åˆ©ç”¨ã™ã‚‹éš›ã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã‚‹ã€ã‚‚ã—ãã¯ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦åˆ©ç”¨ã™ã‚‹

- ãã®ãŸã‚ã€App Serviceè¨¼æ˜æ›¸ã‚’Key Vaultã¨é€£æºã•ã›ã‚‹ã¨ã€è¨¼æ˜æ›¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¿…è¦ãªã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ã¿ãŒç™ºè¡Œã•ã‚Œã‚‹

- Application Gatewayã§ã“ã®App Serviceè¨¼æ˜æ›¸ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ã€ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¦ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹ã¨ã„ã†æ‰‹é–“ãŒã‚ã£ãŸ(å ´åˆã«ã‚ˆã£ã¦ã¯ã“ã£ã¡ã®æ–¹ãŒåˆ†ã‹ã‚Šæ˜“ã„)ãŒã€Application Gateway v2ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ã“ã¨ãªãåˆ©ç”¨ã§ãã‚‹(ãŸã ã—ã€GUIéå¯¾å¿œ)

https://jpazpaas.github.io/blog/2020/09/23/how-to-export-appservice-certificate.html

:::

## æ°—ã‚’å–ã‚Šç›´ã—ã¦
ä¸‹è¨˜ã‚µãƒãƒ¼ãƒˆãƒ–ãƒ­ã‚°ã«è¨˜è¼‰ã®æ‰‹é †ã§ã€è¨¼æ˜æ›¸ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã›ãšApplication Gatewayã§åˆ©ç”¨ã™ã‚‹

- Application Gatewayç”¨ã®ãƒãƒãƒ¼ã‚¸ãƒ‰IDã‚’ä½œæˆ
![](/images/20230419-appserv-cert/14.png)
- ãƒãƒãƒ¼ã‚¸ãƒ‰IDã«Key Vaultã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒãƒªã‚·ãƒ¼ã‚’è¨­å®š
![](/images/20230419-appserv-cert/15.png)

ã“ã“ã‹ã‚‰ã¯Azure Portalã§ã§ããªã„æ“ä½œãŒå«ã¾ã‚Œã‚‹ãŸã‚Azure Cloud Shellã§å®Ÿè¡Œã™ã‚‹

- å¯¾è±¡Application Gatewayã®å–å¾—
```powershell
PS > $appgwname = 'appgw-tls-apache'
PS > $rgname = '20230414-appgw-TLS'       
PS > $appgw = Get-AzApplicationGateway -Name $appgwname -ResourceGroupName $rgname    
```
- ãƒãƒãƒ¼ã‚¸ãƒ‰IDã‚’Application Gatewayã¸å‰²ã‚Šå½“ã¦
``` powershell              
PS > $midname = 'mid-appgw-tls'                   
PS > $subscriptionId = '<place-holder>' 
PS > Set-AzApplicationGatewayIdentity -ApplicationGateway $appgw -UserAssignedIdentityId "/subscriptions/${subscriptionId}/resourceGroups/${rgname}/providers/Microsoft.ManagedIdentity/userAssignedIdentities/${midname}"
```
- Key Vaultå†…ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®å–å¾—
```powershell
PS > $secret = Get-AzKeyVaultSecret -VaultName "kv-cert-msext
" -Name "<place-holder>"
```

- Application Gatewayã«Key Vaultã«æ ¼ç´ã•ã‚ŒãŸApp Serviceè¨¼æ˜æ›¸ã‚’è¿½åŠ 
```powershell

PS > $secretId = $secret.Id.Replace($secret.Version, "") 
PS >Add-AzApplicationGatewaySslCertificate -KeyVaultSecretId $secretId -ApplicationGateway $appgw -Name $secret.Name

```
- ä»Šã¾ã§ã®å¤‰æ›´ã®é©ç”¨
```powershell
PS > Set-AzApplicationGateway -ApplicationGateway $appgw

```

## Application Gatewayå´
- ç¢ºã‹ã«è¨¼æ˜æ›¸ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹
![](/images/20230419-appserv-cert/16.png)

- ä»¥å‰ã®ãƒªã‚¹ãƒŠãƒ¼ã«é–¢é€£ä»˜ã‘ã¦ã„ã‚‹è¨¼æ˜æ›¸ã‚’å…¥ã‚Œæ›¿ãˆã‚‹
![](/images/20230419-appserv-cert/17.png)

## å®Ÿéš›ã«Application Gatewayã®ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¸ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ç¢ºèª

## ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã›ãšã«åˆ©ç”¨ã™ã‚‹ã“ã¨ã®ãƒ¡ãƒªãƒƒãƒˆ
- è¨¼æ˜æ›¸ã®æ›´æ–°ãŒä¸è¦ã«ãªã‚‹
> pplication Gateway ã¨ App Service è¨¼æ˜æ›¸ã‚’ç›´æ¥ç´ã¥ã‘ã‚‹ã“ã¨ã§ã€æ›´æ–°ã•ã‚ŒãŸ App Service è¨¼æ˜æ›¸ãŒ Key Vault ã«æ ¼ç´ã•ã‚Œã¦ã„ãŸå ´åˆã€Application Gateway ã«é–¢é€£ä»˜ã‘ã‚‰ã‚Œã¦ã„ã‚‹ App Service è¨¼æ˜æ›¸ã‚‚è‡ªå‹•çš„ã«æ›´æ–°ã•ã‚ŒãŸè¨¼æ˜æ›¸ã«ç½®ãæ›ãˆã‚‰ã‚Œã¾ã™ã€‚ ã“ã‚Œã¯ Application Gateway ãŒ 4 æ™‚é–“ã”ã¨ã« Key Vault ã‚’å‚ç…§ã—ã€Key Vault ã«æ ¼ç´ã•ã‚ŒãŸ App Service è¨¼æ˜æ›¸ã®æ›´æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—ã™ã‚‹ãŸã‚ã§ã™ã€‚

> ä¸€æ–¹ã§ Key Vault ã«æ ¼ç´ã•ã‚ŒãŸ App Service è¨¼æ˜æ›¸ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ãŸå¾Œã« Application Gateway ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ãŸå ´åˆã«ã¯ã€Key Vault ã«æ ¼ç´ã•ã‚ŒãŸ App Service è¨¼æ˜æ›¸ãŒæ›´æ–°ã•ã‚ŒãŸã¨ã—ã¦ã‚‚ã€Application Gateway ã® App Service è¨¼æ˜æ›¸ã¯è‡ªå‹•ã§æ›´æ–°ã•ã‚Œã¾ã›ã‚“ã€‚ ã“ã‚Œã¯ã€Key Vault ã‹ã‚‰ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚ŒãŸ App Service è¨¼æ˜æ›¸ã¯ Key Vault ã«æ ¼ç´ã•ã‚ŒãŸ App Service è¨¼æ˜æ›¸ã‚’ç›´æ¥å‚ç…§ã—ãªã„ãŸã‚ã§ã™ã€‚

https://jpazpaas.github.io/blog/2022/09/16/How-to-import-ASC-to-AppGW.html#application-gateway-%E3%81%AB%E3%81%8A%E3%81%84%E3%81%A6-app-service-%E8%A8%BC%E6%98%8E%E6%9B%B8%E3%81%AE%E6%9B%B4%E6%96%B0%E4%BD%9C%E6%A5%AD%E3%81%8C%E4%B8%8D%E8%A6%81%E3%81%A8%E3%81%AA%E3%82%8B%E7%90%86%E7%94%B1