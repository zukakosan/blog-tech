---
title: "オンプレHyper-Vから持ち込んだカスタムイメージで作成したVMの更新管理としてUpdate Management Centerを利用する"
emoji: "📘"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
---
# モチベ
- Update Management Centerは一般化されたAzure Compute Gallery(ACG)のカスタムイメージをサポートしている
- Azure MarketplaceからVMを作成してカスタムイメージをACGで管理し、そこから作成したVMであればUpdate Management Centerで管理できるということになる
- では、オンプレから移行したVMをSysprepしてACGに吐き出したらUpdate Management Centerは動くのか、という話

# Azure VMの更新管理
## Update Management Center(プレビュー)とは？

> Update Management センター (プレビュー) は新たに設計されたものであり、Azure Automation Update Management で必要とされる Azure Automation や Azure Monitor ログには依存していません。 Update Management センター (プレビュー) は、新機能を多く備えているほか、Azure Automation で利用できる元のバージョンよりも強化された機能も提供します。

https://learn.microsoft.com/ja-jp/azure/update-center/overview

拡張機能ベースの機能であり、初回の機能利用時にVMエージェントを経由して必要な拡張機能が自動でインストールされる。よって、有効化を意識しないゼロタッチオンボーディング可能。

## ACGのサポートマトリックス
|イメージ|現在サポートされているシナリオ|サポートされていないシナリオ|
|----|----|----|
|Azure Compute Gallery: 一般化されたイメージ|- オンデマンド評価<br>- オンデマンドパッチ適用<br>- 定期的な評価<br>- スケジュールされたパッチ適用|VM ゲストの自動パッチ適用|
|Azure Compute Gallery: 特殊化されたイメージ|- オンデマンド評価<br>- オンデマンドパッチ適用|- 定期的な評価<br>- スケジュールされたパッチ適用<br>- VMゲストの自動パッチ適用|
|Azure コンピューティング ギャラリー以外のイメージ (SIG 以外)|なし|- オンデマンド評価<br>- オンデマンドパッチ適用<br>- 定期的な評価<br>- スケジュールされたパッチ適用<br>- VMゲストの自動パッチ適用|

引用：https://learn.microsoft.com/ja-jp/azure/update-center/manage-updates-customized-images#limitations

# 実際に試してみる
## VHDを持ち込んだVMの一般化とACGへの吐き出し
- [前回](https://zenn.dev/microsoft/articles/26ad363666c4cd)オンプレHyper-Vから移行したVMにアクセスしてSysprepをかけていく
- コマンドを実行
```
cmd> rmdir /s /q C:\Windows\Panther
cmd> cd %windir%\system32\sysprep
cmd> sysprep.exe /oobe /generalize /mode:vm /shutdown
```
- Azure Portal上でVMのステータスが[停止済み]になる
![](/images/20230601-vhdimg-umc/01.png)
- Azure Cloud Shell上で[一般化]に変更
```powershell
ACS> Set-AzVm -ResourceGroupName $rgName -Name $vmName -Generalized
```
- 開始も再起動もできない状態となる
![](/images/20230601-vhdimg-umc/02.png)
- そのままキャプチャの手順に進む
![](/images/20230601-vhdimg-umc/03.png)
![](/images/20230601-vhdimg-umc/04.png)
![](/images/20230601-vhdimg-umc/05.png)
    - このまま[作成]と進むとVM自体は割り当て解除される(課金停止)


