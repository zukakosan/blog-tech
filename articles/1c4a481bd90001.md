---
title: "Azureã«ãŠã‘ã‚‹ã‚¯ãƒ­ã‚¹ãƒ—ãƒ¬ãƒŸã‚¹ã®åå‰è§£æ±º with IaaS DNSãƒ•ã‚©ãƒ¯ãƒ¼ãƒ€"
emoji: "ğŸŒ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Azure","DNS","IaaS","microsoft"]
published: true
publication_name: "microsoft"
---

# ãƒ¢ãƒãƒ™
- Azureã«ãŠã‘ã‚‹ã‚¯ãƒ­ã‚¹ãƒ—ãƒ¬ãƒŸã‚¹ã®åå‰è§£æ±ºã¯Azure CAFä¸Šã¯`Azure DNS Private Resolver`ã‚’ä½¿ãˆã¨ã„ã†ã®ãŒæ¨å¥¨ã«ãªã£ã¦ã„ã‚‹
- åŒã‚µãƒ¼ãƒ“ã‚¹ã¯æ¯”è¼ƒçš„æœ€è¿‘GAã—ãŸã‚‚ã®ã§ã‚ã‚Šã€IaaSã§ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ€ã‚’ç«‹ã¦ãŸã„å ´é¢ãŒçµæ§‹ã‚ã‚‹
- ã—ã‹ã—ã€(ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã®æŠ€è¡“ã®å»¶é•·ã«ã‚ã‚‹ãŸã‚ã‹)æ–‡çŒ®ãŒå°‘ãªã„
- æ”¹ã‚ã¦ä¸€é€šã‚Šã®æ¤œè¨¼ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ä¸Šã§ã‚„ã£ã¦ãŠããŸã„

### ãã‚‚ãã‚‚ä½•æ•…ã‚¯ãƒ­ã‚¹ãƒ—ãƒ¬ãƒŸã‚¹ã®åå‰è§£æ±ºã‚’æ¤œè¨ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã‹
- Azure DNSã‚’ãƒ›ã‚¹ãƒˆã—ã¦ã„ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ`168.63.129.10`ã¯Azureä¸Šã®ãƒªã‚½ãƒ¼ã‚¹ã‹ã‚‰ã—ã‹åˆ°é”ã§ããªã„ç‰¹æ®Šãªã‚‚ã®ã¨ãªã£ã¦ã„ã‚‹
    - ã“ã“ã§ã®Azure DNSã¯ã„ã‚ã‚†ã‚‹ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚µãƒ¼ãƒã§ã‚ã‚‹ã¨ã“ã‚ã®Azure DNSãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¾ãƒ¼ãƒ³ã¨ã¯ç•°ãªã‚Šã€DNSãƒªã‚¾ãƒ«ãƒã‚’æŒ‡ã™
- ã“ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯ç‰¹ã«ã€Private DNSã‚¾ãƒ¼ãƒ³ã‚’åˆ©ç”¨ã™ã‚‹éš›ã«ã¯åˆ‡ã£ã¦ã‚‚åˆ‡ã‚Œãªã„é–¢ä¿‚ã«ã‚ã‚Šã€Private DNSã‚¾ãƒ¼ãƒ³ã¸ã®å•ã„åˆã‚ã›ã«ã¯ã“ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’çµŒç”±ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
    - ã¤ã¾ã‚Šã€Private Endpointã‚’åˆ©ç”¨ã—ã‚ˆã†ã¨æ€ã†ã¨ç¢ºå®Ÿã«ã“ã®è©±ãŒå‡ºã¦ãã‚‹
    - ã—ã‹ã—ã€ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã‹ã‚‰ç›´æ¥ã“ã®ã‚¢ãƒ‰ãƒ¬ã‚¹ã«åˆ°é”ã§ããªã„ãŸã‚ã€Azureä¸Šã«ãã®DNSè¦æ±‚ã‚’ä»²ä»‹ã—ã¦ãã‚Œã‚‹å­˜åœ¨ãŒå¿…è¦

ã“ã‚“ãªæ„Ÿã˜ã§ã€ã‚¯ãƒ­ã‚¹ãƒ—ãƒ¬ãƒŸã‚¹ã®åå‰è§£æ±ºã¯ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ§‹æˆã¨å…±ã«æ¤œè¨ã•ã‚Œã‚‹ã€‚ä»Šå›ã¯Azureå´ã®ä»²ä»‹å½¹ã¨ã—ã¦ã€å¾“æ¥ã‹ã‚‰ç”¨ã„ã‚‰ã‚Œã‚‹IaaSã§ã®DNSãƒ•ã‚©ãƒ¯ãƒ¼ãƒ€ã‚’åˆ©ç”¨ã™ã‚‹å ´åˆã‚’æ¤œè¨ã™ã‚‹ã€‚

# ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
- åŸºæœ¬ã¯[ä¾‹ã®bicep](https://zenn.dev/microsoft/articles/8d1558a8a2127c)ã‹ã‚‰å±•é–‹
- ã‚ªãƒ³ãƒ—ãƒ¬å´ã«ã¯Active Directoryç”¨ã®Windows Serverã‚’è¿½åŠ 
- ã‚¯ãƒ©ã‚¦ãƒ‰å´ã«ã¯DNSãƒ•ã‚©ãƒ¯ãƒ¼ãƒ€ç”¨ã®Windows Serverã‚’è¿½åŠ 
- ã‚¯ãƒ©ã‚¦ãƒ‰å´ã«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŠã‚ˆã³å¯¾å¿œã™ã‚‹Private Endpoint/Private DNS Zoneã‚’ä½œæˆ
![](/images/20230502-dnsfwd/arch.png)

# æ§‹ç¯‰

## ã‚ªãƒ³ãƒ—ãƒ¬ADã®æ§‹ç¯‰
- ãƒ‰ãƒ¡ã‚¤ãƒ³åã¯é©å½“ã«`ad.zukako.com`ã«ã—ãŸ
- ã‚ªãƒ³ãƒ—ãƒ¬VNETã§ã¯DNSã‚µãƒ¼ãƒã‚’ã‚«ã‚¹ã‚¿ãƒ ã§ã“ã®ADã‚µãƒ¼ãƒã®IPã‚’æŒ‡å®š
- ã“ã‚Œã ã‘ã ã¨ã€å¤–éƒ¨ã¸ã®åå‰è§£æ±ºãŒã§ããªã„ã®ã§ãŸã‚ã‚ªãƒ³ãƒ—ãƒ¬å´ã®DNSè¨­å®šã¨ã—ã¦`8.8.8.8`ã‚’ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰å…ˆã«æŒ‡å®š
![](/images/20230502-dnsfwd/01.png)
- VMã‚’å†èµ·å‹•ã™ã‚‹

## ã‚¯ãƒ©ã‚¦ãƒ‰DNSãƒ•ã‚©ãƒ¯ãƒ¼ãƒ€ã®æ§‹ç¯‰
- ã“ã¡ã‚‰ã¯ADDSã§ã¯ãªãDNSã‚µãƒ¼ãƒ“ã‚¹ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹


## ã‚¯ãƒ©ã‚¦ãƒ‰DNSãƒ•ã‚©ãƒ¯ãƒ¼ãƒ€å´ã®è¨­å®š
- ã¾ãšã¯ãã¡ã‚“ã¨Private Endpointã®åå‰è§£æ±ºãŒã§ãã‚‹ã‹ç¢ºèª > å•é¡Œãªã•ãã†
```
$ nslookup dnsteststrg.blob.core.windows.net
Server:  UnKnown
Address:  168.63.129.16

Non-authoritative answer:
Name:    dnsteststrg.privatelink.blob.core.windows.net
Address:  10.0.1.6
Aliases:  dnsteststrg.blob.core.windows.net
```
- ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ€(ã“ã®ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ€VMãŒå®Ÿéš›ã«DNSè¦æ±‚ã‚’è»¢é€ã™ã‚‹å…ˆ)ã«AzureDNSã‚’è¿½åŠ ã™ã‚‹
    - ãã‚‚ãã‚‚ãã‚ŒãŒã—ãŸã„ãŒãŸã‚ã®ã‚µãƒ¼ãƒ
    ![](/images/20230502-dnsfwd/03.png)

## ã‚ªãƒ³ãƒ—ãƒ¬å´ã‹ã‚‰ã®åå‰è§£æ±ºã®æ¤œè¨¼
- ä½•ã‚‚è¨­å®šã—ã¦ã„ãªã„çŠ¶æ…‹ã ã¨ã€ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã«è§£æ±ºã•ã‚Œã‚‹ã“ã¨ç¢ºèªã™ã‚‹
```
$ nslookup dnsteststrg.blob.core.windows.net
Server:  UnKnown
Address:  ::1

Non-authoritative answer:
Name:    blob.tyo22prdstr09a.store.core.windows.net
Address:  20.60.172.132
Aliases:  dnsteststrg.blob.core.windows.net
          dnsteststrg.privatelink.blob.core.windows.net
```
- `nslookup`ã«ä½¿ç”¨ã™ã‚‹DNSã‚µãƒ¼ãƒã‚’ã‚¯ãƒ©ã‚¦ãƒ‰å´DNSãƒ•ã‚©ãƒ¯ãƒ¼ãƒ€ã«ã—ã¦ã¿ã‚‹ã¨ã€ã€ã€ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã«è§£æ±ºã•ã‚Œã‚‹
```
$ nslookup dnsteststrg.blob.core.windows.net 10.0.1.5
Server:  clouddnsfwd.internal.cloudapp.net
Address:  10.0.1.5

Non-authoritative answer:
Name:    dnsteststrg.privatelink.blob.core.windows.net
Address:  10.0.1.6
Aliases:  dnsteststrg.blob.core.windows.net
```

## ã‚ªãƒ³ãƒ—ãƒ¬ADå´ã«æ¡ä»¶ä»˜ããƒ•ã‚©ãƒ¯ãƒ¼ãƒ€ã¨ã—ã¦ã‚¯ãƒ©ã‚¦ãƒ‰å´DNSãƒ•ã‚©ãƒ¯ãƒ¼ãƒ€ã‚’è¿½åŠ 
- ã“ã®FQDNã«å¯¾ã™ã‚‹DNSè¦æ±‚ãŒAzureå´ã®DNSãƒ•ã‚©ãƒ¯ãƒ¼ãƒ€ã«é£›ã¶ã‚ˆã†ã«æ¡ä»¶ä»˜ããƒ•ã‚©ãƒ¯ãƒ¼ãƒ€ã‚’è¨­å®š
    - ç™»éŒ²ã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§[ï½˜]ãƒãƒ¼ã‚¯ãŒè¡¨ç¤ºã•ã‚Œã‚‹ãŒã€ã‚¯ãƒ©ã‚¦ãƒ‰å´ã®DNSãƒ•ã‚©ãƒ¯ãƒ¼ãƒ€ãŒå¤–éƒ¨ã®ã‚‚ã®ã§ã‚‚ãªãã€`ad.zukako.com`ãƒ‰ãƒ¡ã‚¤ãƒ³ã«ã‚‚å‚åŠ ã—ã¦ãŠã‚‰ãšåå‰è§£æ±ºãŒã§ããªã„ãŸã‚ãã®ã‚ˆã†ã«è¡¨ç¤ºã•ã‚Œã‚‹
    ![](/images/20230502-dnsfwd/02.png)

    - IPã‚¢ãƒ‰ãƒ¬ã‚¹ãŒç™»éŒ²ã§ãã‚Œã°OK
    ![](/images/20230502-dnsfwd/04.png)

- ã“ã®è¨­å®šã‚’ã™ã‚‹ã¨ã€æ˜ç¤ºçš„ã«DNSã‚µãƒ¼ãƒã‚’æŒ‡å®šã—ãªãã¦ã‚‚ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆã«è§£æ±ºã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚‹
```
$ nslookup dnsteststrg.privatelink.blob.core.windows.net
Server:  UnKnown
Address:  ::1

Non-authoritative answer:
Name:    dnsteststrg.privatelink.blob.core.windows.net
Address:  10.0.1.6
```

# Azure > ã‚ªãƒ³ãƒ—ãƒ¬ã¸ã®åå‰è§£æ±º
## ã‚¯ãƒ©ã‚¦ãƒ‰å´DNSãƒ•ã‚©ãƒ¯ãƒ¼ãƒ€ä¸Šã§æ¡ä»¶ä»˜ããƒ•ã‚©ãƒ¯ãƒ¼ãƒ€ã®è¨­å®š
- ã‚ªãƒ³ãƒ—ãƒ¬ãƒ‰ãƒ¡ã‚¤ãƒ³ã¯ã‚ªãƒ³ãƒ—ãƒ¬ADã§åå‰è§£æ±ºã™ã‚‹ã‚ˆã†ã«è¨­å®š
![](/images/20230502-dnsfwd/05.png)

- ã“ã‚Œã ã‘ã§ã¯ã€ã‚¯ãƒ©ã‚¦ãƒ‰å´ã®DNSã‚µãƒ¼ãƒã¯VNETã®æ—¢å®šã®è¨­å®šã§AzureDNSã‚’å‚ç…§ã—ã¦ã—ã¾ã†
```
$ nslookup onpad.ad.zukako.com
Server:  UnKnown
Address:  168.63.129.16

*** Unknown can't find onpad.ad.zukako.com: Non-existent domain
```
- è‡ªèº«ã‚’DNSã‚µãƒ¼ãƒã¨ã—ã¦å‚ç…§ã™ã‚‹ã‚ˆã†ã«å¤‰æ›´ã™ã‚‹
![](/images/20230502-dnsfwd/06.png)

## å‹•ä½œç¢ºèª
- ãã¡ã‚“ã¨ã‚ªãƒ³ãƒ—ãƒ¬å´ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚‚åå‰è§£æ±ºã§ãã¦ã„ã‚‹
```
$ nslookup onpad.ad.zukako.com
Server:  clouddnsfwd.internal.cloudapp.net
Address:  10.0.1.5

Non-authoritative answer:
Name:    onpad.ad.zukako.com
Address:  10.100.1.5
```
- Private Endpointã®åå‰è§£æ±ºã‚‚å•é¡Œãªã•ãã†
```
$ nslookup dnsteststrg.privatelink.blob.core.windows.net
Server:  clouddnsfwd.internal.cloudapp.net
Address:  10.0.1.5

Non-authoritative answer:
Name:    dnsteststrg.privatelink.blob.core.windows.net
Address:  10.0.1.6
```

# ãŠã‚ã‚Š
- ã‚¯ãƒ­ã‚¹ãƒ—ãƒ¬ãƒŸã‚¹ã®åå‰è§£æ±ºã«ã¯Azure DNS Private ResolverãŒæ¨å¥¨ã•ã‚Œã¦ã„ã‚‹ãŒã€åŒæ–¹å‘ã®åå‰è§£æ±ºã‚‚Azure IaaSã§æ§‹ç¯‰ã§ãã‚‹ã“ã¨ã¯ç¢ºèªã§ããŸ
- Azureä¸Šã®VMç¾¤ã¯ã™ã¹ã¦DNSãƒ•ã‚©ãƒ¯ãƒ¼ãƒ€ã‚’å‚ç…§ã—ã¦ã€ã‚ªãƒ³ãƒ—ãƒ¬ãƒ‰ãƒ¡ã‚¤ãƒ³ã«ã¤ã„ã¦ã¯ã‚ªãƒ³ãƒ—ãƒ¬ADã«ã€Private Endpointã«ã¤ã„ã¦ã¯Azure DNSã«ã€ã¿ãŸã„ãªã“ã¨ã¯æ™®é€šã«ã§ããã†
- å ´åˆã«ã‚ˆã£ã¦ã¯ã€ã€Œã‚¯ãƒ©ã‚¦ãƒ‰å´VNETã¯DNSã‚µãƒ¼ãƒã‚’ã‚«ã‚¹ã‚¿ãƒ IPã§ã™ã¹ã¦ã‚ªãƒ³ãƒ—ãƒ¬ADã‚’å‘ã‘ã‚‹ã€ã‹ã¤ã€ŒAzureDNSãŒå¿…è¦ãªãƒ‰ãƒ¡ã‚¤ãƒ³ã«ã¤ã„ã¦ã¯Azureãƒ•ã‚©ãƒ¯ãƒ¼ãƒ€VMã¸æŠ•ã’ã‚‹ã€ã“ã¨ã‚‚è€ƒãˆã‚‰ã‚Œãã†
    - ãã®å ´åˆã¯ã€NICãƒ¬ãƒ™ãƒ«ã®DNSã‚µãƒ¼ãƒè¨­å®šã§ã€Azureãƒ•ã‚©ãƒ¯ãƒ¼ãƒ€VMã ã‘ã¯è‡ªèº«ã‚’å‘ãã‚ˆã†ã«è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹