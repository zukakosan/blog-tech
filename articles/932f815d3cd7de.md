---
title: "Azure Storage Account のアクセス権について考えてみる"
emoji: "😎"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Azure","PaaS","authorization"]
published: false
---
# これは何...?
[ストレージBLOB共同作成者]ロールを付与していないのにBLOBストレージの管理ができていることを不思議に思ったことはないでしょうか。[共同作成者]ロールを付けたりしながら管理をしていると、自分は何でもできるんだと思って当たり前に感じることかもしれないですが、実はそうでもありません。このあたりの、Azure Storage Accountの権限周りを再考していて、わかりづらいところがあったので簡単にまとめておきます。

# コントロールプレーン操作とデータプレーン操作
そもそもAzure含めクラウドサービス上における操作は、コントロールプレーンとデータプレーンという2種類のカテゴリに分けることが可能です。コントロール=制御なので、コントロールプレーン操作はサブスクリプション内のリソースを管理するために使用します。データプレーン操作はリソースインスタンスによって提供される機能の利用に使用します。たとえば、

> コントロール プレーンを使って Azure Cosmos DB データベースを作成します。 Azure Cosmos DB データベースのデータに対してクエリを実行するには、データ プレーンを使います。

これらはそれぞれの操作において利用するエンドポイントの違いにも現れており、コントロールプレーン操作は Azure Resource Manager のエンドポイント(`https://management.azure.com`)に送信されるのに対し、データプレーン操作はインスタンス固有のエンドポイントに対して送信されます。

これらの操作の違いは、RBACロール定義上におけるActionsとDataActionsといった違いとして現れてきます。

# ストレージアカウントのアクセス権を考える

例えばタイトルのようにBLOBの管理をしたいと思った場合、これはデータプレーンの操作になるため、DataActionを必要とします。しかし、改めて[共同作成者]ロールを見てみると、以下のように`dataActions`は何も入っていません。
```json
{
    "id": "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c",
    "properties": {
        "roleName": "Contributor",
        "description": "Grants full access to manage all resources, but does not allow you to assign roles in Azure RBAC, manage assignments in Azure Blueprints, or share image galleries.",
        "assignableScopes": [
            "/"
        ],
        "permissions": [
            {
                "actions": [
                    "*"
                ],
                "notActions": [
                    "Microsoft.Authorization/*/Delete",
                    "Microsoft.Authorization/*/Write",
                    "Microsoft.Authorization/elevateAccess/Action",
                    "Microsoft.Blueprint/blueprintAssignments/write",
                    "Microsoft.Blueprint/blueprintAssignments/delete",
                    "Microsoft.Compute/galleries/share/action",
                    "Microsoft.Purview/consents/write",
                    "Microsoft.Purview/consents/delete"
                ],
                "dataActions": [],
                "notDataActions": []
            }
        ]
    }
}
```

一方で、BLOBの管理をしたいとなった場合に本来付けられるであろう[ストレージBLOB共同作成者]のロール定義は以下のようになっています。`dataActions`の部分に、BLOBに対する操作のアクションが存在します。
```json
{
    "id": "/providers/Microsoft.Authorization/roleDefinitions/ba92f5b4-2d11-453d-a403-e96b0029c9fe",
    "properties": {
        "roleName": "Storage Blob Data Contributor",
        "description": "Allows for read, write and delete access to Azure Storage blob containers and data",
        "assignableScopes": [
            "/"
        ],
        "permissions": [
            {
                "actions": [
                    "Microsoft.Storage/storageAccounts/blobServices/containers/delete",
                    "Microsoft.Storage/storageAccounts/blobServices/containers/read",
                    "Microsoft.Storage/storageAccounts/blobServices/containers/write",
                    "Microsoft.Storage/storageAccounts/blobServices/generateUserDelegationKey/action"
                ],
                "notActions": [],
                "dataActions": [
                    "Microsoft.Storage/storageAccounts/blobServices/containers/blobs/delete",
                    "Microsoft.Storage/storageAccounts/blobServices/containers/blobs/read",
                    "Microsoft.Storage/storageAccounts/blobServices/containers/blobs/write",
                    "Microsoft.Storage/storageAccounts/blobServices/containers/blobs/move/action",
                    "Microsoft.Storage/storageAccounts/blobServices/containers/blobs/add/action"
                ],
                "notDataActions": []
            }
        ]
    }
}
```