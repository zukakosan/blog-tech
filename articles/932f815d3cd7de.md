---
title: "Azure ã§ã® BLOB ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©(Action)ã‚’å†è€ƒã™ã‚‹"
emoji: "ğŸ“¦"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Azure","PaaS","microsoft"]
published: true
publication_name: "microsoft"
---
# ã“ã‚Œã¯ä½•...?
[ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸BLOBå…±åŒä½œæˆè€…]ãƒ­ãƒ¼ãƒ«ã‚’ä»˜ä¸ã—ã¦ã„ãªã„ã®ã« BLOB ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ç®¡ç†ãŒã§ãã¦ã„ã‚‹ã“ã¨ã‚’ä¸æ€è­°ã«æ€ã£ãŸã“ã¨ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚[å…±åŒä½œæˆè€…]ãƒ­ãƒ¼ãƒ«ã‚’ä»˜ã‘ãŸã‚Šã—ãªãŒã‚‰ç®¡ç†ã‚’ã—ã¦ã„ã‚‹ã¨ã€è‡ªåˆ†ã¯ä½•ã§ã‚‚ã§ãã‚‹ã‚“ã ã¨æ€ã£ã¦å½“ãŸã‚Šå‰ã«æ„Ÿã˜ã‚‹ã“ã¨ã‹ã‚‚ã—ã‚Œãªã„ã§ã™ãŒã€å®Ÿã¯ãã†ã§ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚ã“ã®ã‚ãŸã‚Šã®ã€Azure Storage Account ã®æ¨©é™å‘¨ã‚Šã‚’å†è€ƒã—ã¦ã„ã¦ã€ã‚ã‹ã‚Šã¥ã‚‰ã„ã¨ã“ã‚ãŒã‚ã£ãŸã®ã§ç°¡å˜ã«ã¾ã¨ã‚ã¦ãŠãã¾ã™ã€‚

# ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³æ“ä½œã¨ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ¼ãƒ³æ“ä½œ
ãã‚‚ãã‚‚ Azure å«ã‚ã‚¯ãƒ©ã‚¦ãƒ‰ã‚µãƒ¼ãƒ“ã‚¹ä¸Šã«ãŠã‘ã‚‹æ“ä½œã¯ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ã¨ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ¼ãƒ³ã¨ã„ã†2ç¨®é¡ã®ã‚«ãƒ†ã‚´ãƒªã«åˆ†ã‘ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«=åˆ¶å¾¡ãªã®ã§ã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³æ“ä½œã¯ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å†…ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’ç®¡ç†ã™ã‚‹ãŸã‚ã«ä½¿ç”¨ã—ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ¼ãƒ³æ“ä½œã¯ãƒªã‚½ãƒ¼ã‚¹ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«ã‚ˆã£ã¦æä¾›ã•ã‚Œã‚‹æ©Ÿèƒ½ã®åˆ©ç”¨ã«ä½¿ç”¨ã—ã¾ã™ã€‚ãŸã¨ãˆã°ã€

> ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« ãƒ—ãƒ¬ãƒ¼ãƒ³ã‚’ä½¿ã£ã¦ Azure Cosmos DB ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã—ã¾ã™ã€‚ Azure Cosmos DB ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€ãƒ‡ãƒ¼ã‚¿ ãƒ—ãƒ¬ãƒ¼ãƒ³ã‚’ä½¿ã„ã¾ã™ã€‚

ã“ã‚Œã‚‰ã¯ãã‚Œãã‚Œã®æ“ä½œã«ãŠã„ã¦åˆ©ç”¨ã™ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®é•ã„ã«ã‚‚ç¾ã‚Œã¦ãŠã‚Šã€ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³æ“ä½œã¯ Azure Resource Manager ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ(`https://management.azure.com`)ã«é€ä¿¡ã•ã‚Œã‚‹ã®ã«å¯¾ã—ã€ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ¼ãƒ³æ“ä½œã¯ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å›ºæœ‰ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«å¯¾ã—ã¦é€ä¿¡ã•ã‚Œã¾ã™ã€‚

ã“ã‚Œã‚‰ã®æ“ä½œã®é•ã„ã¯ã€RBAC ãƒ­ãƒ¼ãƒ«å®šç¾©ä¸Šã«ãŠã‘ã‚‹ Actions ã¨ DataActions ã¨ã„ã£ãŸé•ã„ã¨ã—ã¦ç¾ã‚Œã¦ãã¾ã™ã€‚

# ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’è€ƒãˆã‚‹

ä¾‹ãˆã°ã‚¿ã‚¤ãƒˆãƒ«ã®ã‚ˆã†ã« BLOB ã®ç®¡ç†ã‚’ã—ãŸã„ã¨æ€ã£ãŸå ´åˆã€ã“ã‚Œã¯ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ¼ãƒ³ã®æ“ä½œã«ãªã‚‹ãŸã‚ã€DataAction ã‚’å¿…è¦ã¨ã—ã¾ã™ã€‚ã—ã‹ã—ã€æ”¹ã‚ã¦[å…±åŒä½œæˆè€…]ãƒ­ãƒ¼ãƒ«ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ã«`dataActions`ã¯ä½•ã‚‚å…¥ã£ã¦ã„ã¾ã›ã‚“ã€‚
```json
{
    "id": "/providers/Microsoft.Authorization/roleDefinitions/b24988ac-6180-42a0-ab88-20f7382dd24c",
    "properties": {
        "roleName": "Contributor",
        "description": "Grants full access to manage all resources, but does not allow you to assign roles in Azure RBAC, manage assignments in Azure Blueprints, or share image galleries.",
        "assignableScopes": [
            "/"
        ],
        "permissions": [
            {
                "actions": [
                    "*"
                ],
                "notActions": [
                    "Microsoft.Authorization/*/Delete",
                    "Microsoft.Authorization/*/Write",
                    "Microsoft.Authorization/elevateAccess/Action",
                    "Microsoft.Blueprint/blueprintAssignments/write",
                    "Microsoft.Blueprint/blueprintAssignments/delete",
                    "Microsoft.Compute/galleries/share/action",
                    "Microsoft.Purview/consents/write",
                    "Microsoft.Purview/consents/delete"
                ],
                "dataActions": [],
                "notDataActions": []
            }
        ]
    }
}
```

ä¸€æ–¹ã§ã€BLOB ã®ç®¡ç†ã‚’ã—ãŸã„ã¨ãªã£ãŸå ´åˆã«æœ¬æ¥ä»˜ã‘ã‚‰ã‚Œã‚‹ã§ã‚ã‚ã†[ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸BLOBå…±åŒä½œæˆè€…]ã®ãƒ­ãƒ¼ãƒ«å®šç¾©ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚`dataActions`ã®éƒ¨åˆ†ã«ã€BLOB ã«å¯¾ã™ã‚‹æ“ä½œã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã—ã¾ã™ã€‚
```json
{
    "id": "/providers/Microsoft.Authorization/roleDefinitions/ba92f5b4-2d11-453d-a403-e96b0029c9fe",
    "properties": {
        "roleName": "Storage Blob Data Contributor",
        "description": "Allows for read, write and delete access to Azure Storage blob containers and data",
        "assignableScopes": [
            "/"
        ],
        "permissions": [
            {
                "actions": [
                    "Microsoft.Storage/storageAccounts/blobServices/containers/delete",
                    "Microsoft.Storage/storageAccounts/blobServices/containers/read",
                    "Microsoft.Storage/storageAccounts/blobServices/containers/write",
                    "Microsoft.Storage/storageAccounts/blobServices/generateUserDelegationKey/action"
                ],
                "notActions": [],
                "dataActions": [
                    "Microsoft.Storage/storageAccounts/blobServices/containers/blobs/delete",
                    "Microsoft.Storage/storageAccounts/blobServices/containers/blobs/read",
                    "Microsoft.Storage/storageAccounts/blobServices/containers/blobs/write",
                    "Microsoft.Storage/storageAccounts/blobServices/containers/blobs/move/action",
                    "Microsoft.Storage/storageAccounts/blobServices/containers/blobs/add/action"
                ],
                "notDataActions": []
            }
        ]
    }
}
```

æœ¬æ¥ã§ã‚ã‚Œã°ã€`Microsoft.Storage/storageAccounts/blobServices/containers/blobs/read`ã‚„`Microsoft.Storage/storageAccounts/blobServices/containers/blobs/write`ã®æ¨©é™ã‚’å¿…è¦ã¨ã™ã‚‹æ“ä½œãŒ[å…±åŒä½œæˆè€…]ã®ã¿ã§ãªãœã§ãã¦ã—ã¾ã†ã®ã§ã—ã‚‡ã†ã‹ã€‚ãã‚Œã¯ã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®èªè¨¼æ–¹æ³•ã®é•ã„ã«èµ·å› ã—ã¦ã„ã¾ã™ã€‚å®Ÿéš›ã®ãƒªã‚½ãƒ¼ã‚¹ã§è¦‹ã¦ã¿ã¾ã™ã€‚

## æŒ™å‹•ã®ç¢ºèªã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚‚ã‹ã­ã¦ãƒªã‚½ãƒ¼ã‚¹ã‚’è¦‹ã¦ã„ã
è‡ªåˆ†ã«å¯¾ã—ã¦[å…±åŒä½œæˆè€…]ãŒä»˜ä¸ã•ã‚ŒãŸã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ç”¨æ„ã—ã¾ã™ã€‚
![](/images/20231102-strg-auth/01.png)

ã‚ˆãè¦‹ã‚‹ã¨ã€Azure Portal ã«ãŠã‘ã‚‹ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®èªè¨¼æ–¹å¼ã¯ã‚­ãƒ¼ã«ã‚ˆã‚‹èªè¨¼ã«ãªã£ã¦ã„ã¾ã™ã€‚ã‚­ãƒ¼ã«ã‚ˆã‚‹èªè¨¼ã¯ã€`Microsoft.Storage/storageAccounts/listKeys/action`ã‚’ã‚‚ã£ã¦ã„ã‚Œã°ãƒ‘ã‚¹ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã§ã™ã€‚ã“ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¯`actions`ã«å±ã™ã‚‹ãŸã‚ã€å…±åŒä½œæˆè€…ã®*ã«ã‚ˆã£ã¦å†…åŒ…ã•ã‚Œã¦ã„ã¾ã™ã€‚ã¤ã¾ã‚‹ã¨ã“ã‚ã€ã“ã‚Œã¯å®Ÿéš›ã«ã¯ Microsoft Entra ID ã®ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã™ã‚‹ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’è¦‹ã¦ã„ã‚‹ã¨ã„ã†ã‚ˆã‚Šã¯ã€ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼ã‚’å–å¾—ã§ãã‚‹ã‹ï¼Ÿã¨ã„ã†è¦³ç‚¹ã§ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«ãªã£ã¦ã„ã¾ã™ã€‚
![](/images/20231102-strg-auth/02.png)

ã‚ˆã£ã¦ã®èªè¨¼æ–¹æ³•ã‚’ã€`Microsoft Entra user account`ã«å¤‰æ›´ã—ã¦ã¿ã‚‹ã¨ã€DataActions ã§ãã®ãƒ—ãƒªãƒ³ã‚·ãƒ‘ãƒ«ã«ãŠã‘ã‚‹ç›´æ¥ã®æ¨©é™ã‚’è©•ä¾¡ã—ãŸéš›ã«ã€æ¨©é™ãŒè¶³ã‚Šãšã«ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ã€‚
![](/images/20231102-strg-auth/03.png)

æ˜ç¤ºçš„ã«[ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸BLOBãƒ‡ãƒ¼ã‚¿é–²è¦§è€…]ã‚’å‰²ã‚Šå½“ã¦ã¦å†åº¦ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã¾ã™ã€‚
![](/images/20231102-strg-auth/04.png)

ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã¾ã™ã€‚
![](/images/20231102-strg-auth/05.png)

## Azure Portal ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹ã§ã¯ãªã„å ´åˆã¯ï¼Ÿ
ä¾‹ãˆã° Azure CLI ã§ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªã‹ãŸã¡ã§ BLOB ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ãŒã€ã“ã¡ã‚‰ã‚‚ `--auth-mode` ã®æŒ‡å®šãŒãªã„å ´åˆã¯ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼èªè¨¼ã«ãªã‚‹ãŸã‚ã€[å…±åŒä½œæˆè€…]ã®ã‚ˆã†ãªãƒ­ãƒ¼ãƒ«ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã¨ãªã‚Šã¾ã™ã€‚Microsoft Entra ID èªè¨¼ã‚’ã™ã‚‹ã«ã¯ `--auth-mode login` ã‚’æŒ‡å®šã—ã¾ã™ã€‚
```bash
az storage blob list --account-name <storageAccountName> \
--container-name <continerName> \
--auth-mode login \
```

https://jpazpaas.github.io/blog/2021/01/29/storage-permission-mismatch.html

# ã¾ã¨ã‚
- [ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸BLOBãƒ‡ãƒ¼ã‚¿é–²è¦§è€…]æ¨©é™( DataAction ã§ã„ãˆã°`Microsoft.Storage/storageAccounts/blobServices/containers/blobs/read`)ãŒãªãã¦ã‚‚ã€å…±åŒä½œæˆè€…ãªã©ã®å¼·ã„ãƒ­ãƒ¼ãƒ«ã«ã¯`Microsoft.Storage/storageAccounts/listKeys/action`ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒå«ã¾ã‚Œã¦ã„ã‚‹ãŸã‚ã€ã‚¢ã‚¯ã‚»ã‚¹ã‚­ãƒ¼çµŒç”±ã§ BLOB ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚

- ã‚­ãƒ¼ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ï¼â€ãã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚‹â€ãªã®ã§åˆ¥ã«å•é¡Œã¯ãªã„ã®ã§ã™ãŒã€èª¤è§£ã‚’ç”Ÿã¿ãã†ãªã®ã§ã“ã“ã«è¨˜ã—ã¦ãŠãã¾ã™ã€‚

# Reference
- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ãƒ¼ãƒ³ã¨ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ¼ãƒ³
https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/management/control-plane-and-data-plane

- BLOB ãƒ‡ãƒ¼ã‚¿ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã® Azure ãƒ­ãƒ¼ãƒ«ã‚’å‰²ã‚Šå½“ã¦ã‚‹
https://learn.microsoft.com/ja-jp/azure/storage/blobs/assign-azure-role-data-access?tabs=portal

- Azure ãƒãƒ¼ã‚¿ãƒ«ã§ BLOB ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ãã®èªè¨¼æ–¹æ³•ã®é•ã„ã«ã¤ã„ã¦
https://jpazpaas.github.io/blog/2023/08/17/Differences-in-authentication-methods-when-accessing-BLOB.html
