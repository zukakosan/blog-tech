---
title: "Azure Virtual Desktopの個人型ホストプールにおける電源管理をスケーリングプランにより実現する"
emoji: "💬"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
---
# モチベ
- 先日、AVDにおける個人型ホストプールにおけるスケーリングプランがパブリックプレビューとなったので試したい

https://learn.microsoft.com/ja-jp/azure/virtual-desktop/whats-new#autoscale-for-personal-host-pools-is-currently-in-preview

::: message
- 個人型のスケーリングプランはプール型のスケーリングプランとは全くの別物
- 個人型は以下のように動く(具体的には検証の中で触れる)
    - Start VM on ConnectでVMを起動、もしくは接続要求にかかわらずホストプールのVMを一斉にに起動
    - 「ｘ分切断状態が続いた」 or 「ｘ分ログオフ状態が続いた」をトリガーにしてVMのシャットダウンが可能
- プール型の場合は以下のように動く
    - 全体として許容するセッション数に対して、閾値を割合で定義しておく
    - その閾値を超えた場合にはスケールアウト・インする
:::

# 環境
Azure AD JoinのAVD環境を個人型ホストプールで作るだけ。
このあたりを参考にしてもいいですし、ネット上にいろいろ情報はあるかと。

https://learn.microsoft.com/ja-jp/azure/virtual-desktop/azure-ad-joined-session-hosts

:::message alert
2点ほど見落としがちな注意点
- AVDの利用ユーザに[仮想マシン管理者ログイン]もしくは[仮想マシンユーザログイン]の権限を付与する必要がある。
- Azure AD Joinの場合、実際にAVDのセッションホストに接続するローカルPCがAVDのAzure ADテナントに何らかの形で参加もしくは登録していない場合、「カスタムRDPプロパティ」に`targetisaadjoined:i:1`を追加することをお忘れなく。
:::

# スケーリングプランの作成
今回プレビューとなった機能であるスケーリングプランを作成する
- Azure Portalの検索窓で[スケーリングプラン]を検索し、作成する
![](/images/20230803-avd-personal-scaling/01.png)

- [個人用]でスケーリングプランを作成
![](/images/20230803-avd-personal-scaling/02.png)

## スケジュールの追加
- スケジュールを追加する。[全般]は適当に入れる。通常は平日の運用になるはず。
![](/images/20230803-avd-personal-scaling/03.png)

### ランプアップ
あくまで、設定した時間帯に応じてどの様に稼働させるかという話なので、[ランプアップ]という言葉の意味についてはプール型のホストプールの場合と違って意識しなくていい。
- 接続時にVMを起動する(Start VM on Connect)
    - 基本[はい]でよさそう。
- 起動するVM
    - ここは、ランプアップ時間になったときに起動するVMを選択する
    - [割り当てられたVMのみ]：ホストプールに属しているが明示的にユーザが割り当たっていないVMは起動しない設定
    - [割り当て済みVMと未割当てVM]：ユーザが割り当たっていないVMも含めてホストプールに属しているVMは前代起動しておく設定
    - 上記2つのオプションは、「ランプアップ時間になったら使用される可能性のあるVMは全台起動して待機」という考え方
    - [開始時刻にVMをオンにしない]：ランプアップの時間になってもVMを一斉起動はせずに、あくまでユーザからの接続をもって起動させるという動き
        - なので、このオプションを選択する場合には[接続時にVMを起動]を[はい]にしないと手動でセッションホストを起動しない限りユーザがアクセスできない状態になる
- 切断の設定：**切断**とは**サインアウトはしてないけどセッションが切断されている状態**、ブラウザのクローズ等を指す
    - [切断時間]：切断されて**ｘ分**経ったら
    - [実行]：シャットダウンする ot しない
- ログオフの設定：**ログオフ**なので、**明示的なサインアウトによりセッションが終了した状態**
    - [ログオフ時間]：ログオフして**ｘ分**経ったら
    - [実行]：シャットダウンする ot しない

![](/images/20230803-avd-personal-scaling/04.png)

他の期間も同じように設定する
### ピーク時間
- ここでは9:00-の時間帯
![](/images/20230803-avd-personal-scaling/05.png)

### ランプダウン

![](/images/20230803-avd-personal-scaling/07.png)

### ピーク時以外の時間
![](/images/20230803-avd-personal-scaling/08.png)
