---
title: "Microsoft Ignite 2023で発表されたVMのHibernateをAVDの個人型ホストプールのスケーリングプランに利用する"
emoji: "🔋"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["microsoft","ignite","AVD","VM"]
published: false
publication_name: "microsoft"
---
# これは何...?
- 2023年11/15-17にかけてIT開発者およびビジネス意思決定者向けのイベントである Microsoft Ignite が開催されています。
- Microsoft Ignite 2023 Book of News[*1] の中でも触れられている Azure Virtual Desktop Autoscale for Personal Desktops におけるセッションホストの `Hibernate` の検証を行います。
- こちらの機能は現在プレビュー段階です。
- 単に個人型 AVD のオートスケールについては[別の記事](https://zenn.dev/microsoft/articles/8b76d3ab77d497)を書いているので、そちらと併せてご参照ください。

# 仮想マシンの Hibernate (休止状態)とは
細かい点については、公式ドキュメント[*2]やテックブログ[*3]をご参照いただきたいところですが、超ざっくり言うと「VM のメモリ内状態が維持されたまま、マシンの割り当てを解除する」ことで「マシンコストを削減」しつつ、「VM の再起動後にアプリとプロセスを最後の状態から再開」することができるものになります。

テックブログにおいて、この `Hibernate` の利用シナリオの1つとして、AVD が挙げられています。
> Starting today, customers can also use hibernation (in preview) with Personal Desktop Autoscale and Start VM on Connect. Customers can configure their personal scaling plan to either hibernate or deallocate host machines. By choosing to hibernate machines, customers will be able to resume from right where they left off when the session starts again. 

# 実際に試してみる
既存の AVD 環境で試してみよう、となったのですが。Hibernate 自体がまだ制限が結構あるのでそこは注意します。
:::message
## VM サイズ制限
VM sizes with up to 32-GB RAM from the following VM series support hibernation.
- Dasv5-series
- Dadsv5-series
- Dsv5-series
- Ddsv5-series

## OS の制限(Windows 抜粋)
The following Windows operating systems support hibernation:

- Windows Server 2022
- Windows Server 2019
- Windows 11 Pro
- Windows 11 Enterprise
- Windows 11 Enterprise multi-session
- Windows 10 Pro
- Windows 10 Enterprise
- Windows 10 Enterprise multi-session

Windows limitations
- The page file can't be on the temp disk.
- Applications such as Device Guard and Credential Guard that require virtualization-based security (VBS) work with hibernation when you enable Trusted Launch on the VM and Nested Virtualization in the guest OS.
- Hibernation is only supported with Nested Virtualization when Trusted Launch is enabled on the VM

## 一般的な制限
- 既存の VM で休止状態を有効にすることはできません。
- 休止状態が有効になっている VM のサイズを変更することはできません。
- VM が休止状態になっている場合、VM に関連付けられているディスクや NIC をアタッチ、デタッチ、または変更することはできません。代わりに、VM を [停止] - [割り当て解除] 状態に移行する必要があります。
- VM が休止状態の場合、後で VM を起動するのに十分な容量を確保するための容量の保証はありません。まれに容量の問題が発生した場合は、後で VM の起動を試みることができます。容量予約では、休止状態の VM の容量は保証されません。
- VM を休止状態にするには、Azure portal、CLI、PowerShell、SDK、API を使用する必要があります。ゲスト OS 操作を使用して VM を休止状態にしても、VM は休止状態に移行せず、VM は引き続き課金されます。
- いったん有効にすると、VM で休止状態を無効にすることはできません。

:::


# Reference
- [*1] Microsoft Ignite 2023 Book of News (日本語)

https://news.microsoft.com/ignite-2023-book-of-news/ja/
- [*2] 仮想マシンの休止状態

https://learn.microsoft.com/ja-jp/azure/virtual-machines/hibernate-resume?tabs=osLimitsWindows%2CenablehiberPortal%2CcheckhiberPortal%2CenableWithPortal%2CcliLHE%2CUbuntu18HST%2CPortalDoHiber%2CPortalStatCheck%2CPortalStartHiber%2CPortalImageGallery

― [*3] Reduce Compute Costs by Pausing VMs (now in public preview)

https://techcommunity.microsoft.com/t5/azure-compute-blog/reduce-compute-costs-by-pausing-vms-now-in-public-preview/ba-p/3981127