---
title: "ExpressRoute çµŒç”±ã® VNet é–“æ¥ç¶š(éæ¨å¥¨) ã®æŒ™å‹•ãŒå¤‰ã‚ã£ãŸã‚‰ã—ã„ã®ã§è©¦ã™"
emoji: "ğŸš…"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["azure","network","microsoft","vnet"]
published: true
publication_name: "microsoft"
---

# ã¯ã˜ã‚ã«

Azure ExpressRoute (ER) ã§ã¯ã€åŒä¸€ã® ER Circuit ã«æ¥ç¶šã•ã‚Œã¦ã„ã‚‹ Virtual Network (VNet) é–“ã§ã®é€šä¿¡ãŒå¯èƒ½ã§ã™ã€‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ[^1] ã«ã‚‚è¨˜è¼‰ã®é€šã‚Šã€ã“ã®æ¥ç¶šæ–¹æ³•ã¯ **éæ¨å¥¨** ã§ã™ã€‚Azure å´ã¯å¾“æ¥æ—¢å®šã§ã“ã®æ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–ã—ã¦ã„ãŸã®ã§ã™ãŒã€éæ¨å¥¨ã§ã‚ã‚‹ã¨ã„ã†ã“ã¨ã‚‚ã‚ã‚Š (æ€ã„ã®ã»ã‹åˆ©ç”¨ã•ã‚Œã¦ã„ãŸã‹ã‚‰ã‹ã‚‚çŸ¥ã‚Œãªã„ã§ã™ãŒ) æ—¢å®šã§ç„¡åŠ¹åŒ–ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
> ä»®æƒ³ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’åŒã˜ ExpressRoute å›ç·šã«ãƒªãƒ³ã‚¯ã™ã‚‹ã¨ãã«æ—¢å®šã§ç™ºç”Ÿã—ã¾ã™ãŒã€ã“ã®ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã¯æ¨å¥¨ã•ã‚Œã¾ã›ã‚“ã€‚ ä»®æƒ³ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é–“ã®æ¥ç¶šã‚’ç¢ºç«‹ã™ã‚‹ã«ã¯ã€å¯èƒ½ãªé™ã‚Šæœ€é«˜ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’å¾—ã‚‹ãŸã‚ã«ã€ä»£ã‚ã‚Šã« VNet ãƒ”ã‚¢ãƒªãƒ³ã‚°ã‚’å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã¨ã¯ã„ãˆã€ã“ã‚ŒãŒå…¨ãåˆ©ç”¨ã§ããªããªã‚‹ã¨ã„ã†ã‚ã‘ã§ã¯ãªãã€ER Gateway å´ã®è¨­å®š[^2] ã«ã‚ˆã£ã¦æœ‰åŠ¹åŒ–å¯èƒ½ã§ã™ã€‚ã¾ãŸã€æ—¢å®šã® ER Gateway ã¯å½±éŸ¿ã‚’å—ã‘ã¾ã›ã‚“ã€‚ã¤ã¾ã‚Šã€ER çµŒç”±ã§ VNet é–“ã®é€šä¿¡ãŒã§ãã‚‹çŠ¶æ…‹ã§ã™ã€‚

ER çµŒç”±ã®æ¥ç¶šå¯å¦ã®è¨­å®šãŒ ER Gateway å´ã®æ§‹æˆã¨ã„ã†ã“ã¨ã§ã€ä¾‹ãˆã° ER Gateway â‘ , â‘¡, â‘¢ ãŒã‚ã‚‹ã¨ãã«ã€â‘ -â‘¡ ã®ã¿æ¥ç¶šå¯ã¨ã™ã‚‹ã‚ˆã†ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚‚ç”Ÿã¾ã‚Œã‚‹ã®ã§ã¯ãªã„ã‹ã¨ã„ã†ã¨ã“ã‚ã§ã€æ¤œè¨¼ã—ã¦ã¿ã¾ã™ã€‚

[^1]:https://learn.microsoft.com/ja-jp/azure/expressroute/virtual-network-connectivity-guidance?source=recommendations
[^2]:https://learn.microsoft.com/ja-jp/azure/expressroute/expressroute-howto-add-gateway-portal-resource-manager#enable-or-disable-vnet-to-vnet-or-vnet-to-virtual-wan-traffic-through-expressroute


# è©¦ã—ã¦ã¿ã‚‹
## ç’°å¢ƒæ§‹æˆ
ä»¥ä¸‹ã®ã‚ˆã†ã« 1 ã¤ã® ER Circuit ã«å¯¾ã—ã¦ ER Gateway ã‚’ 3 ã¤æ¥ç¶šã—ã¦ãŠãã¾ã™ã€‚

![](/images/20240322-ergw2ergw/architecture.png)

## æ—¢å®šã®çŠ¶æ…‹

![](/images/20240322-ergw2ergw/01.png)

æ—¢å®šã®çŠ¶æ…‹ã§ã¯ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¯å…¥ã£ã¦ã„ã¾ã›ã‚“ã€‚ã“ã®çŠ¶æ…‹ã§ã€VMâ‘ -VMâ‘¡ ãŠã‚ˆã³ VMâ‘ -VMâ‘¢ ã§ç–é€šç¢ºèªã™ã‚‹ã¨ã€ç–é€šã§ããªã„çŠ¶æ…‹ã¨ãªã£ã¦ã„ã¾ã™ã€‚

```bash
admin@vm-hub-01:~$ ping 10.2.0.4
PING 10.2.0.4 (10.2.0.4) 56(84) bytes of data.
^C
--- 10.2.0.4 ping statistics ---
5 packets transmitted, 0 received, 100% packet loss, time 4088ms

admin@vm-hub-01:~$ ping 10.3.0.4
PING 10.3.0.4 (10.3.0.4) 56(84) bytes of data.
^C
--- 10.3.0.4 ping statistics ---
8 packets transmitted, 0 received, 100% packet loss, time 7163ms
```

ã“ã“ã§ Gatewayâ‘¡ ã®ã¿ ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã¦ã¿ã‚‹ã€‚Virtual WAN ã¯åˆ©ç”¨ã—ã¦ã„ãªã„ãŸã‚ã€ãƒªãƒ¢ãƒ¼ãƒˆä»®æƒ³ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®è¨­å®šã®ã¿æœ‰åŠ¹åŒ–ã€‚ã“ã®æ›´æ–°ã«ã‚‚æ•°åˆ†æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ã€‚

![](/images/20240322-ergw2ergw/02.png)

ã“ã®çŠ¶æ…‹ã§ VMâ‘  ã‹ã‚‰ VMâ‘¡ ã¸ ping ã‚’é£›ã°ã—ã¦ã¿ã¦ã‚‚ã€è¿”ã£ã¦ãã¾ã›ã‚“ã€‚ã“ã‚Œã¯ Gatewayâ‘  ã§çµå±€ãƒªãƒ¢ãƒ¼ãƒˆ VNet ã‹ã‚‰ã®ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’æ‹’å¦ã—ã¦ã‚‹ã‹ã‚‰ã§ã™ã­ã€‚

```bash
admin@vm-hub-01:~$ ping 10.2.0.4
PING 10.2.0.4 (10.2.0.4) 56(84) bytes of data.
```

ã¨ã„ã†ã“ã¨ã§ã€Gatewayâ‘  ã§ã‚‚åŒã˜ããƒªãƒ¢ãƒ¼ãƒˆãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã™ã€‚

![](/images/20240322-ergw2ergw/03.png)

ã“ã®çŠ¶æ…‹ã§ VMâ‘  ã‹ã‚‰ VMâ‘¡ ã¸  ping ã‚’é£›ã°ã—ã¦ã¿ã‚‹ã¨ã€è¿”ã£ã¦ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚ä¸€æ–¹ã§ã€ã‚‚ã¡ã‚ã‚“ VMâ‘¢ ã¨ã¯ç–é€šã§ããªã„çŠ¶æ…‹ã§ã™ã€‚

```bash
admin@vm-hub-01:~$ ping 10.2.0.4
PING 10.2.0.4 (10.2.0.4) 56(84) bytes of data.
64 bytes from 10.2.0.4: icmp_seq=1 ttl=62 time=5.90 ms
64 bytes from 10.2.0.4: icmp_seq=2 ttl=62 time=7.33 ms
64 bytes from 10.2.0.4: icmp_seq=3 ttl=62 time=4.90 ms
64 bytes from 10.2.0.4: icmp_seq=4 ttl=62 time=4.92 ms
64 bytes from 10.2.0.4: icmp_seq=5 ttl=62 time=4.81 ms
64 bytes from 10.2.0.4: icmp_seq=6 ttl=62 time=5.28 ms
64 bytes from 10.2.0.4: icmp_seq=7 ttl=62 time=8.25 ms
^C
--- 10.2.0.4 ping statistics ---
7 packets transmitted, 7 received, 0% packet loss, time 6010ms
rtt min/avg/max/mdev = 4.808/5.912/8.253/1.260 ms

admin@vm-hub-01:~$ ping 10.3.0.4
PING 10.3.0.4 (10.3.0.4) 56(84) bytes of data.
^C
--- 10.3.0.4 ping statistics ---
4 packets transmitted, 0 received, 100% packet loss, time 3068ms
```

VMâ‘ -NIC ã«ã¦ effective route ã‚’è¦‹ã¦ã¿ã¾ã—ã‚‡ã†ã€‚VNetâ‘¡ ã‚‚ VNetâ‘¢ ã‚‚åŒã˜ã‚ˆã†ã«è¦‹ãˆã¦ã„ã‚‹ã®ã§ã€ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¨ã¯åˆ¥ã®ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¦ã„ãã†ã§ã™ã€‚

```bash
$ az network nic show-effective-route-table -g 20240322-ergw2ergw -n vm-hub-01569 -o table
Source                 State    Address Prefix    Next Hop Type          Next Hop IP
---------------------  -------  ----------------  ---------------------  -------------
Default                Active   10.1.0.0/16       VnetLocal
VirtualNetworkGateway  Active   10.3.0.0/16       VirtualNetworkGateway  10.2.146.76
VirtualNetworkGateway  Active   10.3.0.0/16       VirtualNetworkGateway  10.2.146.77
VirtualNetworkGateway  Active   10.2.0.0/16       VirtualNetworkGateway  10.2.146.76
VirtualNetworkGateway  Active   10.2.0.0/16       VirtualNetworkGateway  10.2.146.77
Default                Active   0.0.0.0/0         Internet
Default                Active   10.0.0.0/8        None
Default                Active   127.0.0.0/8       None
Default                Active   100.64.0.0/10     None
Default                Active   172.16.0.0/12     None
Default                Active   25.176.0.0/13     None
Default                Active   25.152.0.0/14     None
Default                Active   25.184.0.0/14     None
Default                Active   25.4.0.0/14       None
Default                Active   25.148.0.0/15     None
Default                Active   198.18.0.0/15     None
Default                Active   25.150.0.0/16     None
Default                Active   25.156.0.0/16     None
Default                Active   25.159.0.0/16     None
Default                Active   40.109.0.0/16     None
Default                Active   192.168.0.0/16    None
Default                Active   104.147.0.0/16    None
Default                Active   157.59.0.0/16     None
Default                Active   40.108.0.0/17     None
Default                Active   104.146.0.0/17    None
Default                Active   23.103.0.0/18     None
Default                Active   20.35.252.0/22    None
```

::: message

ãƒªãƒ¢ãƒ¼ãƒˆãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã®æœ‰åŠ¹åŒ–å‰ã« effective route ç¢ºèªã—ã¦ãŠã‘ã°ã‚ˆã‹ã£ãŸã®ã§ã™ãŒã€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ã‚ªãƒ•ã«ã—ã¦ä¿å­˜ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã£ã¦ã—ã¾ã£ãŸã®ã§ã‚ãã‚‰ã‚ã¾ã—ãŸã€‚

![](/images/20240322-ergw2ergw/04.png)

:::

# ãŠã‚ã‚Šã«

ã‚‚ã¨ã‚‚ã¨ã€ER Circuit ã‚’å…±æœ‰ã—ã¦ã„ã‚‹ VNet é–“ãŒã€Spoke ã‚‚å«ã‚ã¦é€šä¿¡ã§ãã¦ã—ã¾ã†[^3] ã¨ã„ã†å•é¡ŒãŒã‚ã£ãŸãŸã‚ã€ã“ã“ãŒé¸æŠ or å¼·åˆ¶ã§ãã‚‹ã¨ã„ã†ã“ã¨ã¯è‰¯ã„ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‹ã¨æ€ã„ã¾ã™ã€‚ãã‚‚ãã‚‚ã€Gateway ã®å¸¯åŸŸå¹…ã‚„ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ã®è¦³ç‚¹ã‹ã‚‰ã‚‚éæ¨å¥¨ã§ã¯ã‚ã£ãŸã®ã§ã€ã€Œä¾‹å¤–çš„ã«ä½¿ã„ãŸã„å ´åˆã«å„ Gateway ã§æœ‰åŠ¹åŒ–ã™ã‚‹ã“ã¨ã§ãã®é–“ã®é€šä¿¡ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€ã¨ã„ã£ãŸä½ç½®ã¥ã‘ã§åˆ©ç”¨ã™ã‚‹å½¢ã«ãªã‚‹ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚

[^3]:https://zenn.dev/microsoft/articles/27e9308291943b