---
title: "Azure Firewallの明示的なプロキシ(Explicit Proxy)によってプロキシ構成を簡素化する"
emoji: "🙌"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: ["Azure","firewall","プロキシ","L7"]
published: false
---
# これは何
- Azure Firewallの明示的なプロキシを試してみる話
- 現時点での注意点も記載

# Azure Firewall Explicit Proxy
先日Azure Firewallの明示的なプロキシ機能がPublic Previewとなりました。これによってプロキシサーバーを立てたり、外部のプロキシを経由させることなくAzure Firewallに一本化することが可能です。

アナウンス(as of Aug, 31, 2023)

https://azure.microsoft.com/en-us/updates/azure-firewall-explicit-proxy-is-now-in-public-preview

Docs

https://learn.microsoft.com/en-us/azure/firewall/explicit-proxy

解説Blog

https://techcommunity.microsoft.com/t5/azure-network-security-blog/demystifying-explicit-proxy-enhancing-security-with-azure/ba-p/3873445

## 何がうれしいのか
- クライアントからAzure Firewall経由でインターネットアクセスし隊となった場合に、Azure Firewallをプロキシとして設定することはできず、あくまで0.0.0.0/0->Azure FirewallのUDRによってトラフィックを制御することで実現していた
- このやり方だと、同じネットワークセグメントに属するクライアント全てに否応なく影響が出る
:::message
図を入れる
:::
- Azure Firewallをプロキシとして構成できるようになると、クライアント側から指定できるため、ネットワークトラフィックを曲げることなくクライアントごとの設定として利用できる
:::message
図を入れる
:::
- 加えて、この明示的なプロキシはAzure Firewallのアプリケーションルールでフィルタされるため、アプリケーションルールで利用可能なFQDNタグやWebカテゴリといったAzure PaaSらしい機能がそのまま利用可能
- 外部のプロキシを指定する場合だと、特にFQDNの管理が面倒だが、Azure Firewallであればそこをタグで管理できる

# 検証
以下のようなシンプルな環境を用意
:::message
図を入れる
:::

デフォルト状態でのインターネットアクセスは以下のような状況
![](/images/20230909-fwExpProxy/01.png)
*Internet access via Azure default NAT*
## Azure Firewall アプリケーションルールの作成
- とりあえずhttp/httpsですべてのFQDNにアクセスできるようにしておく
![](/images/20230909-fwExpProxy/08.png)

## 明示的なプロキシの有効化
- 先の通信をAzure Firewall Explicit Proxy経由にしていく
- Azure Firewallに関連付けているFirewall Policyを開き、[明示的なプロキシ]から[明示的なプロキシを有効にする]をチェック
- HTTP/HTTPSをAzure Firewall側のどのポートで待ち受けるかを指定(Squidの3128のイメージ)
    - HTTP/HTTPSで**共通の**ポート番号を指定するのは不可
    - ここでは60000/50000とした
- プロキシの自動構成は一旦なしで設定

![](/images/20230909-fwExpProxy/02.png)


## クライアント側の設定
- Windows Serverの[Proxy Settings]から、[Manual proxy setup]で`http=10.0.1.4:60000;https=10.0.1.4:50000`を指定
- すると、UDRを設定していないにもかかわらずAzure FirewallのPublic IPでインターネットに抜けていることがわかる

![](/images/20230909-fwExpProxy/03.png)
*Use a proxy server:on*
![](/images/20230909-fwExpProxy/04.png)
*Use a proxy server:off*

## プロキシの自動構成
- Azure Firewallの[プロキシの自動構成]を試す
- プロキシの構成はクライアント側では？と思ったが、どうやらこれはAzure Firewallの特定ポート経由でストレージアカウント上に保存されたPACファイルを参照できる仕組みのよう
- 以下のようなPACファイルを作成し、ストレージアカウント上に保存

```javascript:proxysample.pac
var http_proxy = "PROXY 10.0.1.4:60000";
var https_proxy = "PROXY 10.0.1.4:50000";

function FindProxyForURL(url, host) {
  if (url.startsWith('https:')) {
    return https_proxy;
  } else {
  return http_proxy;
  }
}
```
:::message
PACファイルはJavaScriptファイルとして作成し拡張子を`.pac`として保存
https://jpdsi.github.io/blog/internet-explorer-microsoft-edge/pac/
:::
- PACファイルのSASURLおよび公開するポート番号を指定
![](/images/20230909-fwExpProxy/05.png)
*Proxy Auto Setting w/ Storage SAS*

- SASURLが必要になるのであれば、わざわざAzure Firewall上で公開する必要あるのか？という気もする
:::message
クライアント側のProxy SettingでSASを直接参照できないのか？と思ったがそういうわけでもなさそう
![](/images/20230909-fwExpProxy/06.png)
:::

- 本題に戻り、クライアント側のProxy Settingから[Use setup script]をオンにし、`http://<Azure Firewall Private IP>:<Port>/<PAC file Name>`という形で指定する
- httpsでは読み込まれなかったため注意、クライアント-Azure Firewall間は内部通信なので問題なし
    - Azure Firewallのプロキシ自動構成機能がhttpでしか待ち受けないというだけかも

![](/images/20230909-fwExpProxy/07.png)
*Proxy Auto Setting w/ Azure Firewall Private IP*
 

