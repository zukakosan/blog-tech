---
title: "æ‰‹å…ƒã®Hyper-Vä¸Šã®Windows Server 2022(Gen2)ã‚’Azureã«æŒã¡è¾¼ã‚“ã§åˆ©ç”¨ã™ã‚‹"
emoji: "ğŸˆ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: []
published: false
---
# ãƒ¢ãƒãƒ™
- æ‰‹å…ƒã®Hyper-Vã§ç¨¼åƒã—ã¦ã„ã‚‹Windows Serverã‚’Azureã«æŒã¡è¾¼ã‚“ã§åˆ©ç”¨ã—ãŸã„ã‚·ãƒŠãƒªã‚ªã®æ¤œè¨¼ãŒã—ãŸã„
- å˜ã«ç§»è¡Œã¨ã„ã†ã“ã¨ã‚’è€ƒæ…®ã™ã‚‹ã®ã§ã‚ã‚Œã°Azure Migrateã‚’åˆ©ç”¨ã™ã‚‹ã®ãŒã‚·ãƒ³ãƒ—ãƒ«ã‹ã‚‚ã—ã‚Œãªã„ãŒã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆOSéå¯¾å¿œã®ãŸã‚ã€ŒVHDã‚’æŒã¡è¾¼ã‚€ã€ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã®Azureç§»è¡Œã‚’è©¦ã—ã¦ã¿ã‚‹
â€»ãªãŠã€Sysprepã¯ä¸€æ—¦ç„¡ã—ã§å®Ÿæ–½ã—ã¦ã¾ã™

# Hyper-Vä¸Šã«Windows Server 2022ã®VMã‚’ä½œæˆ
- ã“ã®ã‚ãŸã‚Šã«.isoãŒç½®ã„ã¦ã‚ã‚‹ã®ã§ãã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‚ç…§ã™ã‚‹å½¢ã§OSã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’å®Ÿæ–½
    - https://info.microsoft.com/ww-landing-windows-server-2022.html

::: details ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †
- Windows11ä¸Šã§Hyper-Vã‚’æœ‰åŠ¹åŒ–
- Hyper-Vä¸Šã§[æ–°è¦]>[ä»®æƒ³ãƒã‚·ãƒ³]ã‹ã‚‰VMä½œæˆ
    - ![](/images/20230531-vhdfromlocal/01.png)
- â€»ä»Šå›ã¯ç¬¬2ä¸–ä»£ã‚’åˆ©ç”¨ã—ãŸã„ã®ã§ã€[ç¬¬2ä¸–ä»£]ã‚’é¸æŠã™ã‚‹(**å¾Œã®ãƒãƒã‚Šãƒã‚¤ãƒ³ãƒˆ**)
    - ![](/images/20230531-vhdfromlocal/02.png)
- VMå´ã§ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆåˆ©ç”¨
    - ![](/images/20230531-vhdfromlocal/03.png)
- vhdxã®ä¿å­˜å ´æ‰€
    - ![](/images/20230531-vhdfromlocal/04.png)
- isoãƒ•ã‚¡ã‚¤ãƒ«ã®æŒ‡å®š
    - ![](/images/20230531-vhdfromlocal/05.png)


::: 

- å…·ä½“çš„ãªä½œæˆæ‰‹é †ã¯ã“ã¡ã‚‰ã‚‚å‚è€ƒã«(ã‚¯ã‚¤ãƒƒã‚¯ä½œæˆ)
    - https://inab818.site/microsoft-hyperv/windows10-windows-server-2022-download-install/


# Hyper-V VMä¸Šã§å¿…è¦ãªå¤‰æ›´ã‚’å®Ÿæ–½
- ã“ã“ã§ã¯Google Chromeå…¥ã‚ŒãŸã‚Šã€Desktopã«ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®
    - ![](/images/20230531-vhdfromlocal/06.png)

# VHDã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®æº–å‚™
## ã‚²ã‚¹ãƒˆOSä¸Šã§ã®ä½œæ¥­
- ã“ã¡ã‚‰ã®Docsã«ã‚ã‚‹æ‰‹é †ã‚’ãƒãƒãƒãƒã‚„ã£ã¦ã„ã
    - https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/prepare-for-upload-vhd-image#complete-the-recommended-configurations
    - ã“ã®ä½œæ¥­ã®ä¸­ã§ã€ã‚²ã‚¹ãƒˆOSå´ã®RDPè¨±å¯ã®è¨­å®š(Marketplaceä¸Šã®VMã§ã¯æ—¢å®šã§è¨±å¯)ãªã©ã‚‚è¡Œã£ã¦ã„ã
- ã¾ãŸã€Azure Portalã§ã®ç®¡ç†ã®ãŸã‚ã«**ä»®æƒ³ãƒã‚·ãƒ³ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ**ã‚‚å…¥ã‚Œã¦ãŠãäº‹ãŒæ¨å¥¨
    - https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/prepare-for-upload-vhd-image#complete-the-recommended-configurations
    - ç›´ãƒªãƒ³ã‚¯ï¼šhttps://go.microsoft.com/fwlink/?LinkID=394789
    - ![](/images/20230531-vhdfromlocal/07.png)
- Windows Updateã‚‚å½“ã¦ã‚‹
    - ![](/images/20230531-vhdfromlocal/08.png)

## Hyper-Vã‚³ãƒ³ã‚½ãƒ¼ãƒ«ä¸Šã§ã®ä½œæ¥­
- [ãƒ‡ã‚£ã‚¹ã‚¯ã®ç·¨é›†]ã‹ã‚‰VHDã‚’ä½œã£ã¦ã„ã(Azureã«æŒã¡è¾¼ã‚ã‚‹ã®ã¯å›ºå®šå®¹é‡ã®VHDã®ã¿)
::: details è¨­å®šé …ç›®(ã‚¹ã‚¯ã‚·ãƒ§ä»˜ã)
- æ§‹æˆã—ãŸHyper-Vä¸Šã®VMã®VHDXã‚’é¸æŠ
    - ![](/images/20230531-vhdfromlocal/09.png)
- [å¤‰æ›]ã‹ã‚‰VHDXã‚’ã‚‚ã¨ã«æ–°ã—ã„VHDã‚’ä½œæˆ
    - ![](/images/20230531-vhdfromlocal/10.png)
- [VHD]ã‚’é¸æŠ
    - ![](/images/20230531-vhdfromlocal/11.png)
- [å®¹é‡å›ºå®š]ã‚’é¸æŠ
    - ![](/images/20230531-vhdfromlocal/12.png)
- æ–°è¦VHDã®åå‰ã‚’ä»˜ã‘ã¦ä¿å­˜
    - ![](/images/20230531-vhdfromlocal/13.png)
- ç·¨é›†ã®å®Œäº†ã‚’å¾…ã¤(å°‘ã€…æ™‚é–“ãŒã‹ã‹ã‚‹)
    - ![](/images/20230531-vhdfromlocal/14.png)
- VHDã®ç”Ÿæˆã‚’ç¢ºèªã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®æ‰‹é †ã¸ç§»ã‚‹
    - ![](/images/20230531-vhdfromlocal/15.png)
:::

# VHDã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
- æ‰‹é †ã¯ã“ã®Docsã«è¼‰ã£ã¦ã„ã‚‹
    - https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/disks-upload-vhd-to-managed-disk-powershell#manual-upload
    - ä»Šå›ã¯ã€æ‰‹å‹•ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®ãƒ‘ãƒ¼ãƒˆã‚’å®Ÿæ–½
        - Connect-AzAccount
        - ãƒ­ãƒ¼ã‚«ãƒ«ã®PowerShellã‹ã‚‰Azureã«ç©ºã®ãƒãƒãƒ¼ã‚¸ãƒ‰ãƒ‡ã‚£ã‚¹ã‚¯ã‚’ä½œæˆ
        - ãƒãƒãƒ¼ã‚¸ãƒ‰ãƒ‡ã‚£ã‚¹ã‚¯ã®SASã‚’ç™ºè¡Œ
        - SASçµŒç”±ã§VHDã‚’ãƒãƒãƒ¼ã‚¸ãƒ‰ãƒ‡ã‚£ã‚¹ã‚¯ã«æµã—è¾¼ã¿
        - SASã‚’å¤±åŠ¹
        - VMä½œæˆ
- Docsã®æ‰‹é †ã‚’ã“ãªã—ã¦ã„ã
::: message alert
- Docsã®æ‰‹é †ã«ãŠã„ã¦ã€ãƒ‡ã‚£ã‚¹ã‚¯æ§‹æˆã‚’ä½œæˆã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã«è¦æ³¨æ„

```powershell:NGä¾‹
PS> $diskconfig = New-AzDiskConfig -SkuName 'Standard_LRS' -OsType 'Windows' -UploadSizeInBytes $vhdSizeBytes -Location '<yourregion>' -CreateOption 'Upload'
```
- ã“ã®ã¾ã¾å®Ÿè¡Œã™ã‚‹ã¨ãƒ‡ã‚£ã‚¹ã‚¯ã®è¨­å®šã¨ã—ã¦Hyper-Vã®ä¸–ä»£ãŒæ—¢å®šå€¤ã§ã‚ã‚‹`V1`=`Gen1`ã¨ã—ã¦èªè­˜ã•ã‚Œã¦ã—ã¾ã†
- ãã®ãƒ‡ã‚£ã‚¹ã‚¯ã§VMã‚’ä½œæˆã™ã‚‹ã¨ã€ãƒ‡ã‚£ã‚¹ã‚¯ã¨ã—ã¦ã¯`Gen1`ãªã®ã«VHDã¨ã—ã¦ã¯`Gen2`ã¨ãªã‚Šã€Azure VMãŒ`Boot Failure`ã‚’èµ·ã“ã™
- ã‚ˆã£ã¦ä»¥ä¸‹ã®ã‚ˆã†ã«æ˜ç¤ºçš„ã«ä¸–ä»£ã‚’æŒ‡å®šã™ã‚‹

```powershell:OKä¾‹
ps> $diskconfig = New-AzDiskConfig -SkuName 'Standard_LRS' -OsType 'Windows' -UploadSizeInBytes $vhdSizeBytes -Location 'eastus' -CreateOption 'Upload' -HyperVGeneration 'V2'
```
:::

::: details ã‚³ãƒ©ãƒ ï¼šä½•ã‚‚è€ƒãˆãšã«ã‚³ãƒãƒ³ãƒ‰ã‚’ã‚³ãƒ”ãƒšã—ãŸå ´åˆã®æ‚²åŠ‡ã¨è§£æ±º
- Docsã®ä¸€é€£ã®å‡¦ç†ã‚’çµ‚ãˆã‚‹ã¨ãƒ‡ã‚£ã‚¹ã‚¯ãŒä½œæˆã•ã‚Œã‚‹ã®ã§ã€ãã®ãƒ‡ã‚£ã‚¹ã‚¯ã‹ã‚‰VMä½œæˆ
    - ![](/images/20230531-vhdfromlocal/16.png)
    - ![](/images/20230531-vhdfromlocal/17.png)
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§ä½œæˆ
    - ![](/images/20230531-vhdfromlocal/18.png)
    - ã€Œã‚“ï¼ŸGen1ï¼Ÿã¾ãã„ã„ã‹ã€è¦‹ãªã‹ã£ãŸã“ã¨ã«ã—ã‚ˆã†â€¦ã€
- RDPã‚¢ã‚¯ã‚»ã‚¹
    - è¦‹ãŸããªã„ã‚„ã¤ãŒå‡ºã‚‹
    - ![](/images/20230531-vhdfromlocal/19.png)
- ã¨ã‚Šã‚ãˆãšãƒ„ã‚¤ãƒ¼ãƒˆã—ã¦æ‚©ã‚€
    - ![](/images/20230531-vhdfromlocal/20.png)
- ã€Œãªã‚‹ã»ã©ã‚ã‹ã‚‰ã‚“ã€
- ãƒ–ãƒ¼ãƒˆè¨ºæ–­ã‚’è¦‹ã¦ã¿ã‚‹ã¨ã€`Boot Failure`ãŒå‡ºã¦ã„ã‚‹
    - ![](/images/20230531-vhdfromlocal/21.png)
- ã€Œèµ·å‹•ã§ãã¦ãªã„ã£ã¦ã“ã¨ã¯ã€èµ·å‹•ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®ã‚ºãƒ¬ã‹ï¼Ÿã¡ã‚ƒã‚“ã¨Gen2æŒ‡å®šã§ãã‚‹ã¨ã“ã‚ã©ã“ã‹ã«ç„¡ã„ã‹ï¼Ÿã€
- ã€ŒNew-AzDiskConfigã‚„...ï¼ã€
    - https://learn.microsoft.com/en-us/powershell/module/az.compute/new-azdiskconfig?view=azps-10.0.0
:::

- AzCopyã«ã¤ã„ã¦ã®è£œè¶³
    - AzCopyè‡ªä½“ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãªã®ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã‚‚ã®ã§ã¯ãªã„
    - ä¸‹è¨˜ãƒªãƒ³ã‚¯ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦è§£å‡ã—ã¦ãŠã
        - https://learn.microsoft.com/ja-jp/azure/storage/common/storage-use-azcopy-v10#download-azcopy
    - ã‚³ãƒãƒ³ãƒ‰è‡ªä½“ã¯ã“ã‚“ãªæ„Ÿã˜ã«ãªã‚‹ã¯ãš
    ```powershell
    ps> .\azcopy.exe copy "C:\ProgramData\Microsoft\Windows\Virtual Hard Disks\vhd-export.vhd" $diskSas.AccessSAS --blob-type PageBlob
    ```
    - ã“ã‚“ãªæ„Ÿã˜ã§çµ‚ã‚ã‚‹
    ```
    100.0 %, 1 Done, 0 Failed, 0 Pending, 0 Skipped, 1 Total,
    
    Job b052fe70-fe57-8445-75fa-0bd8795e9386 summary
    Elapsed Time (Minutes): 5.3346
    Number of File Transfers: 1
    Number of Folder Property Transfers: 0
    Number of Symlink Transfers: 0
    Total Number of Transfers: 1
    Number of File Transfers Completed: 1
    Number of Folder Transfers Completed: 0
    Number of File Transfers Failed: 0
    Number of Folder Transfers Failed: 0
    Number of File Transfers Skipped: 0
    Number of Folder Transfers Skipped: 0
    TotalBytesTransferred: 136365212160
    Final Job Status: Completed
    ```
- ä½œæ¥­ã‚’çµ‚ãˆã¦Azure Portalã¸ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã‚‹ã¨ã€ãƒ‡ã‚£ã‚¹ã‚¯ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹

