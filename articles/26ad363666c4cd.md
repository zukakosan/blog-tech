---
title: "手元のHyper-V上のWindows Server 2022(Gen2)をAzureに持ち込んで利用する"
emoji: "🐈"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
---
# モチベ
- 手元のHyper-Vで稼働しているWindows ServerをAzureに持ち込んで利用したいシナリオの検証がしたい
- 単に移行ということを考慮するのであればAzure Migrateを利用するのがシンプルかもしれないが、クライアントOS非対応のため「VHDを持ち込む」パターンでのAzure移行を試してみる
※なお、Sysprepは一旦無しで実施してます

# Hyper-V上にWindows Server 2022のVMを作成
- このあたりに.isoが置いてあるのでそのファイルを参照する形でOSのインストールを実施
    - https://info.microsoft.com/ww-landing-windows-server-2022.html

::: details インストール手順
- Windows11上でHyper-Vを有効化
- Hyper-V上で[新規]>[仮想マシン]からVM作成
    - ![](/images/20230531-vhdfromlocal/01.png)
- ※今回は第2世代を利用したいので、[第2世代]を選択する(**後のハマりポイント**)
    - ![](/images/20230531-vhdfromlocal/02.png)
- VM側でインターネット利用
    - ![](/images/20230531-vhdfromlocal/03.png)
- vhdxの保存場所
    - ![](/images/20230531-vhdfromlocal/04.png)
- isoファイルの指定
    - ![](/images/20230531-vhdfromlocal/05.png)


::: 

- 具体的な作成手順はこちらも参考に(クイック作成)
    - https://inab818.site/microsoft-hyperv/windows10-windows-server-2022-download-install/


# Hyper-V VM上で必要な変更を実施
- ここではGoogle Chrome入れたり、Desktopにテキストファイルを配置
    - ![](/images/20230531-vhdfromlocal/06.png)

# VHDのアップロードの準備
## ゲストOS上での作業
- こちらのDocsにある手順をポチポチやっていく
    - https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/prepare-for-upload-vhd-image#complete-the-recommended-configurations
    - この作業の中で、ゲストOS側のRDP許可の設定(Marketplace上のVMでは既定で許可)なども行っていく
- また、Azure Portalでの管理のために**仮想マシンエージェント**も入れておく事が推奨
    - https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/prepare-for-upload-vhd-image#complete-the-recommended-configurations
    - 直リンク：https://go.microsoft.com/fwlink/?LinkID=394789
    - ![](/images/20230531-vhdfromlocal/07.png)
- Windows Updateも当てる
    - ![](/images/20230531-vhdfromlocal/08.png)

## Hyper-Vコンソール上での作業
- [ディスクの編集]からVHDを作っていく(Azureに持ち込めるのは固定容量のVHDのみ)
- 構成したHyper-V上のVMのVHDXを選択
    - ![](/images/20230531-vhdfromlocal/09.png)
- [変換]からVHDXをもとに新しいVHDを作成
    - ![](/images/20230531-vhdfromlocal/10.png)
- [VHD]を選択
    - ![](/images/20230531-vhdfromlocal/11.png)
- [容量固定]を選択
    - ![](/images/20230531-vhdfromlocal/12.png)
- 新規VHDの名前を付けて保存
    - ![](/images/20230531-vhdfromlocal/13.png)
- 編集の完了を待つ(少々時間がかかる)
    - ![](/images/20230531-vhdfromlocal/14.png)
- VHDの生成を確認してアップロードの手順へ移る
    - ![](/images/20230531-vhdfromlocal/15.png)





