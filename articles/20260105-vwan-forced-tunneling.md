---
title: "Azure Virtual WAN ãª Spoke VNET ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆé€šä¿¡åˆ¶å¾¡ã®æ¤œè¨"
emoji: "ğŸ¶"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["azure","network","wan"]
publication_name: "microsoft"
published: true
---

# Azure Virtual WAN ã«ãŠã‘ã‚‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆé€šä¿¡åˆ¶å¾¡
Azure Virtual WAN ã¯ã€æ‹ ç‚¹ã‚„ VNET ã‚’ Virtual WAN Hub (ä»¥é™ã€VWAN Hub) ã« VPN æ¥ç¶šã€ExpressRoute æ¥ç¶šã€VNET æ¥ç¶šã«ã‚ˆã£ã¦æ¥ç¶šã™ã‚‹ã“ã¨ã§ã€Any-to-Any ã®æ¥ç¶šã‚’å¯èƒ½ã«ã™ã‚‹ WAN ã®ã‚ˆã†ãªã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚VWAN Hub ã‚’ Hub ã¨ã™ã‚‹ Hub-Spoke æ§‹æˆãŒå‡ºæ¥ä¸ŠãŒã‚‹ã‚ã‘ã§ã™ãŒã€ã“ã®å ´åˆã® Spoke ã‹ã‚‰ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ã©ã†ã™ã‚‹ã‹ã¯ã€ã—ã°ã—ã°è­°é¡Œã«ä¸ŠãŒã‚Šã¾ã™ã€‚

ä¸»ãªçµŒè·¯ã¨ã—ã¦ã¯ä»¥ä¸‹ã®3ç‚¹ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã€‚
1. Spoke å´ã§ç›´æ¥å‡ºã™ï¼ˆãƒ­ãƒ¼ã‚«ãƒ« ãƒ–ãƒ¬ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆï¼‰
2. Azure Virtual WAN ä¸Šã® FW çµŒç”±ã§å‡ºã™
3. ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹å´ã‹ã‚‰å‡ºã™ï¼ˆå¼·åˆ¶ãƒˆãƒ³ãƒãƒªãƒ³ã‚°ï¼‰

## æ§‹æˆå›³
â€»å°‘ã—æ¦‚å¿µçš„ã«æ›¸ã„ã¦ã„ã‚‹éƒ¨åˆ†ãŒã‚ã‚Šã¾ã™ã€‚

```mermaid
graph LR
    Internet{{"â˜ï¸ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ"}}
    subgraph Azure["â˜ï¸ Azure"]
        subgraph VWAN["Virtual WAN"]
            subgraph VHub["VWAN Hub"]
                Hub[Hub Router]
                FWH[NVA]
            end
        end
        
        subgraph Spoke1["Spoke VNet 1"]
            S1[Resources]
        end
    end    
    subgraph OnPrem["ğŸ¢ ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹"]
        FW[FW]
        SW[Switch]
        OP[On-premise Servers]
        SW --- FW
    end
    

    
    S1 -->|ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šâ‘ | Internet
    FWH -->|ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šâ‘¡| Internet
    FW -->|ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šâ‘¢| Internet
    SW ---|VPN/ExpressRoute| Hub
    SW --- OP
    Hub ---|VNETæ¥ç¶š| S1
    Hub --- FWH
    
    style Hub fill:#0078d4,color:#fff
    style FWH fill:#ff9800,color:#fff
    style FW fill:#ff6b6b,color:#fff
    style VHub fill:
```


## 1. Spoke å´ã§ç›´æ¥å‡ºã™ï¼ˆãƒ­ãƒ¼ã‚«ãƒ« ãƒ–ãƒ¬ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆï¼‰
ã“ã‚Œã¯ã€æ—¢å®šã§æ¡ç”¨ã•ã‚Œã‚‹çµŒè·¯ã§ã™ã€‚Azure Virtual WAN ã§ãƒ«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç·¨é›†ã—ãŸã‚Šã€ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚° ã‚¤ãƒ³ãƒ†ãƒ³ãƒˆ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆãƒãƒªã‚·ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ã„ãªã„å ´åˆã«ã¯ã€é€šå¸¸é€šã‚Šã® VNET ã®ã‚¢ã‚¦ãƒˆãƒã‚¦ãƒ³ãƒ‰ã‚¢ã‚¯ã‚»ã‚¹çµŒè·¯ã¨ãªã‚Šã¾ã™(â‘ )ã€‚NAT Gateway ã‚„ Public IP çµŒç”±ã§ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã¨ãªã‚Šã¾ã™ã€‚

## 2. Azure Virtual WAN ä¸Šã® NVA çµŒç”±ã§å‡ºã™
ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’çµ±åˆçš„ã«ç®¡ç†ã—ãŸã„å ´åˆã€å…±é€šçš„ã«çµŒç”±ã•ã›ã‚‹ FW ã‚’çµŒè·¯ä¸Šã«é…ç½®ã—ã€ãã“ã§ SNAT ã•ã›ã¦ãƒ­ã‚°ã‚’å–å¾—ã™ã‚‹ã¨ã„ã†ã®ã¯ã‚ˆãã‚ã‚‹æ§‹æˆã§ã™ã€‚VWAN Hub ã«ã¯ Azure Firewall ã‚„ãã®ä»– Palo Alto ãªã©ã®ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ ã‚½ãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å«ã‚€ NVA ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã§ãã¾ã™ã€‚Azure Virtual WAN ã§ã¯ã€ã“ã®æ§‹æˆã‚’ç°¡å˜ã«è¡Œã†è¨­å®šã¨ã—ã¦ Routing Intent[^1] ãŒã‚ã‚Šã¾ã™ã€‚ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆå®›ã ã‘ã§ãªãã€ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆå®›ã®é€šä¿¡åˆ¶å¾¡ã‚‚åŒã˜æ©Ÿèƒ½ãŒä½¿ãˆã¾ã™ãŒã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã«é–¢ã—ã¦ã¯ã€ãƒã‚¯ã‚¹ãƒˆãƒ›ãƒƒãƒ—ã‚’ NVA ã«å‘ã‘ãŸãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ«ãƒ¼ãƒˆ (0.0.0.0/0) ãŒå„æ¥ç¶šå…ˆã«åºƒå ±ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€VWAN Hub ã® NVA çµŒç”±ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šãŒå®Ÿç¾ã—ã¾ã™(â‘¡)ã€‚

ã‚‚ã—ãã¯ã€VWAN ä¸Šã§å„æ¥ç¶šã«å¯¾ã™ã‚‹ãƒ«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã€Spoke å´ã®ãƒ«ãƒ¼ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã«é™çš„ãªãƒ«ãƒ¼ãƒˆã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ã‚‚ã“ã®ã‚ˆã†ãªæ§‹æˆãŒå¯èƒ½ã§ã™ã€‚

## 3. ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹å´ã‹ã‚‰å‡ºã™ï¼ˆå¼·åˆ¶ãƒˆãƒ³ãƒãƒªãƒ³ã‚°ï¼‰
æ—¢å­˜ã®ãƒŠãƒ¬ãƒƒã‚¸ã®æ´»ç”¨ã‚„ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¦ä»¶ã«ã‚ˆã£ã¦ã€ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã§é‹ç”¨ä¸­ã® FW çµŒç”±ã§ã—ã‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šãŒèªã‚ã‚‰ã‚Œãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚ã‚¯ãƒ©ã‚¦ãƒ‰ä¸Šã® NVA ã ã¨ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ç‰ˆã®ãƒãƒ¼ãƒ‰ã‚¦ã‚§ã‚¢ã¨å¯¾å¿œã—ã¦ã„ã‚‹æ©Ÿèƒ½ãŒç•°ãªã‚‹ã“ã¨ã‚‚ã—ã°ã—ã°ã‚ã‚Šã¾ã™ã€‚ãã®å ´åˆã€å°‘ã—é å›ã‚Šã¨ãªã‚Šã¾ã™ãŒã€ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã‚’çµŒç”±ã•ã›ã‚‹ã‚ˆã†ãªå¼·åˆ¶ãƒˆãƒ³ãƒãƒªãƒ³ã‚°æ§‹æˆãŒå¿…è¦ã«ãªã‚Šã¾ã™(â‘¢)ã€‚

:::message
ã“ã®æ§‹æˆã®ãŸã‚ã«ã¯ã€åŸºæœ¬çš„ã«ã¯ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã‹ã‚‰ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ«ãƒ¼ãƒˆã‚’ VWAN Hub å´ã«åºƒå ±ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ãŒã€ã“ã®æ©Ÿèƒ½ã¯ç¾æ™‚ç‚¹ã§ã¯é™å®šçš„ãªãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã«ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æä¾›ã¨ãªã£ã¦ã„ã¾ã™ã€‚

https://learn.microsoft.com/ja-jp/azure/virtual-wan/about-internet-routing#forced-tunnel
:::

# æ¤œè¨äº‹ä¾‹
ã“ã“ã®ãƒ‘ãƒ¼ãƒˆã§ã¯ã€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã«ã¾ã¤ã‚ã‚‹ã€å®Ÿéš›ã®ã„ãã¤ã‹ã®æ¤œè¨äº‹ä¾‹ã‚’éšæ™‚è¿½åŠ ã—ã¦ã„ãã¾ã™ã€‚

## åŸºæœ¬ã¯ VWAN Hub ã® NVA çµŒç”±ã¨ã™ã‚‹ãŒã€ç‰¹å®šã® Spoke ã®ã¿ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹çµŒç”±ã¨ã—ãŸã„
ç¾çŠ¶ã€VWAN Hub ä¸€ã¤ã§ã¯ã€ã“ã®æ§‹æˆã¯å®Ÿç¾ã§ãã¾ã›ã‚“ã€‚ã‚ˆã£ã¦ã€è¤‡æ•°ã® VWAN Hub ã‚’ç”¨æ„ã—ã€ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã¨ãã‚Œãã‚Œæ¥ç¶šã—ã¾ã™ã€‚ãã®ã†ãˆã§ã€å¼·åˆ¶ãƒˆãƒ³ãƒãƒªãƒ³ã‚°ã‚’æ§‹æˆã—ãŸã„å´ã®ã¿ã§ 0.0.0.0/0 ã‚’å—ã‘å–ã‚‹ã‚ˆã†ã«ã—ã¾ã™ã€‚ã“ã®çµŒè·¯ã¯ãƒãƒ–é–“ã§ä¼é”ã•ã‚Œã¾ã›ã‚“ã€‚ã“ã®åˆ†é›¢ã•ã‚ŒãŸ Spoke å®›ã®çµŒè·¯ã¯ã‚‚ã†ä¸€æ–¹ã® Hub å´ã‹ã‚‰ã‚‚è¦‹ãˆã¾ã™ãŒã€ãƒªãƒ¢ãƒ¼ãƒˆãƒãƒ–ã‹ã‚‰ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã«ä¼é”ã•ã‚Œã‚‹çµŒè·¯ã«ã¯ã€AS_PATH ã§ 65520-65520 ãŒè¿½åŠ ã•ã‚Œã‚‹[^2] ãŸã‚ã€éå¯¾ç§°ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã«ã¯ãªã‚Šã¾ã›ã‚“ã€‚

```mermaid
graph LR
    Internet{{"â˜ï¸ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆ"}}
    subgraph Azure["â˜ï¸ Azure"]
        subgraph VWAN["Virtual WAN"]
            subgraph VHub["VWAN Hub"]
                Hub[Hub Router]
                FWH[NVA]
            end
            subgraph VHub2["VWAN Hub2"]
                Hub2[Hub Router]
            end
        end        
        subgraph Spoke1["Spoke VNet 1"]
            S1[Resources]
        end
        subgraph Spoke2["Spoke VNet 2"]
            S2[Resources]
        end
    end    
    subgraph OnPrem["ğŸ¢ ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹"]
        FW[FW]
        SW[Switch]
        OP[On-premise Servers]
        SW --- FW
    end
    
    FWH -->|ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šâ‘¡| Internet
    FW -->|ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šâ‘¢| Internet
    SW ---|VPN/ExpressRoute| Hub
    SW --- OP
    Hub ---|VNETæ¥ç¶š| S1
    Hub --- FWH
    Hub2 ---|VNETæ¥ç¶š| S2
    SW ---|VPN/ExpressRoute| Hub2

    linkStyle 0 stroke:#ff0000,stroke-width:2px
    linkStyle 2 stroke:#ff0000,stroke-width:2px
    linkStyle 7 stroke:#ff0000,stroke-width:2px
    linkStyle 8 stroke:#ff0000,stroke-width:2px

    linkStyle 1 stroke:#fff000,stroke-width:2px
    linkStyle 5 stroke:#fff000,stroke-width:2px
    linkStyle 6 stroke:#fff000,stroke-width:2px
    
    style Hub fill:#0078d4,color:#fff
    style Hub2 fill:#0078d4,color:#fff

    style FWH fill:#ff9800,color:#fff
    style FW fill:#ff6b6b,color:#fff
    style VHub fill:
```

## Spoke ã® UDR ã§ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã® FW ã‚’æŒ‡å®šã™ã‚Œã°ã‚ˆã„ã®ã§ã¯ï¼Ÿ
ã„ã„ãˆã€‚Azure ã® UDR ã§ Next hop ã«æŒ‡å®šã™ã‚‹ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ã€ã€Œä»®æƒ³ãƒã‚·ãƒ³ã«æ¥ç¶šã•ã‚ŒãŸãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ã‚¤ã‚¹ã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ã¾ãŸã¯ã€ŒAzure å†…éƒ¨ãƒ­ãƒ¼ãƒ‰ ãƒãƒ©ãƒ³ã‚µãƒ¼ã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã€ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãã‚Œä»¥å¤–ã®å ´åˆã€NIC ã® Effective Route ä¸Šã§ã¯ã€None ã¨è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

> ãƒã‚¯ã‚¹ãƒˆ ãƒ›ãƒƒãƒ—ã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ã€Azure ExpressRoute ã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤ã¾ãŸã¯ Azure Virtual WAN çµŒç”±ã§ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã›ãšã€ç›´æ¥æ¥ç¶šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ ç›´æ¥æ¥ç¶šã›ãšã«ãƒã‚¯ã‚¹ãƒˆ ãƒ›ãƒƒãƒ—ã‚’ IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã«è¨­å®šã™ã‚‹ã¨ã€UDR æ§‹æˆãŒç„¡åŠ¹ã«ãªã‚Šã¾ã™ã€‚

https://learn.microsoft.com/ja-jp/azure/virtual-network/virtual-networks-udr-overview#user-defined-routes

[^1]:https://learn.microsoft.com/ja-jp/azure/virtual-wan/how-to-routing-policies
[^2]:https://learn.microsoft.com/ja-jp/azure/virtual-wan/about-virtual-hub-routing-preference#:~:text=Virtual%20WAN%20%E3%83%8F%E3%83%96%E3%81%8C%E5%88%A5%E3%81%AE%20Virtual%20WAN%20%E3%83%8F%E3%83%96%E3%81%AB%E3%83%AB%E3%83%BC%E3%83%88%E3%82%92%E3%82%A2%E3%83%89%E3%83%90%E3%82%BF%E3%82%A4%E3%82%BA%E3%81%99%E3%82%8B%E3%81%A8%E3%80%81%E3%81%93%E3%81%AE%E3%83%AB%E3%83%BC%E3%83%88%E3%81%AB%E3%81%AF%20ASN%2065520%2D65520%20%E3%81%8C%20AS%20%E3%83%91%E3%82%B9%E3%81%AE%E5%89%8D%E3%81%AB%E4%BB%98%E5%8A%A0%E3%81%95%E3%82%8C%E3%81%BE%E3%81%99%E3%80%82