---
title: "Azure Site Recovery の整合性と Azure Backup との比較"
emoji: "🔥"
type: "tech" # tech: 技術記事 / idea: アイデア
topics: []
published: false
---
# Azure Site Recovery における整合性レベル

## 1. Azure Site Recovery（ASR）とは

Azure Site Recovery は、オンプレミスや Azure 上の VM を別リージョンへレプリケーションし、障害時にフェールオーバーで迅速に復旧させる DR（Disaster Recovery）サービスです。

ASR は VM のディスクを **ブロックレベル（block-level replication）**で継続コピーし、復旧時には同じ構成の VM を自動的に作成・起動できます。

---

## 2. ブロックレプリケーションとは

### ✔ 概要

- ディスクを「ブロック」という固定サイズ単位（4 KB など）で扱い、
  --変更されたブロックだけを継続的にレプリケーションする方式--。
- OS やアプリケーションを理解しなくても、**ディスク内容そのものを正確にコピー**できる。

### ✔ メリット

- OS / アプリに依存しない（どんなアプリでもレプリケート可能）
- 高速・効率的（差分のみコピー）
- VM をほぼ完全クローンとして DR 側で復元可能

```
[変更前と変更後のイメージ]
 ├─ ブロック1：変更なし
 ├─ ブロック2：変更あり → レプリケート
 ├─ ブロック3：変更なし
 ├─ ブロック4：変更あり → レプリケート
```

---

## 3. 整合性（Consistency）の種類

ASR では、バックアップ・レプリケーションの世界で一般的な **3つの整合性レベル**を扱う。

### 3.1 クラッシュ整合性（Crash-consistent）

- **電源断の瞬間の状態**をコピーしたもの
- OS・アプリが書き込み中でも強制的にスナップショット
- 最も簡易的で、最も不整合が起きやすい

例：

- DB がトランザクション途中で止まる
- アプリのログが部分書き込みで壊れる

### 3.2 アプリ整合性（Application-consistent）

- **アプリが I/O を停止し、キャッシュを flush したうえでスナップショット**
- データベースのトランザクションが正しい状態で保存される
- 復旧後にアプリがそのまま起動しやすい
- 最も高品質な整合性

---

## 4. クラッシュ整合性の問題点

クラッシュ整合性は DR の最低ラインとしては成立するが、以下の問題が起きやすい。

### 4.1 データ不整合

- アプリが書き込み途中で中断される
- ログや設定ファイルが破損する可能性

### 4.2 データベース不整合

- トランザクションが未完了のまま
- DB が “リカバリモード” に入り復旧が必要
- 場合によっては DB が壊れ起動不能になる

### 4.3 OS の整合性問題

- メタデータが中途半端
- 起動時に chkdsk/fsck が走る
- 稀に OS 起動不可

### 4.4 アプリの異常終了扱い

- キャッシュ再構築
- エラー処理が必要
- 手動復旧が増えて RTO が伸びる

---

## 5. アプリ整合性が優れている理由

### ✔ Windows: VSS（Volume Shadow Copy Service）

VSS Writer がアプリに対して：

1. I/O 停止
2. キャッシュ flush
3. スナップショット作成
4. I/O 再開

を実行し、**矛盾のないクリーンな状態**を作る。

---

## 6. ASR におけるフェールオーバーと整合性

ASR はフェールオーバー時に **複数の復元ポイント（RPO）**を提示。

- クラッシュ整合性ポイント（多い / RPO が短い）
- アプリ整合性ポイント（少ない / 品質が高い）

### ✔ 選択の基準

- DB やトランザクションを扱うアプリ → --アプリ整合性を使用すべき--
- ステートレスな Web アプリなど → クラッシュ整合性でも許容可能

---

## 7. ASR が自動化してくれること・しないこと

### ✔ 自動で行われる（VM の復元処理）

- レプリカディスクの展開
- VM の作成（サイズ・NIC 設定の再現）
- 自動起動
- OS 起動確認

### ✔ 自動ではない（手動 or 自動化が必要）

- DNS 切り替え
- Public IP の付け替え
- LB / NSG / UDR の調整
- 依存する PaaS（DB/Storage）の DR 対応
- アプリ層の整合性検証

## 8. Azure Backup との比較

### Azure Backup が向いていること
- データ保護（誤削除・ランサム対策）
- 長期保管（週次・月次・年次）
- ファイルや個別ファイルの復元
- VM 全体の復元（ただし RTO 長い）

あくまで、保険のためのデータ保存の意味合いが強く、主軸は DR という文脈ではない

### Azure Backup のみをDRに使った場合の問題点
#### 1. RTO が長すぎる

Backup から VM を復元する場合
```
1. Managed Disk の再構築
2. VM の再作成
3. ネットワーク設定の再構築
4. アタッチ・起動待ち
```
→ 数十分〜数時間かかり、DR としてすぐ動かす用途には間に合わない。

#### 2. 復元ポイントが古い（RPO が悪い）

Azure Backup は最短 4h ごとのバックアップが可能。つまり障害時には 最大 4 時間分のデータ消失もあり得る。
ASR はクラッシュ整合性復旧ポイントを 5min ごとに取得し、アプリ整合性復旧ポイントは最短 1h ごとに可能。

#### 3. VMを「別リージョンに即座に起動」できない

Backup は「復元」であり、フェールオーバー（即時の代替稼働）」ではない。
ASR のようにターゲットリージョンに 自動で VM 生成 & 起動はできない。

#### 4. 依存するネットワーク／アプリ構成が自動で作られない

Backup からの復元は、VNet・NSG・Public IP・Load Balancer・UDR などを 手で再構成する必要がある。ASR はこれらをあらかじめマッピングしておける。

#### 比較のまとめ

| 観点         | Azure Backup    | ASR           |
| ---------- | --------------- | ------------- |
| 主目的        | データ保護           | DR（事業継続）      |
| RTO        | 長い（場合により 24h 以上）        | 1h 以内       |
| RPO        | 大きい（4h〜24h）       | 小さい（数分）    |
| 復旧方法       | 復元（VMを再作成）      | フェールオーバー（即起動） |
| アプリ整合性     | △               | ◎             |
| ネットワーク自動復元 | ×               | ◎             |
| コスト        | 安い              | 高い            |
| 運用難易度      | 低い              | 中〜高           |
| 最適用途       | 誤削除・ランサム対策、長期保管 | サービス継続、災害対策   |

---



## 8. まとめ（要点）

- ASR は block-level replication で VM を正確に複製
- クラッシュ整合性は「電源断レベル」で最も不完全
- アプリ整合性は「アプリが止まったクリーンな状態」で最も高品質
- DB・書き込み系アプリ → アプリ整合性は必須級
- フェールオーバー後、アプリが正しく動くかは DR 設計に依存
