Ê§úË®º
-----------------------------
Áí∞Â¢ÉÊ∫ñÂÇôÁ∑®
    1. IIS„Çµ„Éº„Éê„Éº„ÇíÁ´ã„Å¶„Çã
    2. AppService Ë®ºÊòéÊõ∏‰ΩúÊàê
    3. Ë®ºÊòéÊõ∏( KV „ÅÆ Secret „Å´Ê†ºÁ¥ç) „Çí„Éê„Ç§„É≥„Éâ
„Éº„Éº„Éº„Éº„Éº„Éº„Éº„Éº„Éº„Éº„Éº„Éº„Éº„Éº„Éº„Éº„Éº„Éº
Ëá™ÂãïÊõ¥Êñ∞Á¢∫Ë™çÁ∑®
    4. Ë®ºÊòéÊõ∏„Çí‰Ωï„Çâ„ÅãÊõ¥Êñ∞„Åó„Å¶„ÄÅËá™ÂãïÊõ¥Êñ∞„ÅÆÁ¢∫Ë™ç
        a. „Åä„Åù„Çâ„Åè„ÄÅVMÊã°ÂºµÊ©üËÉΩ„ÅåÂøÖË¶ÅÔºöWindows Áî®„ÅÆ Azure Key Vault VM Êã°ÂºµÊ©üËÉΩ - Azure Virtual Machines | Microsoft Learn
        

# 1Ôºé„Çµ„Éº„Éê„Éº„Éû„Éç„Éº„Ç∏„É£„Åã„Çâ IIS „ÅÆ„Ç§„É≥„Çπ„Éà„Éº„É´




„Ç§„É≥„Éê„Ç¶„É≥„ÉâÁî®„Å´„Éë„Éñ„É™„ÉÉ„ÇØIP„Çí‰ªò‰∏é
->„Ç´„Çπ„Çø„É†„Éâ„É°„Ç§„É≥„Çí VM „ÅÆ IP„Å´Ëß£Ê±∫„Åß„Åç„Çã„Çà„ÅÜ„Å´ DNS „ÅÆË®≠ÂÆö„ÇÇË°å„Å£„Å¶„Åä„Åè

NSG „Åß„ÅÆ„Ç§„É≥„Éê„Ç¶„É≥„ÉâË®±ÂèØ



Â§ñÈÉ®„Åã„Çâ„Å§„Å™„ÅÑ„Åß IIS „ÅÆÁ®ºÂÉç„ÇíÁ¢∫Ë™ç


# 2. AppService Ë®ºÊòéÊõ∏„ÅÆ‰ΩúÊàê


Azure Key Vault „Å´Ê†ºÁ¥ç„Åó„Å¶„ÅÑ„Åè



App Service Ë®ºÊòéÊõ∏Áî®„ÅÆ AKV „Åß„ÅØ„ÄÅ„Ç¢„ÇØ„Çª„Çπ„Éù„É™„Ç∑„Éº„Çí‰Ωø„Åà„Å™„ÅÑ
>[Ê¨°„Å∏] „ÇíÈÅ∏Êäû„Åó„ÄÅ[„Ç≥„É≥„ÉÜ„Éä„Éº „Ç¢„ÇØ„Çª„Çπ „Éù„É™„Ç∑„Éº] „ÇíÈÅ∏Êäû„Åó„Åæ„Åô„ÄÇ ÁèæÂú®„ÄÅApp Service Ë®ºÊòéÊõ∏„Åß„ÅØ„ÄÅ„É≠„Éº„É´„Éô„Éº„Çπ„ÅÆ„Ç¢„ÇØ„Çª„ÇπÂà∂Âæ°„É¢„Éá„É´„Åß„ÅØ„Å™„Åè„ÄÅKey Vault „Ç¢„ÇØ„Çª„Çπ „Éù„É™„Ç∑„Éº„ÅÆ„Åø„Åå„Çµ„Éù„Éº„Éà„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ
App Service Ë®ºÊòéÊõ∏„ÅÆÁÆ°ÁêÜ - Azure App Service | Microsoft Learn

Ê†ºÁ¥ç‰ΩúÊ•≠„ÅÆ Caller „ÅØ Microsoft Azure App Service „Å®„Å™„Çã„Åå„ÄÅÂøÖË¶Å„Å™„Éù„É™„Ç∑„Éº„ÅØ‰∫ãÂâç„Å´ËøΩÂä†„Åï„Çå„Å¶„ÅÑ„Çã





„Éâ„É°„Ç§„É≥„ÅÆÊ§úË®º„ÇÇË°å„ÅÜ


Ê§úË®º„ÅåÂÆå‰∫Ü„Åô„Çã„Å®‰ª•‰∏ã„ÅÆÁîªÈù¢



Ê∫ñÂÇôÂÆå‰∫ÜÁä∂ÊÖã„Åß„ÅÇ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç




# 3. IIS „Å®„ÅÆ„Éê„Ç§„É≥„Éâ
ÁµêË´ñ„Åã„ÇâË®Ä„ÅÜ„Å®„ÄÅIIS „Åã„Çâ Key VaultÔºàKVÔºâ‰∏ä„ÅÆ App Service Certificate „Çí‚ÄúÁõ¥Êé•‚Äù„Éê„Ç§„É≥„Éâ„Åô„Çã„Åì„Å®„ÅØ„Åß„Åç„Åæ„Åõ„Çì„ÄÇ
ÂøÖ„Åö‰∏ÄÂ∫¶ VM „Å´ PFXÔºàÁßòÂØÜÈçµ‰ªò„ÅçË®ºÊòéÊõ∏Ôºâ„Å®„Åó„Å¶„Ç§„É≥„Éù„Éº„Éà„Åó„Å¶„Åã„Çâ„ÄÅIIS „Å´„Éê„Ç§„É≥„Éâ„Åó„Åæ„Åô„ÄÇ
„Å™„ÅúÁõ¥Êé•„Éê„Ç§„É≥„Éâ„Åß„Åç„Å™„ÅÑ„ÅÆ„ÅãÔºàÈáçË¶ÅÔºâ
    ‚Ä¢ IIS „Åå HTTPS „Éê„Ç§„É≥„Éâ„ÅßÂèÇÁÖß„Åß„Åç„Çã„ÅÆ„ÅØ
üëâ Windows Ë®ºÊòéÊõ∏„Çπ„Éà„Ç¢ÔºàLocalMachine\MyÔºâ
    ‚Ä¢ Key Vault „ÅØ
üëâ Â§ñÈÉ®„ÅÆÁßòÂØÜÈçµ„Çπ„Éà„Ç¢
    ‚Ä¢ IIS „Å´„ÅØ Key Vault „ÇíÁõ¥Êé•ÂèÇÁÖß„Åô„Çã‰ªïÁµÑ„Åø„ÅåÂ≠òÂú®„Åó„Å™„ÅÑ
„Å§„Åæ„ÇäÔºö
    KV = ‰øùÁÆ°Â∫´
    IIS = „É≠„Éº„Ç´„É´Ë®ºÊòéÊõ∏„Çπ„Éà„Ç¢„Åó„ÅãË¶ã„Å™„ÅÑ
    
„Çà„Å£„Å¶„ÄÅKV „Åã„Çâ pfx „ÇíÂèñÂæó„Åó„Å¶„ÄÅWinServ„ÅÆË®ºÊòéÊõ∏„Çπ„Éà„Ç¢„Å´„Ç§„É≥„Éù„Éº„Éà„Åô„ÇãÂøÖË¶Å„Åå„ÅÇ„Çã
‚Üí„Åì„Çå„ÇíËá™Âãï„Å´„Åó„Åü„ÅÑ„Åå„ÄÅ„Åæ„Åö„ÅØ„Åù„ÅÆ„Ç§„É≥„Éù„Éº„Éà„ÅÆÊµÅ„Çå„ÇíË©¶„Åô
‚ÜíËá™ÂãïÂåñ„Å´„Å§„ÅÑ„Å¶„ÅØ„ÄÅVM„ÅÆKeyVaultÊã°ÂºµÊ©üËÉΩ„Åå„Åù„Åì„Çí„ÇÑ„Å£„Å¶„Åè„Çå„Åù„ÅÜ
>Key Vault VM Êã°ÂºµÊ©üËÉΩ„ÅØ„ÄÅ„Åô„Åπ„Å¶„ÅÆË®ºÊòéÊõ∏„Çí Windows Ë®ºÊòéÊõ∏„Çπ„Éà„Ç¢„ÄÅ„Åæ„Åü„ÅØ VM Êã°ÂºµÊ©üËÉΩË®≠ÂÆö„ÅÆ certificateStoreLocation „Éó„É≠„Éë„ÉÜ„Ç£„ÅßÊåáÂÆö„Åï„Çå„ÅüÂ†¥ÊâÄ„Å´„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åô„ÄÇ
From <https://learn.microsoft.com/ja-jp/azure/virtual-machines/extensions/key-vault-windows?utm_source=chatgpt.com> 

„Å§„Åæ„Çä„ÄÅËá™Âãï„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Å¶„Åè„Çå„Çã

‚ë†VM‰∏ä„Åß„ÅÆË®ºÊòéÊõ∏„ÅÆÂèñÂæó
$vaultName = "akv-iiscert-jpe"
$secretName = "wildcard-kedamatech386b3521-3256-4f32-b716-4ec7e5703ef5"

# Managed Identity „Åß„É≠„Ç∞„Ç§„É≥
Connect-AzAccount -Identity

# SecretÔºàBase64 „ÅÆ PFXÔºâ„ÇíÂèñÂæó
$secret = Get-AzKeyVaultSecret -VaultName $vaultName -Name $secretName

# PFX „Å´Â§âÊèõ
$pfxBytes = [Convert]::FromBase64String($secret.SecretValueText)
$pfxPath = "C:\temp\appservicecert.pfx"
[IO.File]::WriteAllBytes($pfxPath, $pfxBytes)


‚ë°Windows Ë®ºÊòéÊõ∏„Çπ„Éà„Ç¢„Å´„Ç§„É≥„Éù„Éº„Éà
$password = ConvertTo-SecureString -String "" -Force -AsPlainText

Import-PfxCertificate `
  -FilePath $pfxPath `
  -CertStoreLocation Cert:\LocalMachine\My `
  -Password $password

App Service Certificate „ÅØ„Éë„Çπ„ÉØ„Éº„ÉâÁÑ°„Åó

‚ë¢IIS „Å´ HTTPS „Éê„Ç§„É≥„Éâ
Import-Module WebAdministration

# „Çµ„Ç§„ÉàÂêç„Éª„Éõ„Çπ„ÉàÂêç„ÅØÈÅ©ÂÆúÂ§âÊõ¥
New-WebBinding `
  -Name "Default Web Site" `
  -Protocol https `
  -Port 443 `
  -HostHeader "home.kedamatech.com"


„ÇÑ„Å£„Å¶„Åø„Çà„ÅÜ„ÄÇ„Åæ„Åö„ÅØ„ÄÅVM „ÅÆ Managed ID „Å´ AKV „ÅÆ„Ç∑„Éº„ÇØ„É¨„ÉÉ„ÉàÂèñÂæóÊ®©ÈôêÔºà„Ç¢„ÇØ„Çª„Çπ„Éù„É™„Ç∑„Éº„ÅßÔºâ„Åä„Çà„Å≥„ÄÅRG „ÅÆReadÊ®©Èôê„Çí‰ªò„Åë„Çã





wildcard-kedamatech386b3521-3256-4f32-b716-4ec7e5703ef5



‰∏äË®ò„ÅÆÊâãÈ†Ü„Å´Âæì„Å£„Å¶ÂÆüË°å
‚ë†PFX„ÅÆÂèñÂæó
PS C:\Windows\system32> $vaultName = "akv-iiscert-jpe"
PS C:\Windows\system32> $secretName = "wildcard-kedamatech386b3521-3256-4f32-b716-4ec7e5703ef5"
PS C:\Windows\system32> $secret = Get-AzKeyVaultSecret -VaultName $vaultName -Name $secretName
PS C:\Windows\system32> $secret


Vault Name   : akv-iiscert-jpe
Name         : wildcard-kedamatech386b3521-3256-4f32-b716-4ec7e5703ef5
Version      : a51e34c0393849278619a4d91df5cdfe
Id           : https://akv-iiscert-jpe.vault.azure.net:443/secrets/wildcard-kedamatech386b3521-3256-4f32-b716-4ec7e5703
               ef5/a51e34c0393849278619a4d91df5cdfe
Enabled      : True
Expires      : 1/21/2027 3:41:51 AM
Not Before   : 1/21/2026 3:41:51 AM
Created      : 1/21/2026 3:41:57 AM
Updated      : 1/21/2026 3:41:57 AM
Content Type : application/x-pkcs12
Tags         : Name              Value


               CertificateState  Ready


               CertificateId     /subscriptions/b957570e-6156-44f9-b1e5-22d285da0dc0/resourceGroups/20260121-appservcer
               t-on-vm/providers/Microsoft.CertificateRegistration/certificateOrders/wildcard-kedamatech/certificates/w
               ildcard-kedamatech
               SerialNumber      55BB98D96CED0002


‚ë°„Éó„É¨„Éº„É≥„ÉÜ„Ç≠„Çπ„Éà„ÅßÂèñÂæó„ÅÆ‰∏ä pfx „Ç≥„É≥„Éê„Éº„Éà
$b64 = Get-AzKeyVaultSecret -VaultName $vaultName -Name $secretName -AsPlainText
$b64.Substring(0,20)   # ÂÖàÈ†≠„Å†„ÅëÁ¢∫Ë™çÔºàÈï∑„ÅÑ„ÅÆ„ÅßÔºâ

$pfxPath = "C:\temp\appservicecert.pfx"

$b64 = ($b64 -replace '\s','')
[IO.File]::WriteAllBytes($pfxPath, [Convert]::FromBase64String($b64))

Import-PfxCertificate -FilePath $pfxPath -CertStoreLocation Cert:\LocalMachine\My

<Âá∫Âäõ>
PS C:\Windows\system32> $pfxPath = "C:\temp\appservicecert.pfx"
PS C:\Windows\system32> $b64 = ($b64 -replace '\s','')
PS C:\Windows\system32> [IO.File]::WriteAllBytes($pfxPath, [Convert]::FromBase64String($b64))
PS C:\Windows\system32> Import-PfxCertificate -FilePath $pfxPath -CertStoreLocation Cert:\LocalMachin\My
   PSParentPath: Microsoft.PowerShell.Security\Certificate::LocalMachine\My
Thumbprint                                Subject
----------                                -------
A45E272AC742990C4BEAD8375981D4210DB34166  CN=*.kedamatech.com

‚ë¢„Éê„Ç§„É≥„Éá„Ç£„É≥„Ç∞„ÅÆÂÆüË°å
PS C:\Windows\system32> Import-Module WebAdministration
PS C:\Windows\system32> # „Çµ„Ç§„ÉàÂêç„Éª„Éõ„Çπ„ÉàÂêç„ÅØÈÅ©ÂÆúÂ§âÊõ¥
PS C:\Windows\system32> New-WebBinding `
>>   -Name "Default Web Site" `
>>   -Protocol https `
>>   -Port 443 `
>>   -HostHeader "home.kedamatech.com"

Home.kedamatech.com „Çí VM IP „Å´Ëß£Ê±∫„Åô„Çã„É¨„Ç≥„Éº„Éâ„ÇíËøΩÂä†„Åó„Å¶„Åä„Åè


‚òÖ„ÅÇ„Åæ„Çä„ÅÜ„Åæ„Åè„ÅÑ„Åã„Å™„ÅÑ„ÅÆ„Åß„ÄÅIIS  „ÅÆ GUI „Åß„ÇÑ„Çã
Ë®ºÊòéÊõ∏„ÅÆ„Ç§„É≥„Éù„Éº„Éà
IIS „Å´ÂÖ¨ÁöÑË®ºÊòéÊõ∏„Çí„Éê„Ç§„É≥„Éâ„Åó„Å¶ Â§ñÈÉ®ÂÖ¨Èñã„Åô„Çã #Web - Qiita




„Éê„Ç§„É≥„Éá„Ç£„É≥„Ç∞„ÅÆËøΩÂä†


Â§ñÈÉ®„Åã„Çâ https:// „Åß„Ç¢„ÇØ„Çª„Çπ„Åô„Çã„Å®„Åç„Å°„Çì„Å®‰øùË≠∑„Åï„Çå„Å¶„ÅÑ„Çã


IIS „ÅÆ„Äå„Éê„Ç§„É≥„Éá„Ç£„É≥„Ç∞„Äç„Å®„ÅØ‰Ωï„Åã
IIS „ÅÆ BindingÔºà„Éê„Ç§„É≥„Éá„Ç£„É≥„Ç∞Ôºâ „ÅØ„ÄÅ
    „Äå„Åì„ÅÆ Web „Çµ„Ç§„Éà„ÅØ„ÄÅ„Å©„ÅÆ IP / „Éù„Éº„Éà / „Éõ„Çπ„ÉàÂêç / „Éó„É≠„Éà„Ç≥„É´„ÅßÈÄö‰ø°„ÇíÂèó„Åë‰ªò„Åë„Çã„Åã„Äç
„ÇíÂÆöÁæ©„Åô„ÇãË®≠ÂÆö„Åß„Åô„ÄÇ
HTTPS „ÅÆÂ†¥Âêà„ÅØ„ÄÅ„Åì„Çå„Å´ „Å©„ÅÆ SSL/TLS Ë®ºÊòéÊõ∏„Çí‰Ωø„ÅÜ„Åã „ÅåËøΩÂä†„Åï„Çå„Åæ„Åô„ÄÇ

„Éº„Éº„Éº„Éº„Éº„Éº„Éº„Éº„Éº„Éº„Éº„Éº„Éº„Éº„Éº„Éº„Éº„Éº„Éº„Éº„Éº„Éº„Éº
    4. Ë®ºÊòéÊõ∏„ÅÆËá™ÂãïÊõ¥Êñ∞„Å®Ëá™Âãï„Éê„Ç§„É≥„Éâ

Https „ÅÆËøΩÂä†„Å®„Éê„Ç§„É≥„Éá„Ç£„É≥„Ç∞„Åå„Åß„Åç„Åü„ÅÆ„Åß„ÄÅË®ºÊòéÊõ∏Êõ¥Êñ∞ÊôÇ„ÅÆËá™ÂãïÂèçÊò†„Çí„ÇÑ„Çã

ÂâçËø∞„ÅÆ https://learn.microsoft.com/ja-jp/azure/virtual-machines/extensions/key-vault-windows „ÅØ„ÄÅv3.0‰ª•Èôç„Åã„ÇâË®ºÊòéÊõ∏„ÇíÁâπÂÆö„ÅÆ„Éë„Çπ„Å´DL„Åô„Çã„Å†„Åë„Åß„ÅØ„Å™„Åè„ÄÅIIS „Å®„ÅÆ„Éê„Ç§„É≥„ÉâÊ©üËÉΩ„ÇÇËøΩÂä†„Åï„Çå„Åü„ÄÇ
„Åì„Çå„Å´„Çà„Å£„Å¶„ÄÅÂÆåÂÖ®Ëá™ÂãïÂåñ„Åå„Åß„Åç„ÇãÔºà‰ª•Ââç„ÅØ„ÄÅ„Éê„Ç§„É≥„Éâ„ÅØÊâã‰ΩúÊ•≠„Å†„Å£„ÅüÔºâ

„Åü„Å†„Åó„ÄÅWindows Serv 2019 ‰ª•Èôç„ÅåÂøÖË¶Å„Å™„Å©„ÅÆÊù°‰ª∂„Åå„ÅÇ„Çã


Êã°ÂºµÊ©üËÉΩ„ÅÆ„Ç§„É≥„Çπ„Éà„Éº„É´
Windows Áî®„ÅÆ Azure Key Vault VM Êã°ÂºµÊ©üËÉΩ - Azure Virtual Machines | Microsoft Learn



Êã°ÂºµÊ©üËÉΩ„ÅßÊåáÂÆö„Åô„Çã„Ç¢„Ç´„Ç¶„É≥„ÉàÂêç„ÅÆÂèñÂæó
„Åì„Åì„Åß„ÅØ„ÄÅApplicationPoolIdentity „Å®„Å™„Å£„Å¶„ÅÑ„Çã


msiClientId „Å´„ÅØ„ÄÅ„Éû„Éç„Éº„Ç∏„Éâ ID „ÅÆ„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ID„ÇíÂÖ•„Çå„Çã
az vm identity show --name vmwins2025-iis-jpe --resource-group 20260121-appservcert-on-vm
{
  "principalId": "794e1211-23bb-4ccb-aeed-3085ece241c7",
  "tenantId": "5dcb0955-58b3-4f7f-9faf-a50829fe5c72",
  "type": "SystemAssigned",
  "userAssignedIdentities": null
}

‰ªäÂõû„ÅØ„Ç∑„Çπ„ÉÜ„É†Ââ≤„ÇäÂΩì„Å¶„Éû„Éç„Éº„Ç∏„ÉâID„Å™„ÅÆ„Åß„ÄÅauthenticationSettings: Ëá™‰ΩìÁúÅÁï•ÂèØËÉΩ„Çâ„Åó„ÅÑ„ÄÇ

„Å®„ÅÑ„ÅÜ„Åì„Å®„ÅßË®≠ÂÆö„Éï„Ç°„Ç§„É´„ÅØ‰ª•‰∏ã

{   
        "secretsManagementSettings": {
          "pollingIntervalInS": "3600",
          "linkOnRenewal": true,
          "observedCertificates": [
            {
                "url": "https://akv-iiscert-jpe.vault.azure.net/secrets/wildcard-kedamatech386b3521-3256-4f32-b716-4ec7e5703ef5",
                "certificateStoreName": "MY",
                "certificateStoreLocation": "LocalMachine",
                "accounts": [
                    "ApplicationPoolIdentity"
                ]
            }]
        }
     }




‰∏äË®ò„ÄÅpollingIntervalIns „ÅØ‰Ωø„Åà„Å™„Åè„Å™„Å£„Åü„Çâ„Åó„Åè„ÄÅÂâäÈô§„Åó„Å¶‰ª•‰∏ã„ÅÆ„Çà„ÅÜ„Å´„Åô„ÇãÔºà‚òÖIssue‰∏ä„Åí„Çã„ÅãÔºâ


{
    "secretsManagementSettings": {
        "linkOnRenewal": true,
        "observedCertificates": [
            {
                "url": "https://akv-iiscert-jpe.vault.azure.net/secrets/wildcard-kedamatech386b3521-3256-4f32-b716-4ec7e5703ef5",
                "certificateStoreName": "MY",
                "certificateStoreLocation": "LocalMachine",
                "accounts": [
                    "ApplicationPoolIdentity"
                ]
            }
        ]
    }
}

linkOnRenewal „ÇÇ„ÅÑ„Çâ„Å™„Åè„Å™„Å£„Åü„Çâ„Åó„ÅÑ

{
    "secretsManagementSettings": {
        "observedCertificates": [
            {
                "url": "https://akv-iiscert-jpe.vault.azure.net/secrets/wildcard-kedamatech386b3521-3256-4f32-b716-4ec7e5703ef5",
                "certificateStoreName": "MY",
                "certificateStoreLocation": "LocalMachine",
                "accounts": [
                    "ApplicationPoolIdentity"
                ]
            }
        ]
    }
}

„Åì„ÅÜ„Å™„Å£„ÅüÔΩó


{
    "secretsManagementSettings": {
        "observedCertificates": [
            {
                "url": "https://akv-iiscert-jpe.vault.azure.net/secrets/wildcard-kedamatech386b3521-3256-4f32-b716-4ec7e5703ef5",
                "certificateStoreName": "MY",
                "certificateStoreLocation": "LocalMachine",
                "accounts": [
                    "ApplicationPoolIdentity"
                ]
            }
        ]
    }
}


„Åù„Åó„Å¶„ÄÅË®≠ÂÆö„Ç≥„Éû„É≥„Éâ„ÅØ„Åì„Çì„Å™ÊÑü„Åò

az vm extension set --name "KeyVaultForWindows" --publisher Microsoft.Azure.KeyVault --resource-group "20260121-appservcert-on-vm" --vm-name "vmwins2025-iis-jpe" --settings "@settings.json"

ÁµêÊßãÊôÇÈñì„Åã„Åã„Çã„Å£„ÅΩ„ÅÑ

„Ç¢„Ç´„Ç¶„É≥„Éà„ÅÆÊåáÂÆö„ÅåÊÇ™„Åè„ÄÅ„Ç®„É©„Éº„ÅßÁµÇ‰∫Ü
„Åì„ÅÆ„Çà„ÅÜ„Å´„ÄÅApplicationPoolIdentity„ÅßÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„ÄÅ‰ª•‰∏ã„ÅÆÂΩ¢Âºè„ÅßÊåáÂÆö„Åô„Çã„Çâ„Åó„ÅÑ


IIS APPPOOL\DefaultAppPool

ÊúÄÁµÇÁöÑ„Å´‰ª•‰∏ã


{
    "secretsManagementSettings": {
        "observedCertificates": [
            {
                "url": "https://akv-iiscert-jpe.vault.azure.net/secrets/wildcard-kedamatech386b3521-3256-4f32-b716-4ec7e5703ef5",
                "certificateStoreName": "MY",
                "certificateStoreLocation": "LocalMachine",
                "accounts": [
                    "IIS APPPOOL\\DefaultAppPool"
                ]
            }
        ]
    }
}

JSON „Åß„ÅØ„ÄÅ„Éê„ÉÉ„ÇØ„Çπ„É©„ÉÉ„Ç∑„É•„Åå„Ç®„Çπ„Ç±„Éº„ÉóÊñáÂ≠ó„ÅÆ„Åü„ÇÅ„ÄÅ2ÈÄ£„ÅßÊõ∏„Åè

JSON „Çí‰øÆÊ≠£„Åó„Åü„ÇâÊàêÂäü

$ az vm extension set --name "KeyVaultForWindows" --publisher Microsoft.Azure.KeyVault --resource-group "20260121-appservcert-on-vm" --vm-name "vmwins2025-iis-jpe" --settings "@settings.json"
{
  "autoUpgradeMinorVersion": true,
  "id": "/subscriptions/b957570e-6156-44f9-b1e5-22d285da0dc0/resourceGroups/20260121-appservcert-on-vm/providers/Microsoft.Compute/virtualMachines/vmwins2025-iis-jpe/extensions/KeyVaultForWindows",
  "location": "japaneast",
  "name": "KeyVaultForWindows",
  "provisioningState": "Succeeded",
  "publisher": "Microsoft.Azure.KeyVault",
  "resourceGroup": "20260121-appservcert-on-vm",
  "settings": {
    "secretsManagementSettings": {
      "observedCertificates": [
        {
          "accounts": [
            "IIS APPPOOL\\DefaultAppPool"
          ],
          "certificateStoreLocation": "LocalMachine",
          "certificateStoreName": "MY",
          "url": "https://akv-iiscert-jpe.vault.azure.net/secrets/wildcard-kedamatech386b3521-3256-4f32-b716-4ec7e5703ef5"
        }
      ]
    }
  },
  "type": "Microsoft.Compute/virtualMachines/extensions",
  "typeHandlerVersion": "4.0",
  "typePropertiesType": "KeyVaultForWindows"
}


„É≠„Ç∞„ÇíË¶ã„Çã„Å®ÈÅ©Áî®„Åï„Çå„Å¶„ÅÑ„Çã„Åì„Å®„ÅåÂàÜ„Åã„Çã
```
>Get-Content "C:\WindowsAzure\Logs\Plugins\Microsoft.Azure.KeyVault.KeyVaultForWindows\*\akvvm_service_*.log" -Tail 100
26-01-21 09:25:44: <info> [WindowsCertificateStore]   Certificate chain validation successful
2026-01-21 09:25:44: <debug> [WindowsCertificateStore]  installing certificate..
2026-01-21 09:25:44: <debug> [WindowsCertificateStore]  finding predecessors for model certificate by SAN..
2026-01-21 09:25:44: <info> [WindowsCertificateStore]   Certificate will attempt to use KeyProtection
2026-01-21 09:25:44: <info> [WindowsCertificateStore]   Importing the Intermediate CA: Go Daddy Secure Certificate Authority - G2
2026-01-21 09:25:44: <info> [WindowsCertificateStore]   Certificate private key confirmed to have been successfully saved to keyguard
2026-01-21 09:25:44: <info> [WindowsCertificateStore]   certificate installed
2026-01-21 09:25:44: <info> [WindowsCertificateStore]   Installed 'wildcard-kedamatech386b3521-3256-4f32-b716-4ec7e5703ef5'; most recent version is '0988a8db7e0f497d9f1d071fe205260c'; issuer of the cert is 'Go Daddy Secure Certificate Authority - G2'; subject is '*.kedamatech.comkedamatech.com'; the thumbprint is '19E7BEB8D8EAFA0A59794A8D7C4285516B28C5462FBD699EC1D733DE35853E1A'
2026-01-21 09:25:44: <debug> [WindowsCertificateStore]  finding predecessors for model certificate by SAN..
2026-01-21 09:25:44: <info> [WindowsCertificateStore]   This new certificate CertificateName: 'wildcard-kedamatech386b3521-3256-4f32-b716-4ec7e5703ef5'; with thumbprint: '19E7BEB8D8EAFA0A59794A8D7C4285516B28C5462FBD699EC1D733DE35853E1A'; replaced certificate with thumbprint: '9681710C431A6D467B4A7BE9830221C217B940DF87E60DF03F25145902542ECA'
2026-01-21 09:25:44: <info> [WindowsCertificateStore]   Certificate private key confirmed to have been successfully saved to keyguard
2026-01-21 09:25:44: <info> [WindowsCertificateStore]   Adding ACL to CNG key.
2026-01-21 09:25:44: <debug> [WindowsCertificateStore]  Successfully applied ACL to CNG key.
2026-01-21 09:25:44: <debug> [CertificateManager]       Added ACL to certificate: https://akv-iiscert-jpe.vault.azure.net/secrets/wildcard-kedamatech386b3521-3256-4f32-b716-4ec7e5703ef5
2026-01-21 09:25:44: <info> [CertificateManager]        Completed refreshing observed certificates.
2026-01-21 09:25:44: <info> [CertificateManager]        Successfully started Key Vault extension service. 2026-01-21T09:25:44Z
2026-01-21 09:25:44: <info> [WindowsCertificateManager] Checking state of termination event with a timeout of 3450000

```


# 5. Êõ¥Êñ∞„ÅåÂèçÊò†„Åï„Çå„Çã„Åì„Å®„ÅÆÁ¢∫Ë™ç
AKV ‰∏ä„ÅßÊâãÂãïÊõ¥Êñ∞„Åó„Å¶„Åø„Å¶„ÄÅThumb „Å®„Åã„ÅåÊõ¥Êñ∞„Åï„Çå„Å¶„ÅÑ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç„Åô„Çã

ÁèæÁä∂Ôºö
Serial Number: 009dd10046d30c0ab9

Thumbprint(SHA-1): 566a5ad1de774e1de79a8c6b7669fdc6a3c62bc4



> netsh http show sslcert

SSL Certificate bindings:
-------------------------



    IP:port                      : 0.0.0.0:443
    Certificate Hash             : 566a5ad1de774e1de79a8c6b7669fdc6a3c62bc4
    Application ID               : {4dc3e181-e14b-4a21-b022-59fc669b0914}
    Certificate Store Name       : My
    Verify Client Certificate Revocation : Enabled
    Verify Revocation Using Cached Client Certificate Only : Disabled
    Use Revocation Freshness Time : Disabled
    Verify Revocation Using Cached URLs Only : Disabled
    Disable Authority Info Access : Disabled
    Usage Check                  : Enabled
    Revocation Freshness Time    : 0
    URL Retrieval Timeout        : 0
    Ctl Identifier               : (null)
    Ctl Store Name               : (null)
    DS Mapper Usage              : Disabled
    Negotiate Client Certificate : Disabled
    Reject Connections           : Disabled
    Disable HTTP2                : Not Set
    Disable QUIC                 : Not Set
    Disable TLS1.2               : Not Set
    Disable TLS1.3               : Not Set
    Disable OCSP Stapling        : Not Set
    Enable Token Binding         : Not Set
    Log Extended Events          : Not Set
    Disable Legacy TLS Versions  : Not Set
    Enable Session Ticket        : Not Set
    Disable Session ID           : Not Set
    Enable Caching Client Hello  : Not Set
 Extended Property:
    PropertyId                   : 0
    Receive Window               : 1048576
 Extended Property:
    PropertyId                   : 1
    Max Settings Per Frame       : 2796202
    Max Settings Per Minute      : 4294967295
 Extended Property:
    PropertyId                   : 2
    Send Buffering Flags         : 0x0
    Aggressive ICW               : Not Set
    Max Send Buffer Size         : 4294967295
    Max Concurrent Client Streams: 100
    Max Receive Buffer Size      : 0
    Decrypt On SSPI Thread       : Set
 Extended Property:
    PropertyId                   : 3
    TLS Restrictions             : Not Set
 Extended Property:
    PropertyId                   : 4
    Error Headers                : Not Set
    Status Code                  : 0
 Extended Property:
    PropertyId                   : 6
    Cert Config                  : Not Set

AKV „ÅÆ secret „ÅßÊñ∞„Åó„ÅÑ„Éê„Éº„Ç∏„Éß„É≥„Çí‰ΩúÊàê
= ÊâãÂãï„Å†„Å®‰Ωú„Çå„Å™„ÅÑ„ÅÆ„Åß„ÄÅAppService Ë®ºÊòéÊõ∏ÁµåÁî±„ÅßÊõ¥Êñ∞„Åô„Çã
= Ê§úË®º„ÅÆ„Åü„ÇÅ„ÄÅÁÑ°ÁêÜ„ÇÑ„Çä rekey „Å´„Çà„Å£„Å¶Êõ¥Êñ∞





Êñ∞„Åó„ÅÑ„Éê„Éº„Ç∏„Éß„É≥„ÅÆË®ºÊòéÊõ∏„Åå‰ΩúÊàê„Åï„Çå„Çã






Azure ÂÅ¥„ÅÆË®ºÊòéÊõ∏„ÅÆÊúÄÊñ∞„Éê„Éº„Ç∏„Éß„É≥„ÅÆÊÉÖÂ†±Á¢∫Ë™ç
ÊØîËºÉ„Å´‰Ωø„Åà„ÇãÊÉÖÂ†±„ÅØ„ÄÅ„Çø„Ç∞„Å®„Åó„Å¶‰ªò‰∏é„Åï„Çå„Å¶„ÅÑ„Çã„ÅÆ„Åß‰ª•‰∏ã„ÅÆ„Ç≥„Éû„É≥„Éâ„ÅßÂèñÂæóÂèØËÉΩÔºà„Éê„Éº„Ç∏„Éß„É≥ÊåáÂÆö„Åó„Å™„ÅÑÂ†¥Âêà„ÄÅÊúÄÊñ∞„Éê„Éº„Ç∏„Éß„É≥„ÇíËøî„ÅôÔºâ

```
PS > az keyvault secret show --vault-name akv-iiscert-jpe --name wildcard-kedamatech386b3521-3256-4f32-b716-4ec7e5703ef5 --query "{tags:tags, id:id}" -o yaml 
id: https://akv-iiscert-jpe.vault.azure.net/secrets/wildcard-kedamatech386b3521-3256-4f32-b716-4ec7e5703ef5/7f10ffdad3864686bf0771fc0e5c1db8
tags:
  CertificateId: /subscriptions/b957570e-6156-44f9-b1e5-22d285da0dc0/resourceGroups/20260121-appservcert-on-vm/providers/Microsoft.CertificateRegistration/certificateOrders/wildcard-kedamatech/certificates/wildcard-kedamatech
  CertificateState: Ready
  SerialNumber: 41CEFDA89335AEB5
  Thumbprint: 4BA1B94F3D2E242907AE22A656C48A5D75A520AC

```
„Éù„Éº„É™„É≥„Ç∞„Åï„Çå„Çã„Åæ„Åß 1h „Åª„Å©ÂæÖ„Å§


„É≠„Ç∞„ÇíË¶ã„Çã„Å®„ÄÅÁ¢∫„Åã„Å´ÂâçÂõû„ÅÆ„É≠„Ç∞„ÅÆ„Å°„Çá„ÅÜ„Å©1hÂæå„Å´„Éù„Éº„É™„É≥„Ç∞„ÅåËµ∞„Çä„ÄÅÊúÄÊñ∞Áâà„ÅÆË®ºÊòéÊõ∏„Çí„Ç§„É≥„Çπ„Éà„Éº„É´„Åó„Å¶„Åè„Çå„Å¶„ÅÑ„Çã

```
PS C:\Windows\system32> Get-Content "C:\WindowsAzure\Logs\Plugins\Microsoft.Azure.KeyVault.KeyVaultForWindows\*\akvvm_service_*.log" -Tail 100

2026-01-21 07:12:24: <info> [WindowsCertificateStore]   certificate installed
2026-01-21 07:12:24: <info> [WindowsCertificateStore]   Installed 'wildcard-kedamatech386b3521-3256-4f32-b716-4ec7e5703ef5'; most recent version is '46df5ebc1481493ebdd23f3353de92a6'; issuer of the cert is 'Go Daddy Secure Certificate Authority - G2'; subject is '*.kedamatech.comkedamatech.com'; the thumbprint is '9681710C431A6D467B4A7BE9830221C217B940DF87E60DF03F25145902542ECA'
2026-01-21 07:12:24: <debug> [WindowsCertificateStore]  finding predecessors for model certificate by SAN..
2026-01-21 07:12:24: <info> [WindowsCertificateStore]   This new certificate CertificateName: 'wildcard-kedamatech386b3521-3256-4f32-b716-4ec7e5703ef5'; with thumbprint: '9681710C431A6D467B4A7BE9830221C217B940DF87E60DF03F25145902542ECA'; replaced certificate with thumbprint: '57C81DE31EB642F1D0C0F92789FC4FC689D1AB253DFB11F8F5239BAA8B752810'
2026-01-21 07:12:24: <info> [WindowsCertificateStore]   Certificate private key confirmed to have been successfully saved to keyguard
2026-01-21 07:12:24: <info> [WindowsCertificateStore]   Adding ACL to CNG key.
2026-01-21 07:12:24: <debug> [WindowsCertificateStore]  Successfully applied ACL to CNG key.
2026-01-21 07:12:24: <debug> [CertificateManager]       Added ACL to certificate: https://akv-iiscert-jpe.vault.azure.net/secrets/wildcard-kedamatech386b3521-3256-4f32-b716-4ec7e5703ef5
2026-01-21 07:12:24: <info> [CertificateManager]        Completed refreshing observed certificates.
2026-01-21 07:12:24: <info> [WindowsCertificateManager] Checking state of termination event with a timeout of 3823000
2026-01-21 08:16:07: <debug> [WindowsCertificateManager]        TryWaitForContinuation: Wait returned WAIT_TIMEOUT..
2026-01-21 08:16:07: <debug> [CertificateManager]       POLLING_RANDOMIZATION_RANGE_SEC: 300, RandomMS: 63000
2026-01-21 08:16:07: <info> [CertificateManager]        Starting refreshing observed certificates...
2026-01-21 08:16:07: <info> [CertificateManager]        Beginning refresh for: https://akv-iiscert-jpe.vault.azure.net/secrets/wildcard-kedamatech386b3521-3256-4f32-b716-4ec7e5703ef5
2026-01-21 08:16:07: <debug> [AuthClient]       AcquireTokenCallback invoked
2026-01-21 08:16:07: <debug> [AuthClient]       acquiring token
2026-01-21 08:16:07: <info> [CertificateManager]        retrieved 'https://akv-iiscert-jpe.vault.azure.net/secrets/wildcard-kedamatech386b3521-3256-4f32-b716-4ec7e5703ef5'; the retrieved version is 'https://akv-iiscert-jpe.vault.azure.net/secrets/wildcard-kedamatech386b3521-3256-4f32-b716-4ec7e5703ef5/7f10ffdad3864686bf0771fc0e5c1db8'; the previous version is ''; the ContentType is 'application/x-pkcs12'
2026-01-21 08:16:07: <info> [WindowsCertificateStore]   attempting to open store 'LocalMachine\MY'
2026-01-21 08:16:07: <debug> [WindowsCertificateStore]  opening the 'LocalMachine' store..
2026-01-21 08:16:07: <debug> [WindowsCertificateStore]  store opened successfully.
2026-01-21 08:16:07: <info> [CertificateManager]        Installing certificate because it does not exist in the store.
2026-01-21 08:16:07: <info> [CertificateManager]        Installing 'https://akv-iiscert-jpe.vault.azure.net/secrets/wildcard-kedamatech386b3521-3256-4f32-b716-4ec7e5703ef5'
2026-01-21 08:16:07: <debug> [WindowsCertificateStore]  Validated accounts for ACL: IIS APPPOOL\DefaultAppPool
2026-01-21 08:16:07: <info> [WindowsCertificateStore]   Validating certificate chain...
2026-01-21 08:16:08: <info> [WindowsCertificateStore]   Certificate chain validation successful
2026-01-21 08:16:08: <debug> [WindowsCertificateStore]  installing certificate..
2026-01-21 08:16:08: <debug> [WindowsCertificateStore]  finding predecessors for model certificate by SAN..
2026-01-21 08:16:08: <info> [WindowsCertificateStore]   Certificate will attempt to use KeyProtection
2026-01-21 08:16:08: <info> [WindowsCertificateStore]   Importing the Intermediate CA: Go Daddy Secure Certificate Authority - G2
2026-01-21 08:16:08: <info> [WindowsCertificateStore]   Certificate private key confirmed to have been successfully saved to keyguard
2026-01-21 08:16:08: <info> [WindowsCertificateStore]   certificate installed
2026-01-21 08:16:08: <info> [WindowsCertificateStore]   Installed 'wildcard-kedamatech386b3521-3256-4f32-b716-4ec7e5703ef5'; most recent version is '7f10ffdad3864686bf0771fc0e5c1db8'; issuer of the cert is 'Go Daddy Secure Certificate Authority - G2'; subject is '*.kedamatech.comkedamatech.com'; the thumbprint is '104F4BDF9D9307EB11C4E52E35E517E5EF96F527F4C5B8C76A5A90E66CC92B9E'
2026-01-21 08:16:08: <debug> [WindowsCertificateStore]  finding predecessors for model certificate by SAN..
2026-01-21 08:16:08: <info> [WindowsCertificateStore]   This new certificate CertificateName: 'wildcard-kedamatech386b3521-3256-4f32-b716-4ec7e5703ef5'; with thumbprint: '104F4BDF9D9307EB11C4E52E35E517E5EF96F527F4C5B8C76A5A90E66CC92B9E'; replaced certificate with thumbprint: '9681710C431A6D467B4A7BE9830221C217B940DF87E60DF03F25145902542ECA'
2026-01-21 08:16:08: <info> [WindowsCertificateStore]   Certificate private key confirmed to have been successfully saved to keyguard
2026-01-21 08:16:08: <info> [WindowsCertificateStore]   Adding ACL to CNG key.
2026-01-21 08:16:08: <debug> [WindowsCertificateStore]  Successfully applied ACL to CNG key.
2026-01-21 08:16:08: <debug> [CertificateManager]       Added ACL to certificate: https://akv-iiscert-jpe.vault.azure.net/secrets/wildcard-kedamatech386b3521-3256-4f32-b716-4ec7e5703ef5
2026-01-21 08:16:08: <info> [CertificateManager]        Completed refreshing observed certificates.
2026-01-21 08:16:08: <info> [WindowsCertificateManager] Checking state of termination event with a timeout of 3663000

```



```

Êã°ÂºµÊ©üËÉΩ„ÅÆ„Ç§„É≥„Çπ„Éà„Éº„É´„ÅÆ„Çø„Ç§„Éü„É≥„Ç∞„Åß„ÄÅÊòéÁ§∫ÁöÑ„Å´„Éê„Éº„Ç∏„Éß„É≥3.0„ÇíÊåáÂÆö
„Åù„Çå„Å´Âêà„Çè„Åõ„Å¶„ÄÅÁä∂ÊÖã„ÇíÂü∫„Å´Êàª„Åô„Åü„ÇÅ„ÄÅIIS Manager ÂÅ¥„ÅÆ Auto Update „ÅØ Disable „Å´Êàª„Åô

‰ΩøÁî®ÂèØËÉΩ„Å™„Éê„Éº„Ç∏„Éß„É≥„ÅØ‰ª•‰∏ã„ÅßÁ¢∫Ë™ç
> az vm extension image list-versions --publisher Microsoft.Azure.KeyVault --name KeyVaultForWindows --location japaneast -o table
Location    Name
----------  ------------
japaneast   0.1.0.717
japaneast   0.2.0.898
japaneast   0.3.907.5
japaneast   1.0.1076.8
japaneast   1.0.1082.9
japaneast   1.0.1114.10
japaneast   1.0.1172.11
japaneast   1.0.1201.12
japaneast   1.0.1253.13
japaneast   1.0.1258.14
japaneast   1.0.1363.13
japaneast   1.0.1409.21
japaneast   1.0.921.6
japaneast   3.0.2138.56
japaneast   3.1.2195.61
japaneast   3.2.2398.77
japaneast   3.3.2607.99
japaneast   3.6.3145.208
japaneast   4.0.3299.265

3.0 „ÇíÊåáÂÆö„Åô„Çã„Åì„Å®„Åß„ÄÅ‰ª•‰∏ã„ÅÆ„Éó„É≠„Éë„ÉÜ„Ç£„ÇíÂê´„ÇÅ„Çâ„Çå„Çã

{
    "secretsManagementSettings": {
        "pollingIntervalInS": "3600",
        "linkOnRenewal": true,
        "observedCertificates": [
            {
                "url": "https://akv-iiscert-jpe.vault.azure.net/secrets/wildcard-kedamatech386b3521-3256-4f32-b716-4ec7e5703ef5",
                "certificateStoreName": "MY",
                "certificateStoreLocation": "LocalMachine",
                "accounts": [
                    "IIS APPPOOL\\DefaultAppPool"
                ]
            }
        ]
    }
}


az vm extension set --name "KeyVaultForWindows" --publisher Microsoft.Azure.KeyVault --resource-group "20260121-appservcert-on-vm" --vm-name "vmwins2025-iis-jpe" --settings "@settings.json" --version "3.0" --no-auto-upgrade-minor-version

{
  "autoUpgradeMinorVersion": false,
  "id": "/subscriptions/b957570e-6156-44f9-b1e5-22d285da0dc0/resourceGroups/20260121-appservcert-on-vm/providers/Microsoft.Compute/virtualMachines/vmwins2025-iis-jpe/extensions/KeyVaultForWindows",
  "location": "japaneast",
  "name": "KeyVaultForWindows",
  "provisioningState": "Succeeded",
  "publisher": "Microsoft.Azure.KeyVault",
  "resourceGroup": "20260121-appservcert-on-vm",
  "settings": {
    "secretsManagementSettings": {
      "linkOnRenewal": true,
      "observedCertificates": [
        {
          "accounts": [
            "IIS APPPOOL\\DefaultAppPool"
          ],
          "certificateStoreLocation": "LocalMachine",
          "certificateStoreName": "MY",
          "url": "https://akv-iiscert-jpe.vault.azure.net/secrets/wildcard-kedamatech386b3521-3256-4f32-b716-4ec7e5703ef5"
        }
      ],
      "pollingIntervalInS": "3600"
    }
  },
  "type": "Microsoft.Compute/virtualMachines/extensions",
  "typeHandlerVersion": "3.0",
  "typePropertiesType": "KeyVaultForWindows"
}

> az vm extension list --resource-group "20260121-appservcert-on-vm" --vm-name
 "vmwins2025-iis-jpe" -o table
Name                ProvisioningState    Publisher                                Version    AutoUpgradeMinorVersion
------------------  -------------------  ---------------------------------------  ---------  -------------------------
KeyVaultForWindows  Succeeded            Microsoft.Azure.KeyVault                 3.0        False
MDE.Windows         Succeeded            Microsoft.Azure.AzureDefenderForServers  1.0        True

„Åì„Çå„Åß„ÄÅ3.0 „Åß„Ç§„É≥„Çπ„Éà„Éº„É´„Åå„Åß„Åç„Åü„ÅÆ„Åß„ÄÅÂãï„Åè„ÅØ„Åö„ÄÇ
Êã°ÂºµÊ©üËÉΩ„Ç§„É≥„Çπ„Éà„Éº„É´ÊôÇÁÇπ„Åß„ÅÆ„É≠„Ç∞ÔºàÂèÇËÄÉ„Åæ„Åß„Å´Ôºâ
PS C:\Windows\system32> Get-Content "C:\WindowsAzure\Logs\Plugins\Microsoft.Azure.KeyVault.KeyVaultForWindows\3.0.2138.56\akvvm_service_2026-01-21_11-11-26.1.log"
2026-01-21 11:11:26: <debug> [Global]   logFolder: C:\WindowsAzure\Logs\Plugins\Microsoft.Azure.KeyVault.KeyVaultForWindows\3.0.2138.56
2026-01-21 11:11:26: <info> [VMExtension]       Starting extension
2026-01-21 11:11:26: <debug> [CertificateManagementConfiguration]       Found v3.x configuration with ACL
2026-01-21 11:11:26: <info> [CertificateManagementConfiguration]        Defaulting to MSI authentication.
2026-01-21 11:11:26: <info> [KVWinService]      Service Starting...
2026-01-21 11:11:26: <info> [WindowsCertificateManager] Setting up worker..
2026-01-21 11:11:26: <info> [WindowsCertificateManager] Worker setup: creating termination event..
2026-01-21 11:11:26: <info> [WindowsCertificateManager] Completed worker setup.
2026-01-21 11:11:26: <info> [CertificateManager]        Entering worker loop..
2026-01-21 11:11:26: <debug> [CertificateManager]       MIN_POLLING_INTERVAL_SEC: 1, RandomMS: -1000
2026-01-21 11:11:26: <info> [CertificateManager]        Starting refreshing observed certificates...
2026-01-21 11:11:26: <info> [CertificateManager]        Beginning refresh for: https://akv-iiscert-jpe.vault.azure.net/secrets/wildcard-kedamatech386b3521-3256-4f32-b716-4ec7e5703ef5
2026-01-21 11:11:26: <info> [KeyVaultClient]    Getting new auth challenge
2026-01-21 11:11:26: <debug> [AuthClient]       AcquireTokenCallback invoked
2026-01-21 11:11:26: <debug> [AuthClient]       acquiring token
2026-01-21 11:11:26: <debug> [MSIAuthClient]    acquiring token via MSI
2026-01-21 11:11:26: <debug> [MSIHttpClient]    MSI URL: http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&authority=https://login.microsoftonline.com/5dcb0955-58b3-4f7f-9faf-a50829fe5c72&resource=https://vault.azure.net
2026-01-21 11:11:26: <info> [CertificateManager]        retrieved 'https://akv-iiscert-jpe.vault.azure.net/secrets/wildcard-kedamatech386b3521-3256-4f32-b716-4ec7e5703ef5'; most recent version is 'https://akv-iiscert-jpe.vault.azure.net/secrets/wildcard-kedamatech386b3521-3256-4f32-b716-4ec7e5703ef5/0988a8db7e0f497d9f1d071fe205260c'; the ContentType is 'application/x-pkcs12'
2026-01-21 11:11:26: <info> [WindowsCertificateStore]   attempting to open store 'LocalMachine\MY'
2026-01-21 11:11:26: <debug> [WindowsCertificateStore]  opening the 'LocalMachine' store..
2026-01-21 11:11:26: <debug> [WindowsCertificateStore]  store opened successfully.
2026-01-21 11:11:26: <info> [CertificateManager]        Installing latest version of 'https://akv-iiscert-jpe.vault.azure.net/secrets/wildcard-kedamatech386b3521-3256-4f32-b716-4ec7e5703ef5'.
2026-01-21 11:11:26: <debug> [WindowsCertificateStore]  Validated accounts for ACL: IIS APPPOOL\DefaultAppPool
2026-01-21 11:11:26: <debug> [WindowsCertificateStore]  installing certificate..
2026-01-21 11:11:26: <debug> [WindowsCertificateStore]  finding predecessors for model certificate by SAN..
2026-01-21 11:11:26: <debug> [WindowsCertificateStore]  certificate installed
2026-01-21 11:11:26: <info> [WindowsCertificateStore]   Adding ACL to CNG key.
2026-01-21 11:11:26: <debug> [WindowsCertificateStore]  Successfully applied ACL to CNG key.
2026-01-21 11:11:26: <debug> [CertificateManager]       Added ACL to certificate: https://akv-iiscert-jpe.vault.azure.net/secrets/wildcard-kedamatech386b3521-3256-4f32-b716-4ec7e5703ef5
2026-01-21 11:11:26: <info> [CertificateManager]        Completed refreshing observed certificates.
2026-01-21 11:11:26: <info> [CertificateManager]        Successfully started Key Vault extension service. 2026-01-21T11:11:26Z
2026-01-21 11:11:26: <info> [WindowsCertificateManager] Checking state of termination event with a timeout of 3599000

„ÇÇ„Å®„ÇÇ„Å®„Ç§„É≥„Çπ„Éà„Éº„É´„Åï„Çå„Å¶„ÅÑ„ÇãË®ºÊòéÊõ∏„Å® Key Vault ‰∏ä„ÅÆË®ºÊòéÊõ∏„Åå‰∏ÄËá¥„Åó„Å¶„ÅÑ„Çã„Åü„ÇÅ„ÄÅÁâπ„Å´ Renewal „Ç§„Éô„É≥„Éà„ÅØÁô∫Áîü„Åó„Å™„ÅÑ
ÔºûAppService Ë®ºÊòéÊõ∏„ÅÆÊñ∞„Åó„ÅÑ„Éê„Éº„Ç∏„Éß„É≥„ÅåËøΩÂä†„Åó„Å¶Âãï„Åç„ÇíË¶ã„Çã

<ÁèæÂú®„ÅÆË®ºÊòéÊõ∏„ÅÆÁä∂ÊÖã>

00cb3695fdd5fe17f2



328b316329c9ed0f2db147399085eca7fb98607f


PS C:\Windows\system32> netsh http show sslcert

SSL Certificate bindings:
-------------------------



    IP:port                      : 0.0.0.0:443
    Certificate Hash             : 328b316329c9ed0f2db147399085eca7fb98607f
    Application ID               : {4dc3e181-e14b-4a21-b022-59fc669b0914}
    Certificate Store Name       : My
    Verify Client Certificate Revocation : Enabled
    Verify Revocation Using Cached Client Certificate Only : Disabled
    Use Revocation Freshness Time : Disabled
    Verify Revocation Using Cached URLs Only : Disabled
    Disable Authority Info Access : Disabled
    Usage Check                  : Enabled
    Revocation Freshness Time    : 0
    URL Retrieval Timeout        : 0
    Ctl Identifier               : (null)
    Ctl Store Name               : (null)
    DS Mapper Usage              : Disabled
    Negotiate Client Certificate : Disabled
    Reject Connections           : Disabled
    Disable HTTP2                : Not Set
    Disable QUIC                 : Not Set
    Disable TLS1.2               : Not Set
    Disable TLS1.3               : Not Set
    Disable OCSP Stapling        : Not Set
    Enable Token Binding         : Not Set
    Log Extended Events          : Not Set
    Disable Legacy TLS Versions  : Not Set
    Enable Session Ticket        : Not Set
    Disable Session ID           : Not Set
    Enable Caching Client Hello  : Not Set
 Extended Property:
    PropertyId                   : 0
    Receive Window               : 1048576
 Extended Property:
    PropertyId                   : 1
    Max Settings Per Frame       : 2796202
    Max Settings Per Minute      : 4294967295
 Extended Property:
    PropertyId                   : 2
    Send Buffering Flags         : 0x0
    Aggressive ICW               : Not Set
    Max Send Buffer Size         : 4294967295
    Max Concurrent Client Streams: 100
    Max Receive Buffer Size      : 0
    Decrypt On SSPI Thread       : Set
 Extended Property:
    PropertyId                   : 3
    TLS Restrictions             : Not Set
 Extended Property:
    PropertyId                   : 4
    Error Headers                : Not Set
    Status Code                  : 0
 Extended Property:
    PropertyId                   : 6
    Cert Config                  : Not Set

App Service Ë®ºÊòéÊõ∏„ÅÆÊõ¥Êñ∞„ÇíÂÆüË°åÔºàRekeyÔºâ


App Service Ë®ºÊòéÊõ∏„ÅÆÊñ∞„Åó„ÅÑ„Éê„Éº„Ç∏„Éß„É≥„ÅåËøΩÂä†„Åï„Çå„Çã
Êóß„Éê„Éº„Ç∏„Éß„É≥Ôºö0988a8db7e0f497d9f1d071fe205260c
Êñ∞„Éê„Éº„Ç∏„Éß„É≥Ôºö88bd41a1fdf645bab4fd1f14e0162ca0

ÁÖßÂêà„Å´ÂøÖË¶Å„Å™ÊÉÖÂ†±„ÅØ„Çø„Ç∞„Å®„Åó„Å¶‰ªò‰∏é


Êñ∞„Éê„Éº„Ç∏„Éß„É≥„ÅÆÊÉÖÂ†±

> az keyvault secret show --vault-name akv-iiscert-jpe --name wildcard-kedamatech386b3521-3256-4f32-b716-4ec7e5703ef5 --query "{tags:tags, id:id}" -o yaml
id: https://akv-iiscert-jpe.vault.azure.net/secrets/wildcard-kedamatech386b3521-3256-4f32-b716-4ec7e5703ef5/88bd41a1fdf645bab4fd1f14e0162ca0
tags:
  CertificateId: /subscriptions/b957570e-6156-44f9-b1e5-22d285da0dc0/resourceGroups/20260121-appservcert-on-vm/providers/Microsoft.CertificateRegistration/certificateOrders/wildcard-kedamatech/certificates/wildcard-kedamatech
  CertificateState: Ready
  SerialNumber: 0B5922EF8E57B9FD
  Thumbprint: 6127E6E32019279687F7762E0AD08D8CA05C72A3

======Ê¨°„ÅÆ„Éù„Éº„É™„É≥„Ç∞„Åæ„Åß 1h ÂæÖ„Å§=====

IIS Manager ‰∏ä„ÅßË¶ã„Çã„Å®Ë®ºÊòéÊõ∏„ÅØÁ¢∫„Åã„Å´„Ç§„É≥„Çπ„Éà„Éº„É´„Åï„Çå„Å¶„ÅÑ„Çã„ÇÇ„ÅÆ„ÅÆ„ÄÅ„Éê„Ç§„É≥„Éá„Ç£„É≥„Ç∞„ÅØÂÖÉ„ÅÆ„Åæ„Åæ„Å†„Å£„Åü
„Å©„ÅÜ„ÇÑ„Çâ„ÄÅ„Åì„ÅÆ KV Êã°ÂºµÊ©üËÉΩ„ÅåÂÆüÊñΩ„Åô„Çã S-Biunding „ÅØ IIS „ÅÆ„É¨„Ç§„É§„Å®„ÅØÁï∞„Å™„Çã„ÇÇ„ÅÆ„Çâ„Åó„ÅÑ

„Å™„ÅÆ„Åß„ÄÅ„ÇÑ„ÅØ„Çä IIS „ÅÆÂÜç„Éê„Ç§„É≥„Éâ„ÇíË©¶„Åô
Ëá™Âãï„ÅßÂÜç„Éê„Ç§„É≥„Éâ„Åï„Çå„Å™„Åã„Å£„Åü„ÅÆ„Åß„ÄÅ
IIS 8.5 „Åß„ÅÆË®ºÊòéÊõ∏„ÅÆÂÜç„Éê„Ç§„É≥„Éâ | Microsoft Learn
„ÇíË©¶„Åô

Ëµ§Êû†ÈÉ®„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Å®„ÄÅDisable „Éú„Çø„É≥„Å´ÂÖ•„ÇåÊõø„Çè„Çã

‚òÖ„Åì„ÅÆÁä∂ÊÖã„Åß„ÄÅÁÑ°ÁêÜ„ÇÑ„Çä„Éù„Éº„É™„É≥„Ç∞„Çí„Ç≠„ÉÉ„ÇØ„Åô„Çã„Åü„ÇÅ„Å´„ÄÅÊã°ÂºµÊ©üËÉΩ„Å´ÂØæ„Åó„Å¶Âº∑Âà∂ÁöÑ„Å´„Ç¢„ÉÉ„Éó„Éá„Éº„Éà„Çí„Åã„Åë„Çã„Å®„ÄÅÁ¢∫„Åã„Å´„Éê„Ç§„É≥„Éá„Ç£„É≥„Ç∞„ÅåÊõ¥Êñ∞„Åï„Çå„ÅüÔºÅÔºÅÔºÅ
> az vm extension set --name "KeyVaultForWindows" --publisher Microsoft.Azure.KeyVault --resource-group "20260121-appservcert-on-vm" --vm-name "vmwins2025-iis-jpe" --settings "@settings.json" --version "3.0" --force-update
{
  "autoUpgradeMinorVersion": true,
  "forceUpdateTag": "708a151e-087a-45ba-b0a9-f124410355b7",
  "id": "/subscriptions/b957570e-6156-44f9-b1e5-22d285da0dc0/resourceGroups/20260121-appservcert-on-vm/providers/Microsoft.Compute/virtualMachines/vmwins2025-iis-jpe/extensions/KeyVaultForWindows",
  "location": "japaneast",
  "name": "KeyVaultForWindows",
  "provisioningState": "Succeeded",
  "publisher": "Microsoft.Azure.KeyVault",
  "resourceGroup": "20260121-appservcert-on-vm",
  "settings": {
    "secretsManagementSettings": {
      "linkOnRenewal": true,
      "observedCertificates": [
        {
          "accounts": [
            "IIS APPPOOL\\DefaultAppPool"
          ],
          "certificateStoreLocation": "LocalMachine",
          "certificateStoreName": "MY",
          "url": "https://akv-iiscert-jpe.vault.azure.net/secrets/wildcard-kedamatech386b3521-3256-4f32-b716-4ec7e5703ef5"
        }
      ],
      "pollingIntervalInS": "3600"
    }
  },
  "type": "Microsoft.Compute/virtualMachines/extensions",
  "typeHandlerVersion": "3.0",
  "typePropertiesType": "KeyVaultForWindows"
}

‚òÖ„Åü„Å†„Åó„ÄÅKVÊã°ÂºµÊ©üËÉΩ„ÅÆÈÄöÂ∏∏„ÅÆ„Éù„Éº„É™„É≥„Ç∞„Åß„ÇÇ IIS ÂÅ¥„Å´Ë™çË≠ò„Åï„Çå„Çã„Ç§„Éô„É≥„Éà„ÅåËµ∞„Çâ„Å™„ÅÑ„Å®„ÅÑ„Åë„Å™„ÅÑ„ÅÆ„Åß„ÄÅ„Åù„Çå„ÅåÁô∫Áîü„Åô„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç„Åô„Çã
„Ç§„Éô„É≥„Éà„ÅåÁô∫Áîü„Åó„Å¶„ÅÑ„Çã„Åã„ÅÆÁ¢∫Ë™çÊñπÊ≥ï



Get-WinEvent -LogName "Microsoft-Windows-CertificateServicesClient-Lifecycle-System/Operational" -MaxEvents 20 | 
  Select-Object TimeCreated, Id, Message | 
  Format-Table -Wrap


PS C:\Windows\system32> Get-WinEvent -LogName "Microsoft-Windows-CertificateServicesClient-Lifecycle-System/Operational" -MaxEvents 20 |
>>   Select-Object TimeCreated, Id, Message |
>>   Format-Table -Wrap

TimeCreated             Id Message
-----------             -- -------
1/21/2026 12:37:25 PM 1001 A certificate has been replaced. Please refer to the "Details" section for more information.
1/21/2026 12:37:25 PM 1006 A new certificate has been installed. Please refer to the "Details" section for more information.
1/21/2026 12:32:51 PM 1001 A certificate has been replaced. Please refer to the "Details" section for more information.
1/21/2026 12:32:51 PM 1006 A new certificate has been installed. Please refer to the "Details" section for more information.
1/21/2026 9:25:44 AM  1001 A certificate has been replaced. Please refer to the "Details" section for more information.
1/21/2026 9:25:44 AM  1006 A new certificate has been installed. Please refer to the "Details" section for more information.
1/21/2026 8:16:08 AM  1001 A certificate has been replaced. Please refer to the "Details" section for more information.
1/21/2026 8:16:08 AM  1006 A new certificate has been installed. Please refer to the "Details" section for more information.
1/21/2026 7:12:24 AM  1001 A certificate has been replaced. Please refer to the "Details" section for more information.
1/21/2026 7:12:24 AM  1006 A new certificate has been installed. Please refer to the "Details" section for more information.
1/21/2026 6:12:20 AM  1006 A new certificate has been installed. Please refer to the "Details" section for more information.
1/21/2026 4:52:46 AM  1006 A new certificate has been installed. Please refer to the "Details" section for more information.
1/21/2026 4:29:28 AM  1006 A new certificate has been installed. Please refer to the "Details" section for more information.

======1h Âæå„ÅÆ„Éù„Éº„É™„É≥„Ç∞„ÅÆ„É≠„Ç∞„ÇíÁ¢∫Ë™ç„Åô„Çã=====

PS C:\Windows\system32> Get-WinEvent -LogName "Microsoft-Windows-CertificateServicesClient-Lifecycle-System/Operational" -MaxEvents 20 |
>>   Select-Object TimeCreated, Id, Message |
>>   Format-Table -Wrap

TimeCreated             Id Message
-----------             -- -------
1/21/2026 1:37:24 PM  1001 A certificate has been replaced. Please refer to the "Details" section for more information.
1/21/2026 1:37:24 PM  1006 A new certificate has been installed. Please refer to the "Details" section for more information.
1/21/2026 12:37:25 PM 1001 A certificate has been replaced. Please refer to the "Details" section for more information.
1/21/2026 12:37:25 PM 1006 A new certificate has been installed. Please refer to the "Details" section for more information.
1/21/2026 12:32:51 PM 1001 A certificate has been replaced. Please refer to the "Details" section for more information.
1/21/2026 12:32:51 PM 1006 A new certificate has been installed. Please refer to the "Details" section for more information.

„Å°„ÇÉ„Çì„Å®Êõ¥Êñ∞„ÅåÂãï„ÅÑ„Å¶„ÅÑ„Çã

0b5922ef8e57b9fd



6127e6e32019279687f7762e0ad08d8ca05c72a3


PS C:\Windows\system32> netsh http show sslcert

SSL Certificate bindings:
-------------------------



    IP:port                      : 0.0.0.0:443
    Certificate Hash             : 6127e6e32019279687f7762e0ad08d8ca05c72a3
    Application ID               : {4dc3e181-e14b-4a21-b022-59fc669b0914}
    Certificate Store Name       : My
    Verify Client Certificate Revocation : Enabled
    Verify Revocation Using Cached Client Certificate Only : Disabled
    Use Revocation Freshness Time : Disabled
    Verify Revocation Using Cached URLs Only : Disabled
    Disable Authority Info Access : Disabled
    Usage Check                  : Enabled
    Revocation Freshness Time    : 0
    URL Retrieval Timeout        : 0
    Ctl Identifier               : (null)
    Ctl Store Name               : (null)
    DS Mapper Usage              : Disabled
    Negotiate Client Certificate : Disabled
    Reject Connections           : Disabled
    Disable HTTP2                : Not Set
    Disable QUIC                 : Not Set
    Disable TLS1.2               : Not Set
    Disable TLS1.3               : Not Set
    Disable OCSP Stapling        : Not Set
    Enable Token Binding         : Not Set
    Log Extended Events          : Not Set
    Disable Legacy TLS Versions  : Not Set
    Enable Session Ticket        : Not Set
    Disable Session ID           : Not Set
    Enable Caching Client Hello  : Not Set
 Extended Property:
    PropertyId                   : 0
    Receive Window               : 1048576
 Extended Property:
    PropertyId                   : 1
    Max Settings Per Frame       : 2796202
    Max Settings Per Minute      : 4294967295
 Extended Property:
    PropertyId                   : 2
    Send Buffering Flags         : 0x0
    Aggressive ICW               : Not Set
    Max Send Buffer Size         : 4294967295
    Max Concurrent Client Streams: 100
    Max Receive Buffer Size      : 0
    Decrypt On SSPI Thread       : Set
 Extended Property:
    PropertyId                   : 3
    TLS Restrictions             : Not Set
 Extended Property:
    PropertyId                   : 4
    Error Headers                : Not Set
    Status Code                  : 0
 Extended Property:
    PropertyId                   : 6
    Cert Config                  : Not Set


„Çµ„Ç§„Éà„Å´„Ç¢„ÇØ„Çª„Çπ„Åó„Å¶„ÄÅË®ºÊòéÊõ∏„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åø„Çã„Å®„ÄÅÊúÄÊñ∞„ÅÆË®ºÊòéÊõ∏„Å´„Å™„Å£„Å¶„ÅÑ„Çã



AKV „ÅÆÊúÄÊñ∞„Éê„Éº„Ç∏„Éß„É≥„ÅÆ„Ç¢„ÇØ„ÉÜ„Ç£„ÉñÊó•ÊôÇ„Å®‰∏ÄËá¥


„Åì„Çì„Å™ÊÑü„Åò„Åß„É≠„Ç∞Âèñ„Çå„Çã
Get-ChildItem "C:\WindowsAzure\Logs\Plugins\Microsoft.Azure.KeyVault.KeyVaultForWindows\3.6.3145.208\akvvm*.log" -ErrorAction SilentlyContinue | Get-Content -Tail 10



Êó¢Â≠ò„ÅÆË®ºÊòéÊõ∏„ÅÆÂâäÈô§„Åæ„Åß„ÅØ„ÇÑ„Å£„Å¶„Åè„Çå„Å™„ÅÑ„Çà„ÅÜ„Å™„ÅÆ„Åß„ÄÅÂà•ÈÄîË™øÊï¥„ÅåÂøÖË¶Å


„Çà„ÇäÂÆâÂÖ®„Å´Ë°å„ÅÜ„Å´„ÅØ„ÄÅAKV „Å´ÂØæ„Åô„Çã Private Endpoint „ÇíÊßãÊàê„Åó„Åæ„Åô

